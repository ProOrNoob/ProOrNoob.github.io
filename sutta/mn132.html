<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MN 131 â€“ Bhaddekaratta Sutta</title>

  <link href="https://dhammaarchive.info/css/bs.css" rel="stylesheet">

<link rel="stylesheet" href="https://dhammaarchive.info/css/style.css">
</head>
<body>
  <div class="page-wrapper">
    <div class="sutra-card">
      <!-- HEADER TRONG TRANG KINH -->
      <div class="sutra-header">
        <div>
          <h1 id="sutraTitleLocal" class="sutra-title">
            MN 131 â€“ BHADDEKARATTA SUTTA
          </h1>
          <div id="sutraSubtitle" class="text-muted small">
            Kinh Nháº¥t Dáº¡ Hiá»n Giáº£
          </div>
        </div>

        <!-- KHá»I ACTION BÃŠN PHáº¢I: TOOLBAR + NÃšT SETTINGS -->
        <!-- LÆ¯U Ã: controls Ä‘áº·t TRÆ¯á»šC, settings Ä‘áº·t SAU Ä‘á»ƒ khi má»Ÿ nÃ³ dÃ n ra bÃªn trÃ¡i nÃºt âš™ -->
        <div class="header-actions">
          <!-- TOOLBAR (áº©n/hiá»‡n khi báº¥m settings) -->
          <div id="sutraControls" class="controls" aria-label="Languages and view">
            <!-- BÃŠN TRÃI -->
            <div class="controls-left">
              <div class="btn-group btn-group-sm" role="group" aria-label="Languages">
                <button type="button" class="btn btn-outline-secondary active" id="btnPali">PLI</button>
                <button type="button" class="btn btn-outline-secondary active" id="btnEng">EN</button>
                <button type="button" class="btn btn-outline-secondary active" id="btnVie">VI</button>
              </div>

              <button id="btnLayout" class="btn btn-outline-secondary btn-sm" type="button" title="Äá»•i kiá»ƒu hiá»ƒn thá»‹">
                <svg id="layoutIcon" class="layout-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <line x1="4" y1="6"  x2="20" y2="6"  />
                  <line x1="4" y1="12" x2="20" y2="12" />
                  <line x1="4" y1="18" x2="20" y2="18" />
                </svg>
              </button>

              <button id="btnColor" class="btn btn-outline-secondary btn-sm" type="button" title="MÃ u sáº¯c cá»™t">
                ğŸ¨
              </button>
            </div>

            <!-- BÃŠN PHáº¢I: voice controls (áº©n hiá»‡n tÃ¹y browser) -->
            <div class="controls-right" id="voiceControls">
              <!-- NhÃ³m nÃºt Ä‘á»c Tiáº¿ng Viá»‡t -->
              <div class="btn-group btn-group-sm" role="group" aria-label="Read Vietnamese">
                <button type="button" class="btn btn-outline-secondary" id="btnReadVie">ğŸ”Š VI</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnPauseVie">â¸</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnRestartVie">â®</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnStopVie">â¹</button>
              </div>

              <!-- NhÃ³m nÃºt Ä‘á»c English -->
              <div class="btn-group btn-group-sm" role="group" aria-label="Read English">
                <button type="button" class="btn btn-outline-secondary" id="btnReadEng">ğŸ”Š EN</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnPauseEng">â¸</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnRestartEng">â®</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnStopEng">â¹</button>
              </div>
            </div>
          </div>

          <!-- NÃºt SETTINGS -->
          <button id="btnSettings"
                  class="btn btn-outline-secondary btn-sm settings-btn"
                  type="button"
                  aria-expanded="false"
                  aria-controls="sutraControls"
                  title="CÃ i Ä‘áº·t hiá»ƒn thá»‹">
            âš™
          </button>
        </div>
      </div>

      <!-- Ná»˜I DUNG KINH -->
      <div id="sutraGrid" class="sutra-grid">
        <!-- Row 1 -->
        <div class="sutra-row" data-idx="1">
          <div class="sutra-col pali-col">
            <div class="col-head">PÄli</div>
            <div class="pali">
              Evaá¹ me sutaá¹: Ekaá¹ samayaá¹ bhagavÄ sÄvatthiyaá¹ vihÄrati jetavane anÄthapiá¹‡á¸ikassa ÄrÄme.
            </div>
          </div>
          <div class="sutra-col eng-col">
            <div class="col-head">English</div>
            <div class="eng">
              Thus have I heard: At one time the Blessed One was dwelling at SÄvatthÄ«, in Jeta's Grove, AnÄthapiá¹‡á¸ika's Park.
            </div>
          </div>
          <div class="sutra-col vie-col">
            <div class="col-head">Tiáº¿ng Viá»‡t</div>
            <div class="vie">
              Nghe nhÆ° váº§y: CÃ³ má»™t thá»i, Tháº¿ TÃ´n trÃº táº¡i XÃ¡-vá»‡, trong rá»«ng Ká»³-Ä‘Ã , táº¡i khu vÆ°á»n cá»§a AnÄthapiá¹‡á¸ika.
            </div>
          </div>
        </div>

        <!-- Row 2 -->
        <div class="sutra-row" data-idx="2">
          <div class="sutra-col pali-col">
            <div class="pali">
              Tatra kho bhagavÄ bhikkhÅ« Ämantesi: â€œBhikkhavoâ€ti. â€œBhaddanteâ€ti te bhikkhÅ« bhagavato paccassosuá¹.
            </div>
          </div>
          <div class="sutra-col eng-col">
            <div class="eng">
              There the Blessed One addressed the bhikkhus: â€œBhikkhus!â€ â€œVenerable sir,â€ the bhikkhus replied to the Blessed One.
            </div>
          </div>
          <div class="sutra-col vie-col">
            <div class="vie">
              á» Ä‘Ã³ Tháº¿ TÃ´n nÃ³i vá»›i cÃ¡c tá»³-kheo: â€œNÃ y cÃ¡c tá»³-kheo.â€ â€œBáº¡ch trÆ°á»Ÿng lÃ£o,â€ cÃ¡c tá»³-kheo tráº£ lá»i Äá»©c Pháº­t.
            </div>
          </div>
        </div>

        <!-- Row 3 -->
        <div class="sutra-row" data-idx="3">
          <div class="sutra-col pali-col">
            <div class="pali">
              AtÄ«taá¹ nÄnvÄgameyya, nappaá¹­ikaá¹…khe anÄgataá¹; yadatÄ«taá¹ pahÄ«naá¹ taá¹, appattaÃ±ca anÄgataá¹.
            </div>
          </div>
          <div class="sutra-col eng-col">
            <div class="eng">
              Let the past not be clung to; the future not expected; whatever is past has been left behind, and the future is not yet come.
            </div>
          </div>
          <div class="sutra-col vie-col">
            <div class="vie">
              Äá»«ng bÃ¡m vÃ­u vÃ o quÃ¡ khá»©, Ä‘á»«ng mong chá» tÆ°Æ¡ng lai; Ä‘iá»u Ä‘Ã£ qua Ä‘Ã£ bá», Ä‘iá»u tÆ°Æ¡ng lai chÆ°a Ä‘áº¿n.
            </div>
          </div>
        </div>

        <div class="sutra-row" data-idx="4">
          <div class="sutra-col pali-col">
            <div class="pali">
              AtÄ«taá¹ nÄnvÄgameyya, nappaá¹­ikaá¹…khe anÄgataá¹; yadatÄ«taá¹ pahÄ«naá¹ taá¹, appattaÃ±ca anÄgataá¹.
            </div>
          </div>
          <div class="sutra-col eng-col">
            <div class="eng">
              Let the past not be clung to; the future not expected; whatever is past has been left behind, and the future is not yet come.
            </div>
          </div>
          <div class="sutra-col vie-col">
            <div class="vie">
              Äá»«ng bÃ¡m vÃ­u vÃ o quÃ¡ khá»©, Ä‘á»«ng mong chá» tÆ°Æ¡ng lai; Ä‘iá»u Ä‘Ã£ qua Ä‘Ã£ bá», Ä‘iá»u tÆ°Æ¡ng lai chÆ°a Ä‘áº¿n.
            </div>
          </div>
        </div>

        <div class="sutra-row" data-idx="5">
          <div class="sutra-col pali-col">
            <div class="pali">
              AtÄ«taá¹ nÄnvÄgameyya, nappaá¹­ikaá¹…khe anÄgataá¹; yadatÄ«taá¹ pahÄ«naá¹ taá¹, appattaÃ±ca anÄgataá¹.
            </div>
          </div>
          <div class="sutra-col eng-col">
            <div class="eng">
              Let the past not be clung to; the future not expected; whatever is past has been left behind, and the future is not yet come.
            </div>
          </div>
          <div class="sutra-col vie-col">
            <div class="vie">
              Äá»«ng bÃ¡m vÃ­u vÃ o quÃ¡ khá»©, Ä‘á»«ng mong chá» tÆ°Æ¡ng lai; Ä‘iá»u Ä‘Ã£ qua Ä‘Ã£ bá», Ä‘iá»u tÆ°Æ¡ng lai chÆ°a Ä‘áº¿n.
            </div>
          </div>
        </div>

        <!-- Row 6 -->
        <div class="sutra-row" data-idx="6">
          <div class="sutra-col pali-col">
            <div class="pali">
              Idamavoca bhagavÄ. AttamanÄ te bhikkhÅ« bhagavato bhÄsitaá¹ abhinandunti. Bhaddekarattasuttaá¹ niá¹­á¹­hitaá¹.
            </div>
          </div>
          <div class="sutra-col eng-col">
            <div class="eng">
              Thus the Blessed One spoke. The bhikkhus were glad and praised what had been said by the Blessed One. The Bhaddekaratta Sutta is concluded.
            </div>
          </div>
          <div class="sutra-col vie-col">
            <div class="vie">
              Äá»©c Pháº­t thuyáº¿t xong. CÃ¡c tá»³-kheo hoan há»· vÃ  tÃ¡n thÃ¡n lá»i Pháº­t dáº¡y. Kinh Bhaddekaratta káº¿t thÃºc.
            </div>
          </div>
        </div>
      </div>

      <!-- BACK TO TOP BUTTON -->
      <button id="backToTop" title="LÃªn Ä‘áº§u trang" aria-label="LÃªn Ä‘áº§u trang" aria-hidden="true">
        â†‘
      </button>
    </div>
  </div>

  <!-- COLOR OVERLAY -->
  <div id="colorOverlay" class="overlay" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="colorTitle">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 id="colorTitle" class="mb-0">ğŸ¨ </h2>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="tablist">
            <button type="button" class="btn btn-outline-secondary tab-btn active" id="tabPali">
              PÄli
            </button>
            <button type="button" class="btn btn-outline-secondary tab-btn" id="tabEng">
              English
            </button>
            <button type="button" class="btn btn-outline-secondary tab-btn" id="tabVie">
              Vietnamese
            </button>
          </div>
          <button type="button" class="dialog-close" id="colorClose">Ã—</button>
        </div>
      </div>

      <!-- PÄli -->
      <div id="colorContentPali">
        <p class="mb-2">Chá»‰nh mÃ u cho cá»™t PÄli.</p>
        <p class="mb-2">Color settings for the Pali column.</p>
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <span>MÃ u chá»¯ / Text color :</span>
          <input id="paliColor" type="color" title="MÃ u chá»¯ PÄli" value="#0f172a">
        </div>
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <span>MÃ u ná»n / Background:</span>
          <input id="paliBg" type="color" title="MÃ u ná»n PÄli" value="#ffffff">
        </div>
        <div class="text-end mt-2">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="resetPali">Reset / Äáº·t láº¡i</button>
        </div>
      </div>

      <!-- English -->
      <div id="colorContentEng" class="d-none">
        <p class="mb-2">Chá»‰nh mÃ u cho cá»™t English.</p>
        <p class="mb-2">Color settings for the English column.</p>
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <span>MÃ u chá»¯ / Text color :</span>
          <input id="engColor" type="color" title="English text color" value="#0f172a">
        </div>
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <span>MÃ u ná»n / Background:</span>
          <input id="engBg" type="color" title="English background color" value="#ffffff">
        </div>
        <div class="text-end mt-2">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="resetEng">Reset / Äáº·t láº¡i</button>
        </div>
      </div>

      <!-- Vietnamese -->
      <div id="colorContentVie" class="d-none">
        <p class="mb-2">Chá»‰nh mÃ u cho cá»™t Tiáº¿ng Viá»‡t.</p>
        <p class="mb-2">Color settings for the Vietnamese column.</p>
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <span>MÃ u chá»¯ / Text color :</span>
          <input id="vieColor" type="color" title="MÃ u chá»¯ Tiáº¿ng Viá»‡t" value="#0f172a">
        </div>
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <span>MÃ u ná»n / Background:</span>
          <input id="vieBg" type="color" title="MÃ u ná»n Tiáº¿ng Viá»‡t" value="#ffffff">
        </div>
        <div class="text-end mt-2">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="resetVie">Reset / Äáº·t láº¡i</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      const grid        = document.getElementById('sutraGrid');
      const card        = document.querySelector('.sutra-card');

      const btnSettings   = document.getElementById('btnSettings');
      const sutraControls = document.getElementById('sutraControls');

      const btnPali     = document.getElementById('btnPali');
      const btnEng      = document.getElementById('btnEng');
      const btnVie      = document.getElementById('btnVie');
      const btnLayout   = document.getElementById('btnLayout');
      const btnColor    = document.getElementById('btnColor');
      const layoutIcon  = document.getElementById('layoutIcon');

      const paliCols    = document.querySelectorAll('.pali-col');
      const engCols     = document.querySelectorAll('.eng-col');
      const vieCols     = document.querySelectorAll('.vie-col');

      const colorOverlay    = document.getElementById('colorOverlay');
      const colorClose      = document.getElementById('colorClose');
      const tabPali         = document.getElementById('tabPali');
      const tabEng          = document.getElementById('tabEng');
      const tabVie          = document.getElementById('tabVie');
      const colorContentPali = document.getElementById('colorContentPali');
      const colorContentEng  = document.getElementById('colorContentEng');
      const colorContentVie  = document.getElementById('colorContentVie');

      const paliBgInput     = document.getElementById('paliBg');
      const paliColorInput  = document.getElementById('paliColor');
      const engBgInput      = document.getElementById('engBg');
      const engColorInput   = document.getElementById('engColor');
      const vieBgInput      = document.getElementById('vieBg');
      const vieColorInput   = document.getElementById('vieColor');

      const resetPaliBtn    = document.getElementById('resetPali');
      const resetEngBtn     = document.getElementById('resetEng');
      const resetVieBtn     = document.getElementById('resetVie');

      const subTitle        = document.getElementById('sutraSubtitle');
      const backToTopBtn    = document.getElementById('backToTop');

      // Voice controls container
      const voiceControls   = document.getElementById('voiceControls');

      // NÃºt Ä‘á»c VI / EN
      const btnReadVie      = document.getElementById('btnReadVie');
      const btnPauseVie     = document.getElementById('btnPauseVie');
      const btnRestartVie   = document.getElementById('btnRestartVie');
      const btnStopVie      = document.getElementById('btnStopVie');

      const btnReadEng      = document.getElementById('btnReadEng');
      const btnPauseEng     = document.getElementById('btnPauseEng');
      const btnRestartEng   = document.getElementById('btnRestartEng');
      const btnStopEng      = document.getElementById('btnStopEng');

      const sutraRows       = Array.from(grid.querySelectorAll('.sutra-row'));

      let showPali = true;
      let showEng  = true;
      let showVie  = true;

      const defaultColors = {
        paliBg: '#ffffff',
        paliColor: '#0f172a',
        engBg: '#ffffff',
        engColor: '#0f172a',
        vieBg: '#ffffff',
        vieColor: '#0f172a'
      };

      /* ==== Detect browser: chá»‰ báº­t voice cho Edge & Safari ==== */
      const ua = navigator.userAgent || '';
      const isEdge   = ua.includes('Edg/') || ua.includes('Edge/');
      const isSafari = ua.includes('Safari') &&
                       !ua.includes('Chrome') &&
                       !ua.includes('Chromium') &&
                       !ua.includes('Edg');

      const enableVoice = isEdge || isSafari;

      if(!enableVoice && voiceControls){
        voiceControls.style.display = 'none';
      }

      /* ======================= SETTINGS TOOLBAR TOGGLE ======================= */
      if (btnSettings && sutraControls) {
        btnSettings.addEventListener('click', function (e) {
          e.stopPropagation();
          const isOpen = sutraControls.classList.toggle('open');
          btnSettings.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        // Click ngoÃ i thÃ¬ Ä‘Ã³ng
        document.addEventListener('click', function (e) {
          if (!sutraControls.classList.contains('open')) return;
          const inside = sutraControls.contains(e.target) || btnSettings.contains(e.target);
          if (!inside) {
            sutraControls.classList.remove('open');
            btnSettings.setAttribute('aria-expanded','false');
          }
        });
      }

      /* ======================= SUBTITLE ======================= */
      function updateSubtitleByLang(){
        if(showEng && showVie){
          subTitle.innerHTML =
            'The Discourse on a Single Excellent Night<br>' +
            'Kinh Nháº¥t Dáº¡ Hiá»n Giáº£';
        }else if(showEng){
          subTitle.textContent = 'The Discourse on a Single Excellent Night';
        }else if(showVie){
          subTitle.textContent = 'Kinh Nháº¥t Dáº¡ Hiá»n Giáº£';
        }else{
          subTitle.textContent = '';
        }
      }

      /* ======================= LAYOUT & VISIBILITY ======================= */
      function adjustRowColumns(){
        const rows = grid.querySelectorAll('.sutra-row');
        rows.forEach(row=>{
          if(card.classList.contains('stack')){
            row.style.gridTemplateColumns = '1fr';
            return;
          }
          const cols = Array.from(row.querySelectorAll('.sutra-col'));
          const visible = cols.filter(col=>{
            if(col.classList.contains('pali-col') && !showPali) return false;
            if(col.classList.contains('eng-col')  && !showEng)  return false;
            if(col.classList.contains('vie-col')  && !showVie)  return false;
            return true;
          });
          const n = Math.max(1, visible.length);
          row.style.gridTemplateColumns = `repeat(${n},1fr)`;
        });
      }

      function updateVisibility(){
        grid.classList.toggle('hide-pali', !showPali);
        grid.classList.toggle('hide-eng',  !showEng);
        grid.classList.toggle('hide-vie',  !showVie);
        adjustRowColumns();
      }

      btnPali.addEventListener('click',()=>{
        showPali = !showPali;
        btnPali.classList.toggle('active', showPali);
        updateVisibility();
        updateSubtitleByLang();
      });

      btnEng.addEventListener('click',()=>{
        showEng = !showEng;
        btnEng.classList.toggle('active', showEng);
        updateVisibility();
        updateSubtitleByLang();
      });

      btnVie.addEventListener('click',()=>{
        showVie = !showVie;
        btnVie.classList.toggle('active', showVie);
        updateVisibility();
        updateSubtitleByLang();
      });

      btnLayout.addEventListener('click',()=>{
        card.classList.toggle('stack');
        const isStack = card.classList.contains('stack');
        layoutIcon.classList.toggle('vertical', isStack);
        adjustRowColumns();
      });

      /* ======================= OVERLAY COLOR ======================= */
      function setColorTab(lang){
        const isPali = lang === 'pali';
        const isEng  = lang === 'eng';
        const isVie  = lang === 'vie';

        tabPali.classList.toggle('active', isPali);
        tabEng.classList.toggle('active',  isEng);
        tabVie.classList.toggle('active',  isVie);

        colorContentPali.classList.toggle('d-none', !isPali);
        colorContentEng.classList.toggle('d-none',  !isEng);
        colorContentVie.classList.toggle('d-none',  !isVie);
      }

      function openColor(){
        colorOverlay.classList.add('show');
        colorOverlay.setAttribute('aria-hidden','false');
      }
      function closeColor(){
        colorOverlay.classList.remove('show');
        colorOverlay.setAttribute('aria-hidden','true');
      }

      btnColor.addEventListener('click',(e)=>{
        e.stopPropagation();
        openColor();
      });
      colorClose.addEventListener('click',(e)=>{
        e.stopPropagation();
        closeColor();
      });
      colorOverlay.addEventListener('click',(e)=>{
        if(e.target===colorOverlay) closeColor();
      });

      tabPali.addEventListener('click',(e)=>{ e.stopPropagation(); setColorTab('pali'); });
      tabEng.addEventListener('click',(e)=>{ e.stopPropagation(); setColorTab('eng'); });
      tabVie.addEventListener('click',(e)=>{ e.stopPropagation(); setColorTab('vie'); });

      /* ======================= LOAD / SAVE MÃ€U ======================= */
      function loadColors(){
        let saved = {};
        try{
          saved = JSON.parse(localStorage.getItem('bh_colors') || '{}');
        }catch(e){
          saved = {};
        }

        const colors = {
          paliBg:   saved.paliBg   || defaultColors.paliBg,
          paliColor:saved.paliColor|| defaultColors.paliColor,
          engBg:    saved.engBg    || defaultColors.engBg,
          engColor: saved.engColor || defaultColors.engColor,
          vieBg:    saved.vieBg    || defaultColors.vieBg,
          vieColor: saved.vieColor || defaultColors.vieColor
        };

        paliBgInput.value    = colors.paliBg;
        paliColorInput.value = colors.paliColor;
        engBgInput.value     = colors.engBg;
        engColorInput.value  = colors.engColor;
        vieBgInput.value     = colors.vieBg;
        vieColorInput.value  = colors.vieColor;

        paliCols.forEach(c=>{
          c.style.background = colors.paliBg;
          c.style.color      = colors.paliColor;
        });
        engCols.forEach(c=>{
          c.style.background = colors.engBg;
          c.style.color      = colors.engColor;
        });
        vieCols.forEach(c=>{
          c.style.background = colors.vieBg;
          c.style.color      = colors.vieColor;
        });
      }

      function saveColors(){
        const obj = {
          paliBg:   paliBgInput.value   || defaultColors.paliBg,
          paliColor:paliColorInput.value|| defaultColors.paliColor,
          engBg:    engBgInput.value    || defaultColors.engBg,
          engColor: engColorInput.value || defaultColors.engColor,
          vieBg:    vieBgInput.value    || defaultColors.vieBg,
          vieColor: vieColorInput.value || defaultColors.vieColor
        };
        try{
          localStorage.setItem('bh_colors', JSON.stringify(obj));
        }catch(e){}
      }

      function setupColorControls(cols, bgInput, colorInput, resetBtn, defaults){
        bgInput.addEventListener('input', e=>{
          const value = e.target.value;
          cols.forEach(c=>{ c.style.background = value; });
          saveColors();
        });

        colorInput.addEventListener('input', e=>{
          const value = e.target.value;
          cols.forEach(c=>{ c.style.color = value; });
          saveColors();
        });

        resetBtn.addEventListener('click',()=>{
          cols.forEach(c=>{
            c.style.background = defaults.bg;
            c.style.color      = defaults.color;
          });
          bgInput.value    = defaults.bg;
          colorInput.value = defaults.color;
          saveColors();
        });
      }

      setupColorControls(
        paliCols,
        paliBgInput,
        paliColorInput,
        resetPaliBtn,
        {bg: defaultColors.paliBg, color: defaultColors.paliColor}
      );
      setupColorControls(
        engCols,
        engBgInput,
        engColorInput,
        resetEngBtn,
        {bg: defaultColors.engBg, color: defaultColors.engColor}
      );
      setupColorControls(
        vieCols,
        vieBgInput,
        vieColorInput,
        resetVieBtn,
        {bg: defaultColors.vieBg, color: defaultColors.vieColor}
      );

      /* ======================= BACK TO TOP ======================= */
      function setBackToTopVisible(visible){
        backToTopBtn.classList.toggle('show', visible);
        backToTopBtn.setAttribute('aria-hidden', visible ? 'false' : 'true');
      }

      grid.addEventListener('scroll', ()=>{
        setBackToTopVisible(grid.scrollTop > 0);
      }, { passive:true });

      backToTopBtn.addEventListener('click', ()=>{
        grid.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });

      /* ======================= Äá»ŒC SUTRA (TTS) â€“ VI & EN ======================= */

      const synthSupported = enableVoice && ('speechSynthesis' in window);
      const synth = synthSupported ? window.speechSynthesis : null;

      let voices = [];

      function refreshVoices(){
        if(!synthSupported) return;
        voices = synth.getVoices() || [];
      }

      if(synthSupported){
        refreshVoices();
        if(typeof synth.onvoiceschanged !== 'undefined'){
          synth.onvoiceschanged = refreshVoices;
        }
      }

      function pickMaleVoice(langPrefix){
        if(!voices || !voices.length) return null;

        const langVoices = voices.filter(v =>
          v.lang && v.lang.toLowerCase().startsWith(langPrefix.toLowerCase())
        );
        if(!langVoices.length) return null;

        const maleHints = [
          'male','man','nam',
          'minh','quang','anh','dÅ©ng','thÃ nh',
          'david','john','michael','mark','alex','daniel','james'
        ];

        const maleVoice = langVoices.find(v =>
          maleHints.some(h => v.name.toLowerCase().includes(h))
        );

        return maleVoice || langVoices[0];
      }

      const readerState = {
        vie: { currentIndex: 0, isReading: false, isPaused: false },
        eng: { currentIndex: 0, isReading: false, isPaused: false }
      };

      let currentLang = null;     // 'vie' | 'eng' | null
      let currentUtterance = null;

      function saveReadState(){
        const data = {
          vie: { currentIndex: readerState.vie.currentIndex },
          eng: { currentIndex: readerState.eng.currentIndex }
        };
        try{
          localStorage.setItem('bh_readState', JSON.stringify(data));
        }catch(e){}
      }

      function loadReadState(){
        try{
          const raw = localStorage.getItem('bh_readState');
          if(!raw) return;
          const data = JSON.parse(raw);
          if(data.vie && Number.isInteger(data.vie.currentIndex)){
            readerState.vie.currentIndex = Math.min(
              Math.max(0, data.vie.currentIndex),
              Math.max(0, sutraRows.length - 1)
            );
          }
          if(data.eng && Number.isInteger(data.eng.currentIndex)){
            readerState.eng.currentIndex = Math.min(
              Math.max(0, data.eng.currentIndex),
              Math.max(0, sutraRows.length - 1)
            );
          }
        }catch(e){}
      }

      function clearHighlight(){
        sutraRows.forEach(r => r.classList.remove('reading'));
      }

      function setHighlightRow(row){
        clearHighlight();
        if(row){
          row.classList.add('reading');
          const top = row.offsetTop;
          const bottom = top + row.offsetHeight;
          const viewTop = grid.scrollTop;
          const viewBottom = viewTop + grid.clientHeight;

          if(top < viewTop || bottom > viewBottom){
            grid.scrollTo({ top: top - 20, behavior: 'smooth' });
          }
        }
      }

      function updateButtonsForLang(lang, mode){
        // mode: 'idle' | 'playing' | 'paused'
        if(lang === 'vie'){
          if(mode === 'idle'){
            btnReadVie.classList.remove('d-none');
            btnPauseVie.classList.add('d-none');
            btnRestartVie.classList.add('d-none');
            btnStopVie.classList.add('d-none');
            btnReadVie.textContent = 'ğŸ”Š VI';
          }else if(mode === 'playing'){
            btnReadVie.classList.add('d-none');
            btnPauseVie.classList.remove('d-none');
            btnRestartVie.classList.remove('d-none');
            btnStopVie.classList.remove('d-none');
          }else if(mode === 'paused'){
            btnReadVie.classList.remove('d-none');
            btnPauseVie.classList.add('d-none');
            btnRestartVie.classList.remove('d-none');
            btnStopVie.classList.remove('d-none');
            btnReadVie.textContent = 'â–¶ VI';
          }
        }else if(lang === 'eng'){
          if(mode === 'idle'){
            btnReadEng.classList.remove('d-none');
            btnPauseEng.classList.add('d-none');
            btnRestartEng.classList.add('d-none');
            btnStopEng.classList.add('d-none');
            btnReadEng.textContent = 'ğŸ”Š EN';
          }else if(mode === 'playing'){
            btnReadEng.classList.add('d-none');
            btnPauseEng.classList.remove('d-none');
            btnRestartEng.classList.remove('d-none');
            btnStopEng.classList.remove('d-none');
          }else if(mode === 'paused'){
            btnReadEng.classList.remove('d-none');
            btnPauseEng.classList.add('d-none');
            btnRestartEng.classList.remove('d-none');
            btnStopEng.classList.remove('d-none');
            btnReadEng.textContent = 'â–¶ EN';
          }
        }
      }

      function stopReading(lang){
        if(synthSupported){
          synth.cancel();
        }
        const st = readerState[lang];
        st.isReading = false;
        st.isPaused = false;
        currentUtterance = null;
        currentLang = null;
        updateButtonsForLang(lang,'idle');
        clearHighlight();
        saveReadState();
      }

      function stopAllSpeech(){
        if(synthSupported){
          synth.cancel();
        }
        currentUtterance = null;
        currentLang = null;
        readerState.vie.isReading = false;
        readerState.vie.isPaused  = false;
        readerState.eng.isReading = false;
        readerState.eng.isPaused  = false;
        updateButtonsForLang('vie','idle');
        updateButtonsForLang('eng','idle');
        clearHighlight();
      }

      function speakNextRow(lang){
        if(!synthSupported) return;

        const st = readerState[lang];
        if(!st.isReading || st.isPaused){
          return;
        }

        if(st.currentIndex >= sutraRows.length){
          st.isReading = false;
          st.isPaused  = false;
          updateButtonsForLang(lang,'idle');
          clearHighlight();
          saveReadState();
          return;
        }

        const row = sutraRows[st.currentIndex];
        let text = '';

        if(lang === 'vie'){
          const el = row.querySelector('.vie-col .vie');
          text = el ? el.innerText.trim() : '';
        }else if(lang === 'eng'){
          const el = row.querySelector('.eng-col .eng');
          text = el ? el.innerText.trim() : '';
        }

        if(!text){
          st.currentIndex++;
          saveReadState();
          speakNextRow(lang);
          return;
        }

        setHighlightRow(row);

        const utter = new SpeechSynthesisUtterance(text);

        if(lang === 'eng'){
          utter.lang = 'en-US';
          const v = pickMaleVoice('en');
          if(v) utter.voice = v;
        }else if(lang === 'vie'){
          utter.lang = 'vi-VN';
          const v = pickMaleVoice('vi');
          if(v) utter.voice = v;
          utter.pitch = 0.8;
          utter.rate  = 0.98;
        }

        currentUtterance = utter;
        currentLang = lang;

        utter.onend = function(){
          if(!st.isPaused && st.isReading){
            st.currentIndex++;
            saveReadState();
            speakNextRow(lang);
          }
        };

        utter.onerror = function(){
          st.isReading = false;
          st.isPaused  = false;
          updateButtonsForLang(lang,'idle');
        };

        synth.speak(utter);
      }

      function startReading(lang){
        if(!synthSupported){
          alert('TrÃ¬nh duyá»‡t hiá»‡n táº¡i khÃ´ng há»— trá»£ Ä‘á»c giá»ng nÃ³i hoáº·c chá»©c nÄƒng Ä‘Ã£ táº¯t.');
          return;
        }

        if(currentLang && currentLang !== lang){
          stopAllSpeech();
        }else{
          if(readerState[lang].isReading && !readerState[lang].isPaused){
            return;
          }
        }

        const st = readerState[lang];
        st.isReading = true;
        st.isPaused  = false;

        updateButtonsForLang(lang,'playing');
        speakNextRow(lang);
      }

      function pauseReading(lang){
        if(!synthSupported) return;
        const st = readerState[lang];
        if(!st.isReading || st.isPaused) return;

        synth.pause();
        st.isPaused = true;
        st.isReading = false;
        updateButtonsForLang(lang,'paused');
        saveReadState();
      }

      function resumeReading(lang){
        if(!synthSupported) return;
        const st = readerState[lang];
        if(st.isPaused){
          synth.resume();
          st.isPaused = false;
          st.isReading = true;
          updateButtonsForLang(lang,'playing');
        }else{
          startReading(lang);
        }
      }

      function restartFromBeginning(lang){
        const st = readerState[lang];
        st.currentIndex = 0;
        st.isPaused = false;
        st.isReading = false;
        saveReadState();
        clearHighlight();
        if(synthSupported){
          synth.cancel();
        }
        startReading(lang);
      }

      /* GÃ¡n event chá»‰ khi enableVoice Ä‘á»ƒ trÃ¡nh thá»«a */
      if(enableVoice){
        // Vietnamese
        btnReadVie.addEventListener('click', ()=>{
          if(readerState.vie.isPaused){
            resumeReading('vie');
          }else{
            startReading('vie');
          }
        });

        btnPauseVie.addEventListener('click', ()=>{
          pauseReading('vie');
        });

        btnRestartVie.addEventListener('click', ()=>{
          restartFromBeginning('vie');
        });

        btnStopVie.addEventListener('click', ()=>{
          stopReading('vie');
        });

        // English
        btnReadEng.addEventListener('click', ()=>{
          if(readerState.eng.isPaused){
            resumeReading('eng');
          }else{
            startReading('eng');
          }
        });

        btnPauseEng.addEventListener('click', ()=>{
          pauseReading('eng');
        });

        btnRestartEng.addEventListener('click', ()=>{
          restartFromBeginning('eng');
        });

        btnStopEng.addEventListener('click', ()=>{
          stopReading('eng');
        });
      }

      /* ======================= INIT ======================= */
      function init(){
        setColorTab('pali');
        loadColors();
        loadReadState();
        updateVisibility();
        updateSubtitleByLang();
        layoutIcon.classList.remove('vertical');
        setBackToTopVisible(false);

        if(enableVoice){
          updateButtonsForLang('vie','idle');
          updateButtonsForLang('eng','idle');
        }
      }

      init();
    })();
  </script>
</body>
</html>
