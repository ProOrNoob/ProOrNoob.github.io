<!DOCTYPE html>
<html lang="vi" data-theme="light" data-ui-lang="vi" class="layout-card">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sutta Reader ‚Äî Bilara JS Static Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style"
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap">
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap">
<script>
(function () {
  try {
    const KEY_THEME  = 'sutta-reader-theme';
    const KEY_LAYOUT = 'sutta-reader-layout';

    const t = localStorage.getItem(KEY_THEME);
    if (t === 'dark' || t === 'light') {
      document.documentElement.dataset.theme = t;
    }

    const l = localStorage.getItem(KEY_LAYOUT);
    if (l === 'layout-wide' || l === 'layout-card') {
      document.documentElement.classList.remove('layout-card', 'layout-wide');
      document.documentElement.classList.add(l);
    }
  } catch (e) {}
})();
</script>
<style>

:root {
   --paper: #FBF7F0;
  --paper-edge: #D9CBB4;
 --gold: #B98B37;
  --gold-light: #D7B061;
  --bg:  #F7F3ED;
  --bg2: #F2ECE3;
  --bg3: #E9DECF;
  --surface:  #FBF7F0;
  --surface2: #F3EDE4;

  --border:  rgba(94,79,60,0.22);
  --border2: rgba(94,79,60,0.32);
  --text:  #2F2418;
  --text2: rgba(47,36,24,0.72);
  --text3: rgba(47,36,24,0.50);

--accent: #6E3A17;

  --shadow:  0 8px 28px rgba(44,31,14,0.08);
  --shadow2: 0 2px 10px rgba(44,31,14,0.05);
 --pali-color: #6A441E;
  --en-color:   #255E46;
  --vi-color:   #5E3A8F;
  --ribbon-text: #FFF8E7;
  --radius: 6px;
  --sidebar-w: 340px;
  --transition: 0.3s ease;
  --panel-bg: #faf7f2;
  --panel-border: #D8CBB8;
  --chip-bg: #f0e8db;
  --chip-hover: #e8dcc8;
  --fab-bg: rgba(122, 62, 18, 0.12);
  --fab-color: rgba(122, 62, 18, 0.75);
  --fab-border: rgba(122, 62, 18, 0.22);
  --fab-bg-hover: rgba(122, 62, 18, 0.18);
  --fab-border-hover: rgba(122, 62, 18, 0.32);
  --fab-sm-bg: rgba(122, 62, 18, 0.10);
  --fab-sm-color: rgba(210, 160, 114, 0.70);
  --fab-sm-border: rgba(122, 62, 18, 0.20);
  --accent-chip-bg: rgba(122, 62, 18, 0.12);
  --accent-chip-border: rgba(122, 62, 18, 0.38);
  --accent-chip-color: rgba(122, 62, 18, 0.82);
  --accent-chip-bg-hover: rgba(122, 62, 18, 0.18);
  --accent-tool-bg: rgba(122, 62, 18, 0.10);
  --accent-tool-border: rgba(122, 62, 18, 0.30);
  --accent-tool-color: rgba(122, 62, 18, 0.80);
  --accent-tool-bg-hover: rgba(122, 62, 18, 0.18);
  --fw-active-bg: rgba(122, 62, 18, 0.15);
  --fw-active-border: rgba(122, 62, 18, 0.45);
  --fw-active-color: rgba(122, 62, 18, 0.90);
  --reset-hover-bg: rgba(122, 62, 18, 0.08);
  --slider-thumb-border: #c5a07a;
  --panel-toggle-bg: #f5f0e8;
  --panel-toggle-hover-bg: #ede5d8;
  --guide-bg: #fffcf5;

  /* Sidebar menu theme vars */
  --menu-block-border: #e5e7eb;
  --menu-toggle-color: var(--text2);
  --menu-toggle-bg: var(--surface);
  --menu-nested-color: var(--text2);
  --menu-nested-border: rgba(216,203,184,0.35);
  --menu-link-color: var(--text);
  --menu-link-hover-bg: var(--bg2);
  --menu-link-active-bg: var(--accent);
  --menu-link-active-color: var(--ribbon-text);
  --menu-link-active-sub: rgba(255,248,231,0.9);
  --menu-label-main-color: var(--text);
  --menu-label-sub-color: var(--text3);
  --menu-link-dot-opacity: 0.6;
  --menu-link-dash-border: rgba(216,203,184,0.25);
  --search-mark-bg: rgba(201,151,58,0.25);
}

[data-theme="dark"] {
  --paper: #2A2318;
  --paper-edge: #3F372D;
  --bg: #1F1A16;
  --bg2: #27211B;
  --bg3: #302821;
  --surface: #27221C;
  --surface2: #312B24;
  --border: #3F372D;
  --border2: #5E4F3C;
  --text: #E6D8C2;
  --text2: #C5AD8D;
  --text3: #8E7662;
  --accent: #D2A072;

  --pali-color: #D9A77A;
  --en-color: #7FC2A4;
  --vi-color: #B79BE0;
  --ribbon-text: #F0E4C8;
  --shadow: 0 4px 18px rgba(0,0,0,0.25);
  --shadow2: 0 2px 6px rgba(0,0,0,0.18);
  --panel-bg: #2a2520;
  --chip-bg: #332c24;
  --chip-hover: #3d342a;
  --fab-bg: rgba(210, 160, 114, 0.12);
  --fab-color: rgba(210, 160, 114, 0.75);
  --fab-border: rgba(210, 160, 114, 0.22);
  --fab-bg-hover: rgba(210, 160, 114, 0.18);
  --fab-border-hover: rgba(210, 160, 114, 0.32);
  --fab-sm-bg: rgba(210, 160, 114, 0.10);
  --fab-sm-color: rgba(210, 160, 114, 0.70);
  --fab-sm-border: rgba(210, 160, 114, 0.20);
  --accent-chip-bg: rgba(210, 160, 114, 0.12);
  --accent-chip-border: rgba(210, 160, 114, 0.38);
  --accent-chip-color: rgba(210, 160, 114, 0.82);
  --accent-chip-bg-hover: rgba(210, 160, 114, 0.18);
  --accent-tool-bg: rgba(210, 160, 114, 0.10);
  --accent-tool-border: rgba(210, 160, 114, 0.30);
  --accent-tool-color: rgba(210, 160, 114, 0.80);
  --accent-tool-bg-hover: rgba(210, 160, 114, 0.18);
  --fw-active-bg: rgba(210, 160, 114, 0.15);
  --fw-active-border: rgba(210, 160, 114, 0.45);
  --fw-active-color: rgba(210, 160, 114, 0.90);
  --reset-hover-bg: rgba(210, 160, 114, 0.08);
  --slider-thumb-border: #7a6048;
  --panel-toggle-bg: #2e2820;
  --panel-toggle-hover-bg: #382f26;
  --guide-bg: #2a2318;

  --menu-block-border: var(--border);
  --menu-toggle-color: var(--text2);
  --menu-toggle-bg: var(--surface);
  --menu-nested-color: var(--text2);
  --menu-nested-border: rgba(94,79,60,0.35);
  --menu-link-color: var(--text);
  --menu-link-hover-bg: var(--bg2);
  --menu-link-active-bg: var(--accent);
  --menu-link-active-color: var(--ribbon-text);
  --menu-link-active-sub: rgba(240,228,200,0.9);
  --menu-label-main-color: var(--text);
  --menu-label-sub-color: var(--text3);
  --menu-link-dot-opacity: 0.5;
  --menu-link-dash-border: rgba(94,79,60,0.25);
  --search-mark-bg: rgba(210,160,114,0.3);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'EB Garamond', Georgia, serif;
  font-size: 16px;
  line-height: 1.6;
 -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;

  /* n·ªÅn to√†n trang theo bg m·ªõi */
  background: var(--bg);
  color: var(--text);
  transition: background var(--transition), color var(--transition);
}

/* ============================================================
   TOP RIBBON
   ============================================================ */
#ribbon {
  position: relative;
  text-align: center;
  font-size: 14px;
  font-weight: 400;
  color: #a07830;
  letter-spacing: .18em;
  padding: 12px 16px 8px;
  text-shadow: 0 1px 3px rgba(180,120,20,0.15);
  flex-shrink: 0;
}
#ribbon::after {
  content: '';
  position: absolute;
  left: 10%; right: 10%; bottom: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-light), var(--gold), var(--gold-light), transparent);
  opacity: 0.45;
}

/* ============================================================
   APP SHELL
   ============================================================ */
#app { display: flex; flex-direction: column; height: 100vh; }
#main-card {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden; position: relative;
}
#main-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent 0%, var(--gold) 15%, var(--gold-light) 50%, var(--gold) 85%, transparent 100%);
  z-index: 10;
}
#main-body { flex: 1; display: flex; overflow: hidden; position: relative; }
#card-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

/* ============================================================
   SIDEBAR OVERLAY
   ============================================================ */
#sidebar-overlay {
  display: none; position: absolute; inset: 0;
  background: rgba(44,31,14,0.4); z-index: 200;
  backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
  opacity: 0; transition: opacity var(--transition);
}
#sidebar-overlay.visible { display: block; }
#sidebar-overlay.active  { opacity: 1; }
[data-theme="dark"] #sidebar-overlay { background: rgba(10,8,5,0.55); }

/* ============================================================
   SIDEBAR
   ============================================================ */
#sidebar {
  will-change: transform;
  position: absolute;
  top: 0; left: 0; bottom: 0; width: var(--sidebar-w);
  background: var(--bg2);
  z-index: 300; display: flex; flex-direction: column;
  transform: translateX(-100%);
  transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
  box-shadow: var(--shadow);
}
#sidebar.open { transform: translateX(0); }

#sidebar-header {
  padding: 16px 16px 12px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
  background: linear-gradient(180deg, rgba(246,242,235,0.95), rgba(239,232,222,0.95));
}
#sidebar-header .icon { font-size: 1.4em; color: var(--accent); }
#sidebar-header h2 {
  flex: 1; font-family: 'Cinzel', serif; font-size: 0.95em;
  font-weight: 500; letter-spacing: 0.08em; color: var(--text);
}
#sidebar-close {
  background: none; border: none; cursor: pointer;
  color: var(--text3); font-size: 1.3em; padding: 4px; border-radius: 4px;
  transition: color var(--transition), background var(--transition);
}
#sidebar-close:hover { color: var(--accent); background: var(--bg3); }

#sutraMenuList {
  background: var(--bg2);
  flex: 1 1 auto; min-height: 0; overflow-y: auto;
  -webkit-overflow-scrolling: touch; list-style: none;
}

#sidebar-search-wrap{
  background: var(--bg2);
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
}
#sidebar-search {
  width: 100%; padding: 8px 12px;
 border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--bg2);
  font-family: 'EB Garamond', serif; font-size: 0.9em;
  outline: none; transition: border-color var(--transition);
}
#sidebar-search:focus { border-color: var(--accent); }
#sidebar-search::placeholder { color: var(--text3); }

/* ============================================================
   STICKY HEADER ‚Äî outside scrollable reading-scroll
   ============================================================ */
#sutra-header{
  flex: 0 0 auto;
  padding: 18px 14px 10px;
  border-bottom: 1px solid var(--paper-edge);
  position: relative;
  background: inherit;
  z-index: 5;

  display: grid;
  grid-template-columns: 52px 1fr 52px;
  align-items: center;
  text-align: center;
}
#sutra-header::before{
  content: '‚ù¶';
  position: absolute;
  top: 2px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  color: var(--gold);
  opacity: .75;
  pointer-events: none;
}
#sutra-header .sutra-head-center{
  padding-top: 6px;
  min-width: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}
.nav-btn{
  width: 44px; height: 44px;
  border: none; background: transparent;
  color: var(--gold);
  cursor: pointer;
  font-size: 22px;
  line-height: 1;

  display: inline-flex;
  align-items: center;
  justify-content: center;
  justify-self: center;

  opacity: .75;
  transition: opacity .15s ease, transform .15s ease;
}
.nav-btn:hover{ opacity: 1; transform: scale(1.08); }
.nav-btn:disabled{ opacity: .25; cursor: not-allowed; transform: none; }
#nav-prev, #nav-next{ left:auto; right:auto; top:auto; transform:none; }

#title{
  margin: 0;
  font-family: 'Cinzel', serif;
  font-size: calc(1rem * var(--sutra-font-scale, 1));
  font-weight: 600;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
#subtitle{
  margin: 0;
  font-family: 'EB Garamond', serif;
  font-size: calc(12px * var(--sutra-font-scale, 1));
  font-style: italic;
  color: var(--pali-color);
  letter-spacing: .03em;
  opacity: .75;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* ============================================================
   READING AREA ‚Äî header + scroll
   ============================================================ */
#reading-area {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden;
}
#reading-scroll {
  flex: 1; overflow-y: auto;
  padding: 0 24px 60px;
  scrollbar-width: thin;
  scrollbar-color: rgba(201,151,58,0.35) rgba(0,0,0,0);
}
#reading-scroll::-webkit-scrollbar { width: 10px; }
#reading-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0); }
#reading-scroll::-webkit-scrollbar-thumb {
  background: rgba(201,151,58,0.22);
  border-radius: 999px;
  border: 3px solid rgba(0,0,0,0);
  background-clip: padding-box;
}
#reading-scroll::-webkit-scrollbar-thumb:hover { background: rgba(201,151,58,0.35); }

[data-theme="dark"] #reading-scroll {
  scrollbar-color: rgba(210,160,114,0.45) rgba(0,0,0,0);
}
[data-theme="dark"] #reading-scroll::-webkit-scrollbar-thumb { background: rgba(210,160,114,0.22); }
[data-theme="dark"] #reading-scroll::-webkit-scrollbar-thumb:hover { background: rgba(210,160,114,0.35); }

/* Welcome */
#welcome { max-width: 580px; margin: 60px auto; text-align: center; }
#welcome .welcome-dharma { font-size: 3.5em; opacity: 0.2; margin-bottom: 20px; }
#welcome h1 {
  font-family: 'Cinzel', serif; font-size: 1.5em; font-weight: 500;
  letter-spacing: 0.1em; color: var(--accent); margin-bottom: 12px;
}
#welcome p { font-size: 1em; color: var(--text2); font-style: italic; line-height: 1.7; }
#welcome .welcome-divider {
  margin: 28px auto; width: 80px; height: 1px;
  background: linear-gradient(90deg, transparent, var(--border2), transparent);
}

/* ============================================================
   FLOATING BUTTONS
   ============================================================  */
/* ===== Library tab ‚Äì compact version ===== */
#sidebar-btn{
  position: absolute;
  left: 0;
  bottom: 39px;              /* cao h∆°n 1 ch√∫t ƒë·ªÉ kh√¥ng ƒë·ª•ng n·ªôi dung */
  z-index: 150;

  width: 23px;               /* üëà m·ªèng l·∫°i */
  height: 100px;             /* üëà ng·∫Øn l·∫°i */

  border-radius: 0 8px 8px 0;
  border: 1px solid var(--panel-border);
  border-left: none;

  background: var(--panel-toggle-bg);
  color: var(--fab-color);
  cursor: pointer;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;

  padding: 8px 4px;

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  box-shadow: 2px 0 8px rgba(44,31,14,0.05);

  opacity: 0.9;
  transition: all var(--transition);
}

#sidebar-btn:hover{
  background: var(--panel-toggle-hover-bg);
  box-shadow: 3px 0 12px rgba(44,31,14,0.08);
}

/* Arrow */
#sidebar-btn .sidebar-arrow{
 position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  line-height: 1;
  opacity: .7;
}

/* Rotated text */
#sidebar-btn .sidebar-label{
  position: absolute;
  bottom: 39px;
 
  font-family: 'Cinzel', serif;
  font-size: 0.62em;        /* üëà nh·ªè l·∫°i */
  letter-spacing: 0.18em;
  text-transform: uppercase;
  font-weight: 500;   
  transform: rotate(-90deg);
  line-height: 1;
  white-space: nowrap;
}



/* ===== Scroll-to-top tab (match Settings style, no overlap) ===== */
/* ===== HARD OVERRIDE: Scroll-to-top tab (fix Go Top not rotating) ===== */
#scroll-top-btn{
  position: absolute ;
  right: 0 ;
  bottom: 39px ;
  z-index: 150 ;

  width: 23px ;
  height: 100px ;

  border-radius: 10px 0 0 10px ;
  border: 1px solid var(--panel-border) ;
  border-right: none ;

  background: var(--panel-toggle-bg);
  color: var(--fab-color);
  cursor: pointer ;

  display: flex ;
  flex-direction: column ;
  align-items: center ;
  justify-content: center ;
  gap: 10px ;
  padding: 10px 6px ;

  box-shadow: -2px 0 10px rgba(44,31,14,0.06) ;
  backdrop-filter: blur(8px) ;
  -webkit-backdrop-filter: blur(8px) ;

  opacity: 0 ;
  pointer-events: none ;
  transform: translateY(8px) ;

  transition: opacity .25s ease, transform .25s ease, background .25s ease, box-shadow .25s ease ;


}

#scroll-top-btn.visible{
  opacity: 0.92 ;
  pointer-events: auto ;
  transform: translateY(0) ;
}

#scroll-top-btn:hover{
  opacity: 1 ;
  background: var(--panel-toggle-hover-bg) ;
  box-shadow: -3px 0 14px rgba(44,31,14,0.10) ;
}

/* triangle like Settings */
#scroll-top-btn .top-arrow{
  margin-bottom: 14px;
  font-size: 10px ;
  line-height: 1 ;
  opacity: .95 ;
}

/* ‚úÖ rotate TEXT only (this fixes your screenshot case) */
#scroll-top-btn .top-label{
  display: inline-block ;
  transform: rotate(-90deg) ;
  transform-origin: center ;

  white-space: nowrap ;
  margin-bottom: 14px;
  font-family: 'Cinzel', serif ;
  font-size: 0.62em ;
  font-weight: 800 ;         /* ƒë·∫≠m h∆°n */
  letter-spacing: 0.16em ;
  text-transform: uppercase ;
  opacity: .95 ;
}

/* ============================================================
   BOTTOM CONTROL PANEL
   ============================================================ */
#ctrl-panel-wrap { flex-shrink: 0; position: relative; z-index: 100; }
#ctrl-toggle { display: flex; justify-content: center; pointer-events: none; }
#ctrl-toggle-btn {
  pointer-events: all;
  background: var(--panel-toggle-bg); color: var(--fab-color);
  border: 1px solid var(--panel-border); border-bottom: none;
  cursor: pointer; font-size: 0.68em; letter-spacing: 0.16em;
  padding: 5px 20px 4px; border-radius: 10px 10px 0 0;
  font-family: 'Cinzel', serif;
  display: flex; align-items: center; gap: 7px;
  backdrop-filter: blur(8px);
  transition: background var(--transition), color var(--transition), opacity 0.18s ease;
  opacity: 0.88; box-shadow: 0 -2px 10px rgba(44,31,14,0.06);
}
#ctrl-toggle-btn:hover { opacity: 1; background: var(--panel-toggle-hover-bg); }
#ctrl-arrow { display: inline-block; transition: transform 0.3s ease; font-style: normal; font-size: 0.8em; opacity: 0.7; }
#ctrl-panel-wrap.open #ctrl-arrow { transform: rotate(180deg); }
#ctrl-panel {
  background: var(--panel-bg);
  border-top: 1px solid var(--panel-border);
  overflow: hidden; max-height: 0;
  transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1);
  box-shadow: 0 -6px 28px rgba(44,31,14,0.09);
}
#ctrl-panel-wrap.open #ctrl-panel { max-height: 420px; }

#ctrl-inner { padding: 0; }
.ctrl-row-main { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; padding: 12px 20px 10px; }
.ctrl-section {
  display: flex; flex-direction: column; gap: 10px;
  padding: 0 16px; min-width: 0;
}
.ctrl-section:first-child { padding-left: 2px; }
.ctrl-section:last-child  { padding-right: 2px; }
.ctrl-section + .ctrl-section { border-left: 1px solid rgba(216,203,184,0.4); }

.ctrl-label {
  font-family: 'Cinzel', serif; font-size: 0.56em;
  letter-spacing: 0.22em; color: var(--text3); text-transform: uppercase;
  display: flex; align-items: center; gap: 5px;
  padding-bottom: 5px;
  border-bottom: 1px solid rgba(216,203,184,0.35);
  min-height: 20px;
  white-space: nowrap;
}
.ctrl-label .ico { font-style: normal; opacity: 0.5; font-size: 1.15em; }
.ctrl-body { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }

.lang-toggle-item { display: inline-flex; align-items: center; gap: 7px; cursor: pointer; user-select: none; padding: 1px 0; }
.lang-toggle-item.last-active { opacity: 0.6; cursor: not-allowed; }
.lang-toggle-item.last-active .lang-sw { pointer-events: none; }
.lang-toggle-label {
  font-family: 'Cinzel', serif; font-size: 0.66em;
  letter-spacing: 0.12em; color: var(--text2);
  text-transform: uppercase; transition: color 0.2s ease; white-space: nowrap;
}
.lang-toggle-item:hover .lang-toggle-label { color: var(--text); }
.lang-toggle-item input[type="checkbox"] { display: none; }

.lang-sw { position: relative; width: 32px; height: 18px; flex-shrink: 0; }
.lang-sw-track { position: absolute; inset: 0; border-radius: 18px; background: var(--border); transition: background 0.25s ease; }
.lang-sw-track::after {
  content: ''; position: absolute; left: 2px; top: 2px;
  width: 14px; height: 14px; border-radius: 50%;
  background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transition: transform 0.25s cubic-bezier(0.34,1.4,0.64,1);
}
.lang-toggle-item input:checked ~ .lang-sw .lang-sw-track { background: var(--accent); }
.lang-toggle-item input:checked ~ .lang-sw .lang-sw-track::after { transform: translateX(14px); }
[data-theme="dark"] .lang-sw-track::after { background: #f0e8da; }
.lang-sep { width: 1px; height: 14px; background: var(--border); opacity: 0.35; flex-shrink: 0; }

.view-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 14px;
  border: 1px solid var(--border2); background: var(--chip-bg); color: var(--text3);
  font-family: 'Cinzel', serif; font-size: 0.58em; letter-spacing: 0.08em;
  cursor: pointer; transition: all 0.2s ease; white-space: nowrap; margin-left: 4px;
}
.view-chip:hover { border-color: var(--accent); color: var(--text2); background: var(--chip-hover); }
.view-chip[data-mode="multi"] { background: var(--accent-chip-bg); border-color: var(--accent-chip-border); color: var(--accent-chip-color); }
.view-chip .vi { font-style: normal; }

.slider-row { display: flex; align-items: center; gap: 6px; width: 100%; }
.slider-lbl {
  font-family: 'Cinzel', serif; font-size: 0.6em; letter-spacing: 0.06em;
  color: var(--text3); width: 46px; flex-shrink: 0; white-space: nowrap;
}
.slider-track { flex: 1; display: flex; align-items: center; }
.ctrl-slider {
  -webkit-appearance: none; width: 100%; height: 3px;
  background: var(--border); border-radius: 2px; outline: none; cursor: pointer;
}
.ctrl-slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 14px; height: 14px;
  background: var(--accent); border: 2px solid var(--slider-thumb-border);
  border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,0.18);
  transition: transform 0.15s ease; cursor: grab;
}
.ctrl-slider::-webkit-slider-thumb:active { transform: scale(1.15); cursor: grabbing; }
.ctrl-slider::-moz-range-thumb {
  width: 14px; height: 14px; background: var(--accent);
  border-radius: 50%; border: 2px solid var(--slider-thumb-border); cursor: grab;
}
.slider-val {
  font-family: 'Cinzel', serif; font-size: 0.58em; color: var(--text3);
  width: 30px; text-align: right; flex-shrink: 0;
}

.reset-btn {
  width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  background: none; border: 1px solid rgba(216,203,184,0.7);
  color: var(--text3); cursor: pointer; font-size: 0.7em; padding: 0;
  transition: all 0.2s ease; opacity: 0.5; font-style: normal; line-height: 1;
}
.reset-btn:hover { opacity: 1; border-color: var(--accent); color: var(--accent); background: var(--reset-hover-bg); }
.reset-btn:active { transform: scale(0.9); }

.tool-btn {

  display: inline-flex; align-items: center; gap: 5px;
  padding: 5px 11px; border-radius: var(--radius);
  border: 1px solid var(--border); background: var(--chip-bg); color: var(--text2);
  font-family: 'Cinzel', serif; font-size: 0.63em; letter-spacing: 0.06em;
  cursor: pointer; transition: all 0.2s ease; white-space: nowrap;
}
.tool-btn:hover { border-color: var(--border2); background: var(--chip-hover); color: var(--text); }
.tool-btn.accent { background: var(--accent-tool-bg); border-color: var(--accent-tool-border); color: var(--accent-tool-color); }
.tool-btn.accent:hover { background: var(--accent-tool-bg-hover); }

.tool-btn .bi { font-style: normal; font-size: 1.1em; }
.tts-play, .tts-stop { width: 28px; height: 28px; padding: 0; border-radius: 50%; justify-content: center; }
.tts-stop { font-size: 0.72em; }
.tool-btn.tts-active { background: var(--accent); color: var(--ribbon-text); border-color: var(--accent); }
.tool-sep { width: 1px; height: 18px; background: var(--border); opacity: 0.45; flex-shrink: 0; }

/* ============================================================
   LAYOUT: CARD vs FULL WIDTH
   ============================================================ */
.layout-card #app {
  height: 100%; display: flex; justify-content: center; align-items: stretch; padding: 6px 10px;
}
.layout-card #main-card {
  background: var(--paper);
    background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.02'/%3E%3C/svg%3E"),
    linear-gradient(160deg, #FCF9F2 0%, #FBF7F0 45%, #F6EEDD 100%);
  border-radius: 8px; border: 1px solid var(--paper-edge);
  border-bottom: 3px solid var(--gold);
  box-shadow: 0 2px 20px rgba(44,31,14,0.10), 0 0 0 1px rgba(44,31,14,0.04);
  width: 100%; max-width: 980px;
  display: flex; flex-direction: column; padding: 0;
  position: relative; overflow: hidden; margin: 0 auto;
  transition: background var(--transition), border-color var(--transition), box-shadow var(--transition);
}
.layout-card[data-theme="dark"] #main-card {
  background: var(--surface);
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.02'/%3E%3C/svg%3E"),
    linear-gradient(160deg, #2A2318 0%, #27221C 40%, #231E17 100%);
  border-color: var(--border2);
  border-bottom: 3px solid rgba(201,151,58,0.6);
  box-shadow: 0 2px 24px rgba(0,0,0,0.35), 0 0 0 1px rgba(0,0,0,0.15);
}
.layout-card #reading-area { background: transparent; }
.layout-wide #app { padding: 0; }
.layout-wide #main-card {
  max-width: none; width: 100%; height: 100%;
  border-radius: 0; border: none; box-shadow: none; background: transparent;
}
#fullwidth-btn.active {
  background: var(--fw-active-bg); border-color: var(--fw-active-border); color: var(--fw-active-color);
}

/* UI language toggle */
#ui-lang-btn {
  display: inline-flex; align-items: center; gap: 0;
  border-radius: 4px; border: 1px solid var(--border);
  background: var(--bg2); overflow: hidden; height: 26px; padding: 0; cursor: default;
}
.ui-lang-opt {
  display: flex; align-items: center; justify-content: center; gap: 4px;
  padding: 0 9px; height: 100%; cursor: pointer;
  font-family: 'Cinzel', serif; font-size: 0.58em; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--text3);
  transition: all 0.25s ease; border: none; background: none; white-space: nowrap;
}
.ui-lang-opt.active { background: var(--accent); color: var(--ribbon-text); font-weight: 600; }
.ui-lang-opt:not(.active):hover { color: var(--text); background: rgba(122,62,18,0.06); }
.ui-lang-flag { font-size: 1em; font-style: normal; line-height: 1; }

/* ============================================================
   GUIDE MODAL
   ============================================================ */
#guide-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(44,31,14,0.45); z-index: 9999;
  backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  justify-content: center; align-items: center;
  opacity: 0; transition: opacity 0.25s ease;
}
#guide-overlay.visible { display: flex; }
#guide-overlay.active  { opacity: 1; }
[data-theme="dark"] #guide-overlay { background: rgba(10,8,5,0.6); }

#guide-modal {
  background: var(--guide-bg); border: 1px solid var(--border);
  border-radius: 12px; max-width: 520px; width: 92%;
  max-height: 80vh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  padding: 28px 28px 22px; position: relative;
  transform: translateY(10px); transition: transform 0.25s ease;
}
#guide-overlay.active #guide-modal { transform: translateY(0); }

#guide-modal h2 {
  font-family: 'Cinzel', serif; font-size: 1.1em;
  font-weight: 600; letter-spacing: 0.1em; color: var(--accent);
  margin-bottom: 16px; text-align: center;
}
#guide-modal .guide-section { margin-bottom: 14px; }
#guide-modal .guide-section h3 {
  font-family: 'Cinzel', serif; font-size: 0.78em;
  font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--text2); margin-bottom: 6px;
  padding-bottom: 4px; border-bottom: 1px solid rgba(216,203,184,0.3);
}
#guide-modal .guide-section p {
  font-size: 0.92em; line-height: 1.7; color: var(--text);
  margin-bottom: 4px;
}
#guide-modal .guide-key {
  display: inline-block; padding: 1px 6px; border-radius: 4px;
  background: var(--bg2); border: 1px solid var(--border);
  font-family: 'Cinzel', serif; font-size: 0.8em; color: var(--accent);
}
#guide-close {
  position: absolute; top: 12px; right: 14px;
  background: none; border: none; cursor: pointer;
  color: var(--text3); font-size: 1.3em; padding: 4px; border-radius: 4px;
  transition: color 0.2s ease, background 0.2s ease;
}
#guide-close:hover { color: var(--accent); background: var(--bg3); }

/* ============================================================
   SUTRA MENU ‚Äî theme variables
   ============================================================ */
.menu-block { padding: 4px 0; border-bottom: 1px solid var(--menu-block-border); }
.menu-block:last-child { border-bottom: none; }
.menu-block > .menu-toggle:not(.nested) {
  position: relative; width: 100%; background: transparent; border: 0; border-radius: 0;
  text-align: left; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: clip;
  padding: 7px 60px 7px 10px; font-weight: 700; line-height: 1.45; font-size: 11.5px;
  text-transform: uppercase; letter-spacing: .02em; color: var(--menu-toggle-color); outline: 0;
}
#sutraMenuList > .menu-block > .menu-toggle:not(.nested) {
  position: -webkit-sticky; position: sticky; top: 0; z-index: 50;
  background-color: var(--bg2) ;
  background-image: none ;
  opacity: 1 ;
  isolation: isolate;
  box-shadow: 0 1px 0 rgba(0,0,0,0.04); display: block;
  border-bottom: 1px solid rgba(216,203,184,0.35);
}
.chevron { font-size: 10px; line-height: 1; opacity: .7; display: inline-block; }
.menu-block > .menu-toggle:not(.nested) .chevron {
  position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
}
.menu-toggle.nested {
  width: 100%; background: transparent; border: 0; border-radius: 0;
  text-align: left; cursor: pointer; display: flex; align-items: center;
  justify-content: space-between; position: relative; padding: 7px 44px 7px 18px;
  font-weight: 600; font-size: 13px; color: var(--menu-nested-color);
  border-bottom: 1px dashed var(--menu-nested-border); outline: 0;
}
.menu-toggle.nested:last-child { border-bottom: none; }
.menu-toggle.nested::before {
  content: "‚ñ∏"; position: absolute; left: 4px; top: 50%; transform: translateY(-50%);
  font-size: 9px; opacity: .75;
}
.menu-toggle.nested.open::before { content: "‚ñæ"; }
.menu-toggle.nested .chevron { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); }
.menu-subblock { margin: 3px 0; padding-left: 22px; }
.menu-list { margin-left: 0; padding-left: 0; margin-bottom: 3px; }
.menu-list.collapsed { display: none; }

.menu-sutta-link {
  position: relative; display: flex; flex-direction: column; gap: 2px;
  padding: 5px 6px 6px 34px; margin-bottom: 2px; border-radius: 6px;
  cursor: pointer; text-decoration: none; background: transparent; color: var(--menu-link-color);
  border: none; width: 100%; text-align: left; font: inherit;
  border-bottom: 1px dashed var(--menu-link-dash-border);
}
.menu-sutta-link:last-child { border-bottom: none; }
.menu-sutta-link::before {
  content: "‚Ä¢"; position: absolute; left: 18px; top: 9px; font-size: 10px; opacity: var(--menu-link-dot-opacity);
}
.menu-sutta-link:hover { background: var(--menu-link-hover-bg); }
.menu-sutta-link.active { background: var(--menu-link-active-bg); }
.menu-sutta-link.active .sutra-label-main { color: var(--menu-link-active-color); }
.menu-sutta-link.active .sutra-label-sub  { color: var(--menu-link-active-sub); }
.sutra-label { display: flex; flex-direction: column; line-height: 1.35; }
.sutra-label-main { font-size: 13px; font-weight: 600; color: var(--menu-label-main-color); }
.sutra-label-sub  { font-size: 12px; font-weight: 400; color: var(--menu-label-sub-color); }

/* Search results */
.search-results{
  background: var(--bg2);
  flex: 0 0 auto;
  padding: 0;
  max-height: 220px;
  overflow: auto;
}
.search-results:empty { display: none; }
.search-result-item {
  width: 100%; text-align: left; border: 0; background: transparent; border-radius: 0;
  padding: 6px 2px; margin: 0; display: flex; flex-direction: column; gap: 2px;
  cursor: pointer; color: var(--text); font-size: 12.5px; line-height: 1.4;
  font: inherit;
}
.search-result-item:hover { background: var(--bg3); }
.search-result-item:focus, .search-result-item:focus-visible { outline: 0; box-shadow: none; }
.search-result-item .search-main { font-weight: 600; font-size: 13px; }
.search-result-item .search-sub  { font-size: 12px; opacity: .75; }
.search-result-item mark { background: var(--search-mark-bg); padding: 0 2px; border-radius: 3px; font-weight: 600; }
.search-result-empty { padding: 4px 0; font-size: 12px; color: var(--text3); }

*, a, button, input, label { -webkit-tap-highlight-color: transparent ; }

/* ============================================================
   Sutra grid
   ============================================================ */
:root { --sutra-font-scale: 1; --sutra-line-height: 1.8; }

#sutraGrid {
  flex: 1 1 auto; min-height: 0;
  padding: 8px 4px 4px; display: flex; flex-direction: column; gap: 20px;
  font-size: calc(15px * var(--sutra-font-scale));
  line-height: var(--sutra-line-height);
}

.sutra-row {
  display: flex; flex-direction: column; gap: 0;
  border-radius: 0; border: none;
  background: transparent;
  transition: box-shadow .15s ease, border-color .15s ease;
  border-bottom: 1px solid rgba(94,79,60,0.14);
  padding: 10px 0 16px;
}
.sutra-row:last-child{ border-bottom: none; }

[data-theme="dark"] .sutra-row{
  border-bottom: 1px dashed rgba(94,79,60,0.35);
}
.sutra-row .row-key {
  font-family: 'Cinzel', serif;
  font-size: calc(11px * var(--sutra-font-scale));
  font-weight: 600;
  color: var(--text3);
  letter-spacing: 0.07em;
  padding: 0 4px 4px;
}
.sutra-row .row-cols {
  display: grid;
  grid-template-columns: repeat(var(--grid-cols, 3), 1fr);
  gap: 0;
}

.sutra-col {
  font-size: inherit; line-height: inherit;
  padding: 10px 14px;
   border-left: 1px solid rgba(94,79,60,0.18);
}

.sutra-col .col-label {
  font-family: 'Cinzel', serif;
  font-size: calc(9px * var(--sutra-font-scale));
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-bottom: 4px;
  display: block;
}
.sutra-col.pali-col .col-label { color: var(--pali-color); }
.sutra-col.eng-col  .col-label { color: var(--en-color); }
.sutra-col.vie-col  .col-label { color: var(--vi-color); }

.pali { font-family: 'EB Garamond', serif; font-size: calc(15px * var(--sutra-font-scale)); line-height: var(--sutra-line-height); }
.eng  { font-family: Georgia, serif; font-size: calc(14px * var(--sutra-font-scale)); line-height: var(--sutra-line-height); }
.vie  { font-family: system-ui; font-size: calc(14px * var(--sutra-font-scale)); line-height: calc(var(--sutra-line-height) + 0.05); }


/* Single "book reading" polish */
#sutraGrid.stack{
  max-width: min(880px, calc(100% - 64px));
  margin: 0 auto;
}
#sutraGrid.stack .sutra-row .sutra-col{
  border-left: none;
  padding: 6px 4px;
}
#sutraGrid.stack .sutra-row .pali,
#sutraGrid.stack .sutra-row .eng,
#sutraGrid.stack .sutra-row .vie{
  text-align: justify;
  text-justify: inter-word;
  hyphens: auto;
  -webkit-hyphens: auto;
  overflow-wrap: anywhere;
}
/* ============================================================
   ONE LANG ‚Äî make Multi(1 lang) look like Single (book-like)
   ============================================================ */
#sutraGrid.one-lang{
  max-width: min(880px, calc(100% - 64px));
  margin: 0 auto;
}

/* V√¨ createRow() khi one-lang ƒëang render d·∫°ng single-col */
#sutraGrid.one-lang .sutra-row{
  gap: 0;
}

#sutraGrid.one-lang .sutra-col.single-col{
  border-left: none;
  padding: 6px 4px;
}

/* ‚Äúƒë·ªçc s√°ch‚Äù: justify + hyphen gi·ªëng stack */
#sutraGrid.one-lang .sutra-col.single-col .pali,
#sutraGrid.one-lang .sutra-col.single-col .eng,
#sutraGrid.one-lang .sutra-col.single-col .vie{
  text-align: justify;
  text-justify: inter-word;
  hyphens: auto;
  -webkit-hyphens: auto;
  overflow-wrap: anywhere;
}
/* TTS highlight */
.sutra-row.tts-reading {
  background: rgba(201,151,58,0.08);
  border-radius: 8px;
  box-shadow: inset 3px 0 0 var(--gold);
}
[data-theme="dark"] .sutra-row.tts-reading { background: rgba(210,160,114,0.1); }

/* ============================================================
   MOBILE ‚Äî CSS only (no JS force)
   ============================================================ */
@media (max-width: 860px) {
  .ctrl-row-main { grid-template-columns: 1fr; padding: 8px 14px 6px; }
  .ctrl-section {
    padding: 8px 2px; border-left: none ;
    border-bottom: 1px solid rgba(216,203,184,0.4);
    flex-direction: row; align-items: center; gap: 10px;
  }
  .ctrl-section:last-child { border-bottom: none; }
  .ctrl-label { width: 52px; flex-shrink: 0; border-bottom: none; padding-bottom: 0; }
  .ctrl-body { flex: 1; }
  .slider-row { max-width: 260px; }

  /* Force SINGLE on mobile */
  #view-mode-btn { display: none ; }
  #sutraGrid { --grid-cols: 1 ; }
  #sutraGrid .row-cols { grid-template-columns: 1fr ; }
  #sutraGrid .sutra-col { border-left: none ; padding: 6px 4px; }
  #sutraGrid { gap: 14px; }
}

@media (max-width: 480px) {
  #reading-scroll { padding: 8px 16px 50px; }
  .ctrl-label { width: 44px; font-size: 0.52em; }
  .slider-row { max-width: 200px; }
  .tool-btn { padding: 4px 8px; font-size: 0.58em; }
  .ui-lang-opt { font-size: 0.56em; }
  #guide-modal { padding: 20px 16px 16px; }
  #sutraGrid.stack{ max-width: calc(100% - 24px); }
}

/* ============================================================
   DARK MODE CLEAN VERSION
   ============================================================ */
[data-theme="dark"] .pali,
[data-theme="dark"] .eng,
[data-theme="dark"] .vie { color: var(--text) ; }

[data-theme="dark"] .col-label { color: #d6a96f ; opacity: 0.85; }
[data-theme="dark"] .sutra-col.pali-col .col-label,
[data-theme="dark"] .sutra-col.eng-col  .col-label,
[data-theme="dark"] .sutra-col.vie-col  .col-label { color: #d6a96f ; }

[data-theme="dark"] #sutra-header::before { opacity: 0.55; }
[data-theme="dark"] #ribbon { color: rgba(210,160,114,0.6); }

[data-theme="dark"] .nav-btn { opacity: 0.55; }
[data-theme="dark"] .nav-btn:hover { opacity: 0.9; }

[data-theme="dark"] #sidebar {
  background: linear-gradient(180deg, rgba(39,34,28,0.96), rgba(32,28,24,0.96));
}
[data-theme="dark"] #sidebar-header {
  background: linear-gradient(180deg, rgba(42,35,24,0.95), rgba(36,30,24,0.95));
}
[data-theme="dark"] #sidebar-search { background: rgba(31,26,22,0.65); }

/* Sidebar scrollbars (menu + search results) */
#sutraMenuList,
.search-results {
  scrollbar-width: thin;
  scrollbar-color: rgba(201,151,58,0.45) rgba(0,0,0,0);
}
#sutraMenuList::-webkit-scrollbar,
.search-results::-webkit-scrollbar { width: 10px; }
#sutraMenuList::-webkit-scrollbar-track,
.search-results::-webkit-scrollbar-track { background: rgba(0,0,0,0); }
#sutraMenuList::-webkit-scrollbar-thumb,
.search-results::-webkit-scrollbar-thumb {
  background: rgba(201,151,58,0.28);
  border-radius: 999px;
  border: 3px solid rgba(0,0,0,0);
  background-clip: padding-box;
}
#sutraMenuList::-webkit-scrollbar-thumb:hover,
.search-results::-webkit-scrollbar-thumb:hover { background: rgba(201,151,58,0.42); }

[data-theme="dark"] #sutraMenuList,
[data-theme="dark"] .search-results {
  scrollbar-color: rgba(210,160,114,0.55) rgba(0,0,0,0);
}
[data-theme="dark"] #sutraMenuList::-webkit-scrollbar-thumb,
[data-theme="dark"] .search-results::-webkit-scrollbar-thumb { background: rgba(210,160,114,0.28); }
[data-theme="dark"] #sutraMenuList::-webkit-scrollbar-thumb:hover,
[data-theme="dark"] .search-results::-webkit-scrollbar-thumb:hover { background: rgba(210,160,114,0.42); }

/* Multi hide theo root class (gi·ªØ l·∫°i n·∫øu b·∫°n ƒëang d√πng) */
#sutraGrid.hide-pali .pali-col { display:none; }
#sutraGrid.hide-eng  .eng-col  { display:none; }
#sutraGrid.hide-vie  .vie-col  { display:none; }

#sutraGrid[data-visible="pali"] .eng-col,
#sutraGrid[data-visible="pali"] .vie-col { display:none; }

#sutraGrid[data-visible="eng"] .pali-col,
#sutraGrid[data-visible="eng"] .vie-col { display:none; }

#sutraGrid[data-visible="vie"] .pali-col,
#sutraGrid[data-visible="vie"] .eng-col { display:none; }

#sutraGrid[data-visible="pali"] .col-label,
#sutraGrid[data-visible="eng"]  .col-label,
#sutraGrid[data-visible="vie"]  .col-label { display:none; }


/* ui */
/* =========================================
   FINAL: End Prev/Next ‚Äî small + aligned
   Paste at VERY END of CSS
   ========================================= */

/* =========================================
   End Prev / Next ‚Äì compact version
   ========================================= */

#end-nav{
  margin: 22px auto 0;
  padding-top: 14px;
  border-top: 1px dashed rgba(216,203,184,.28);

  display: flex;
  justify-content: center;   /* üëà n·∫±m gi·ªØa */
  gap: 16px;
}

#end-prev,
#end-next{
  display: inline-flex;
  align-items: center;
  justify-content: center;

  height: 36px;              /* üëà nh·ªè l·∫°i */
  padding: 0 18px;           /* üëà g·ªçn h∆°n */
  border-radius: 999px;      /* üëà pill shape */

  border: 1px solid rgba(216,203,184,.45);
  background: rgba(255,255,255,.25);

  font-family: 'Cinzel', serif;
  font-size: .62em;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--text2);

  transition: all .18s ease;
  box-shadow: 0 4px 12px rgba(44,31,14,0.05);
}

#end-prev:hover,
#end-next:hover{
  transform: translateY(-1px);
  border-color: rgba(201,151,58,.55);
  background: rgba(201,151,58,.08);
}

#end-prev:disabled,
#end-next:disabled{
  opacity: .4;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
</style>
</head>

<body>
<div id="app">
  <div id="main-card">
    <div id="ribbon">NAMO TASSA BHAGAVATO ARAHATO SAMMƒÄSAMBUDDHASSA</div>

    <div id="card-body">
      <div id="sidebar-overlay"></div>

      <nav id="sidebar">
        <div id="sidebar-header">
          <span class="icon">‚ò∏</span>
          <h2>Sutta Reader</h2>
          <button type="button" id="sidebar-close" title="Close">‚úï</button>
        </div>
        <div id="sidebar-search-wrap">
          <input id="sidebar-search" type="search" placeholder="" autocomplete="off">
          <div id="sutraSearchResults" class="search-results"></div>
        </div>
        <ul id="sutraMenuList" class="sutra-list"></ul>
      </nav>

      <div id="main-body">
        <main id="reading-area">
          <div id="sutra-header" style="display:none;">
            <button type="button" class="nav-btn" id="nav-prev" aria-label="Previous">¬´</button>
            <div class="sutra-head-center">
              <h1 id="title">‚Äî</h1>
              <div id="subtitle">‚Äî</div>
            </div>
            <button type="button" class="nav-btn" id="nav-next" aria-label="Next">¬ª</button>
          </div>

          <div id="reading-scroll">
            <div id="welcome">
              <div class="welcome-dharma">‚ò∏</div>
              <h1 data-i18n="welcome-title">Sutta Reader</h1>
              <div class="welcome-divider"></div>
              <p data-i18n="welcome-text">Select a sutta from the sidebar to begin reading.<br>The Dhamma is a raft, not something to be grasped.</p>
            </div>
            <div id="sutraGrid"></div>
			<div id="end-nav" class="end-nav" style="display:none;">
			  <button type="button" id="end-prev" class="end-nav-btn" disabled>
				<div class="end-nav-kicker"data-i18n="btn-prev-sutta">¬´ B√†i kinh tr∆∞·ªõc</div>
				
			  </button>

			  <button type="button" id="end-next" class="end-nav-btn" disabled>
				<div class="end-nav-kicker"data-i18n="btn-next-sutta">B√†i kinh sau ¬ª</div>
				
			  </button>
			</div>
          </div>
        </main>

         <button type="button" id="sidebar-btn" title="Open sutta list">
          <span class="sidebar-label" data-i18n="btn-library">Library</span>
          <span class="sidebar-arrow">‚ñ∏</span>
        </button>

       <button type="button" id="scroll-top-btn" title="Go to top" aria-label="Go to top">
			  <span class="top-arrow">‚ñ≤</span>
			  <span class="top-label" id="top-label" data-i18n="btn-top">GO TOP</span>
			</button>	
      </div>

      <div id="ctrl-panel-wrap">
        <div id="ctrl-toggle">
          <button type="button" id="ctrl-toggle-btn" aria-expanded="false" aria-controls="ctrl-panel">
            <i id="ctrl-arrow" aria-hidden="true">‚ñ≤</i>
            <span data-i18n="settings">Settings</span>
          </button>
        </div>

        <div id="ctrl-panel" role="region" aria-label="Reading settings">
          <div id="ctrl-inner">
            <div class="ctrl-row-main">

              <div class="ctrl-section">
                <div class="ctrl-label"><i class="ico">‚ò∞</i> <span data-i18n="languages">Lang</span></div>
                <div class="ctrl-body">
                  <label class="lang-toggle-item" title="PƒÅli">
                    <input type="checkbox" id="tog-pali" checked>
                    <span class="lang-toggle-label">PƒÅli</span>
                    <span class="lang-sw"><span class="lang-sw-track"></span></span>
                  </label>
                  <span class="lang-sep"></span>
                  <label class="lang-toggle-item" title="English">
                    <input type="checkbox" id="tog-en" checked>
                    <span class="lang-toggle-label">EN</span>
                    <span class="lang-sw"><span class="lang-sw-track"></span></span>
                  </label>
                  <span class="lang-sep"></span>
                  <label class="lang-toggle-item" title="Vietnamese">
                    <input type="checkbox" id="tog-vi" checked>
                    <span class="lang-toggle-label">VI</span>
                    <span class="lang-sw"><span class="lang-sw-track"></span></span>
                  </label>
                  <button type="button" class="view-chip" id="view-mode-btn" data-mode="multi" title="Multi/Single">
                    <i class="vi">‚äû</i> Multi
                  </button>
                </div>
              </div>

              <div class="ctrl-section">
                <div class="ctrl-label"><i class="ico">‚ó´</i> <span data-i18n="reading">Read</span></div>
                <div class="ctrl-body" style="flex-direction:column; align-items:stretch; gap:5px;">
                  <div class="slider-row">
                    <span class="slider-lbl" data-i18n="size">Size</span>
                    <div class="slider-track">
                      <input type="range" class="ctrl-slider" id="font-size-slider" min="12" max="28" value="16" step="1">
                    </div>
                    <span class="slider-val" id="font-size-val">16px</span>
                    <button type="button" class="reset-btn" id="reset-font" title="Reset">‚Ü∫</button>
                  </div>
                  <div class="slider-row">
                    <span class="slider-lbl" data-i18n="spacing">Line</span>
                    <div class="slider-track">
                      <input type="range" class="ctrl-slider" id="line-height-slider" min="12" max="26" value="18" step="1">
                    </div>
                    <span class="slider-val" id="line-height-val">1.8</span>
                    <button type="button" class="reset-btn" id="reset-line" title="Reset">‚Ü∫</button>
                  </div>
                </div>
              </div>

              <div class="ctrl-section">
                <div class="ctrl-label"><i class="ico">‚öô</i> <span data-i18n="tools">Tools</span></div>
                <div class="ctrl-body">
                  <button type="button" class="tool-btn tts-play" id="tts-play-btn" title="Play / Pause" aria-label="Play">
                    <i class="bi" id="tts-play-icon">‚ñ∂</i>
                  </button>
                  <button type="button" class="tool-btn tts-stop" id="tts-stop-btn" title="Stop" aria-label="Stop">
                    <i class="bi">‚ñ†</i>
                  </button>
                  <span class="tool-sep"></span>
                  <button type="button" id="fullwidth-btn" class="tool-btn" title="Full width">
                    <i class="bi">‚õ∂</i>
                  </button>
                  <span class="tool-sep"></span>
                  <div id="ui-lang-btn" title="UI language">
                    <button type="button" class="ui-lang-opt" data-lang="en">EN</button>
                    <button type="button" class="ui-lang-opt active" data-lang="vi">VI</button>
                  </div>
                  <span class="tool-sep"></span>
                  <button type="button" id="theme-btn" class="tool-btn accent" title="Theme">
                    <i class="bi" id="theme-icon">‚òΩ</i>
                  </button>
                  <button type="button" id="guide-btn" class="tool-btn" title="Guide">
                    <i class="bi">?</i>
                  </button>
					<div style="margin-top:18px; text-align:center;">
  <button id="guide-reset-ui"
          style="
            padding:6px 14px;
            border-radius:8px;
            border:1px solid var(--border2);
            background: var(--chip-bg);
            font-family:'Cinzel',serif;
            font-size:.6em;
            letter-spacing:.12em;
            cursor:pointer;">
    RESET UI
  </button>
</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="guide-overlay">
  <div id="guide-modal">
    <button type="button" id="guide-close" title="Close">‚úï</button>
    <div id="guide-content"></div>
  </div>
</div>

<script src="toc.js"></script>
<script>

const KEY_VIEW    = 'sutta-reader-view';
const KEY_LAST    = 'sutta-reader-last';
const KEY_SCROLL  = 'sutta-reader-scroll';
const KEY_UI_LANG = 'sutta-reader-ui-lang';

let lastSingleLangMode = null;
let uiLang = 'vi';
let renderToken = 0;

let NAV_ORDER = [];
let FLAT_SUTTAS = [];
let currentSutraId = null;
let currentMerged = null;
let currentViewRows = [];           // ‚úÖ NEW: TTS d√πng data thay v√¨ scan DOM
let showPali = true, showEng = true, showVie = true;

/* ============================================================
   DOM REFS
   ============================================================ */
const $ = id => document.getElementById(id);

const sutraMenuList   = $('sutraMenuList');
const btnPali         = $('tog-pali');
const btnEng          = $('tog-en');
const btnVie          = $('tog-vi');
const sidebar         = $('sidebar');
const overlay         = $('sidebar-overlay');
const sidebarBtn      = $('sidebar-btn');
const sidebarClose    = $('sidebar-close');
const ctrlWrap        = $('ctrl-panel-wrap');
const ctrlToggleBtn   = $('ctrl-toggle-btn');
const readingScroll   = $('reading-scroll');
const themeBtn        = $('theme-btn');
const themeIcon       = $('theme-icon');
const searchInput     = $('sidebar-search');
const searchResultsEl = $('sutraSearchResults');
const grid            = $('sutraGrid');
const titleEl         = $('title');
const subtitleEl      = $('subtitle');
const welcomeEl       = $('welcome');
const sutraHeader     = $('sutra-header');
const ttsPlayBtn      = $('tts-play-btn');
const ttsPlayIcon     = $('tts-play-icon');
const ttsStopBtn      = $('tts-stop-btn');
const scrollTopBtn    = $('scroll-top-btn');
const guideBtn        = $('guide-btn');
const guideOverlay    = $('guide-overlay');
const guideCloseBtn   = $('guide-close');
const guideContent    = $('guide-content');
const LOADED_PACKS = new Set();
const PACK_PROMISES = new Map();
const KEY_THEME  = 'sutta-reader-theme';
const KEY_LAYOUT = 'sutta-reader-layout';
const endNav = $('end-nav');
const endPrev = $('end-prev');
const endNext = $('end-next');


const SECTION_BY_SUTTA_ID = new Map();
const META_BY_ID = new Map();

const navPrevBtn = $('nav-prev');
const navNextBtn = $('nav-next');

/* ============================================================
   SAFE DOM HELPERS (null-safe)
   ============================================================ */
function qs(sel, root=document){ return root ? root.querySelector(sel) : null; }
function qsa(sel, root=document){ return root ? Array.from(root.querySelectorAll(sel)) : []; }

function on(el, evt, fn, opts){
  if (!el) return;
  el.addEventListener(evt, fn, opts);
}
function setAria(el, name, val){
  if (!el) return;
  el.setAttribute(name, String(val));
}
function adjustRowColumns() {
  if (!grid) return;
  const stack = grid.classList.contains('stack');
  if (stack) {
    grid.style.setProperty('--grid-cols', '1');
  } else {
    let c = 0; if (showPali) c++; if (showEng) c++; if (showVie) c++;
    grid.style.setProperty('--grid-cols', String(Math.max(1, c)));
  }
}
function cssEscape(v) {
  const s = String(v ?? '');
  if (window.CSS && typeof CSS.escape === 'function') return CSS.escape(s);
   return s
    .replace(/\\/g, '\\\\')      // backslash
    .replace(/"/g, '\\"')        // double quote
    .replace(/\n/g, '\\A ')      // newline
    .replace(/\r/g, '\\D ')      // carriage return
    .replace(/\f/g, '\\C ')      // form feed
    .replace(/[\0-\x1f\x7f]/g, ch => '\\' + ch.charCodeAt(0).toString(16) + ' ') // control chars
    .replace(/([#.;,[\]():=<>+~*^$|!?{}\/@`%&' \t])/g, '\\$1'); // common specials + space
}
/* ============================================================
   i18n
   ============================================================ */
const i18n = {
  en: {
    'welcome-title': 'Sutta Reader',
    'welcome-text': 'Select a sutta from the sidebar to begin reading.<br>The Dhamma is a raft, not something to be grasped.',
    'settings': 'Settings',
    'languages': 'Lang',
    'reading': 'Read',
    'size': 'Size',
    'spacing': 'Line',
    'tools': 'Tools',
    'search-placeholder': 'Search suttas‚Ä¶',
	'btn-library': 'Library',
    'btn-top': 'Go Top',
    'btn-prev-sutta': '¬´ Previous',
    'btn-next-sutta': 'Next ¬ª',
	'tip-library': 'Open sutta list',
	'tip-top': 'Go to top',
  },
  vi: {
    'welcome-title': 'ƒê·ªçc Kinh',
    'welcome-text': 'Ch·ªçn m·ªôt b√†i kinh t·ª´ thanh b√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.<br>Ph√°p nh∆∞ chi·∫øc b√®, kh√¥ng ph·∫£i ƒë·ªÉ n·∫Øm gi·ªØ.',
    'settings': 'C√†i ƒë·∫∑t',
    'languages': 'Ng√¥n ng·ªØ',
    'reading': 'ƒê·ªçc',
    'size': 'C·ª°',
    'spacing': 'D√≤ng',
    'tools': 'Ti·ªán √≠ch',
    'search-placeholder': 'T√¨m kinh‚Ä¶',
	'btn-library': 'Th∆∞ vi·ªán',
    'btn-top': 'L√™n ƒë·∫ßu',
    'btn-prev-sutta': '¬´ B√†i kinh tr∆∞·ªõc',
    'btn-next-sutta': 'B√†i kinh sau ¬ª',
	'tip-library': 'M·ªü danh s√°ch kinh',
	'tip-top': 'Cu·ªôn l√™n ƒë·∫ßu',
  }
};

/* Optional: i18n labels for columns */
function getColLabels() {
  if (uiLang === 'vi') return { pali: 'PƒÄLI', eng: 'ANH', vie: 'VI·ªÜT' };
  return { pali: 'PALI', eng: 'ENGLISH', vie: 'VIETNAMESE' };
}

/* Guide content */
const guideHtml = {
  en: `
    <h2>‚ò∏ User Guide</h2>
    <div class="guide-section">
      <h3>‚ò∞ Sutta List</h3>
      <p>Click the <span class="guide-key">‚ò∞</span> button (bottom-left) to open the sidebar. Browse by collection or use the search bar to find a sutta by name or code.</p>
    </div>
    <div class="guide-section">
      <h3>Languages</h3>
      <p>Toggle <b>PƒÅli</b>, <b>EN</b>, <b>VI</b> switches to show/hide each language column. Click <span class="guide-key">Multi / Single</span> to switch between side-by-side and stacked view.</p>
    </div>
    <div class="guide-section">
      <h3>Reading</h3>
      <p><b>Size</b> ‚Äî adjust font size. <b>Line</b> ‚Äî adjust line spacing. Click <span class="guide-key">‚Ü∫</span> to reset to default.</p>
    </div>
    <div class="guide-section">
      <h3>Text-to-Speech</h3>
      <p>
        Click <span class="guide-key">‚ñ∂</span> to start reading aloud. The current line is highlighted and auto-scrolled.
        Click again to pause, or <span class="guide-key">‚ñ†</span> to stop.
      </p>
      <p><b>Language:</b> TTS follows the interface language (EN / VI). It does not read PƒÅli in the current version.</p>
    </div>
    <div class="guide-section">
      <h3>Other Tools</h3>
      <p><span class="guide-key">‚õ∂</span> ‚Äî Toggle full-width layout.
      <span class="guide-key">EN / VI</span> ‚Äî Switch interface language.
      <span class="guide-key">‚òΩ</span> ‚Äî Toggle dark/light theme.</p>
    </div>
    <div class="guide-section">
      <h3>Auto-Save</h3>
      <p>Your last read sutta and scroll position are saved automatically. When you return, reading resumes where you left off.</p>
    </div>
  `,
  vi: `
    <h2>‚ò∏ H∆∞·ªõng D·∫´n</h2>
    <div class="guide-section">
      <h3>‚ò∞ Danh s√°ch kinh</h3>
      <p>Nh·∫•n n√∫t <span class="guide-key">‚ò∞</span> (g√≥c tr√°i d∆∞·ªõi) ƒë·ªÉ m·ªü thanh b√™n. Duy·ªát theo b·ªô s∆∞u t·∫≠p ho·∫∑c t√¨m ki·∫øm theo t√™n hay m√£ kinh.</p>
    </div>
    <div class="guide-section">
      <h3>Ng√¥n ng·ªØ</h3>
      <p>B·∫≠t/t·∫Øt <b>PƒÅli</b>, <b>EN</b>, <b>VI</b> ƒë·ªÉ hi·ªán/·∫©n t·ª´ng c·ªôt ng√¥n ng·ªØ. Nh·∫•n <span class="guide-key">Multi / Single</span> ƒë·ªÉ chuy·ªÉn gi·ªØa ch·∫ø ƒë·ªô c·ªôt song song v√† x·∫øp ch·ªìng.</p>
    </div>
    <div class="guide-section">
      <h3>ƒê·ªçc</h3>
      <p><b>C·ª°</b> ‚Äî thay ƒë·ªïi c·ª° ch·ªØ. <b>D√≤ng</b> ‚Äî thay ƒë·ªïi kho·∫£ng c√°ch d√≤ng. Nh·∫•n <span class="guide-key">‚Ü∫</span> ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫∑c ƒë·ªãnh.</p>
    </div>
    <div class="guide-section">
      <h3>ƒê·ªçc th√†nh ti·∫øng (TTS)</h3>
      <p>
        Nh·∫•n <span class="guide-key">‚ñ∂</span> ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·ªçc. D√≤ng ƒëang ƒë·ªçc ƒë∆∞·ª£c t√¥ s√°ng v√† t·ª± cu·ªôn theo.
        Nh·∫•n l·∫°i ƒë·ªÉ t·∫°m d·ª´ng, ho·∫∑c <span class="guide-key">‚ñ†</span> ƒë·ªÉ d·ª´ng h·∫≥n.
      </p>
      <p><b>Ng√¥n ng·ªØ:</b> TTS ch·∫°y theo ng√¥n ng·ªØ giao di·ªán (EN / VI). Phi√™n b·∫£n hi·ªán t·∫°i ch∆∞a ƒë·ªçc PƒÅli.</p>
    </div>
    <div class="guide-section">
      <h3>C√¥ng c·ª• kh√°c</h3>
      <p><span class="guide-key">‚õ∂</span> ‚Äî Ch·∫ø ƒë·ªô to√†n m√†n h√¨nh.
      <span class="guide-key">EN / VI</span> ‚Äî ƒê·ªïi ng√¥n ng·ªØ giao di·ªán.
      <span class="guide-key">‚òΩ</span> ‚Äî Ch·∫ø ƒë·ªô s√°ng/t·ªëi.</p>
    </div>
    <div class="guide-section">
      <h3>T·ª± ƒë·ªông l∆∞u</h3>
      <p>B√†i kinh v√† v·ªã tr√≠ ƒë·ªçc ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông. Khi quay l·∫°i, b·∫°n s·∫Ω ti·∫øp t·ª•c ƒë·ªçc t·∫°i n∆°i ƒë√£ d·ª´ng.</p>
    </div>
  `
};

/* ============================================================
   BILARA DATA
   ============================================================ */
window.BILARA = window.BILARA || {};
const BILARA_BASE_DIR = './sutta';

function getBilaraPack(lang, id) {
  if (!id || !/^[A-Za-z0-9_-]+$/.test(id)) return null;
  return `${BILARA_BASE_DIR}/${lang}/${id}`;
}
const MERGED_CACHE = new Map();
const MERGED_PROMISES = new Map();
const CACHE_ORDER = [];
const MAX_CACHE_SUTTAS = 30;

const PARA_CACHE = new Map(); // ‚úÖ NEW: key = `${id}|${lang}`

function dropBilaraSutta(id) {
  // 1) Gi·∫£i ph√≥ng data g·ªëc c·ªßa sutta ƒë√£ load (RAM gi·∫£m th·∫≠t)
  if (window.BILARA && window.BILARA[id]) {
    try { delete window.BILARA[id]; } 
    catch (e) { window.BILARA[id] = undefined; }
  }

  // 2) (Optional) d·ªçn tracking pack ƒë√£ load ƒë·ªÉ Set kh√¥ng ph√¨nh
  // Kh√¥ng "unload script" ƒë∆∞·ª£c, ch·ªâ d·ªçn Set th√¥i.
  try {
    LOADED_PACKS.delete(getBilaraPack('pli', id));
    LOADED_PACKS.delete(getBilaraPack('en', id));
    LOADED_PACKS.delete(getBilaraPack('vi', id));
  } catch(e) {}
}

function touchCache(id) {
  const i = CACHE_ORDER.indexOf(id);
  if (i !== -1) CACHE_ORDER.splice(i, 1);
  CACHE_ORDER.push(id);

  while (CACHE_ORDER.length > MAX_CACHE_SUTTAS) {
    const old = CACHE_ORDER.shift();
    if (!old) continue;

    MERGED_CACHE.delete(old);

    // ‚úÖ clear paragraph cache for that sutta
    for (const k of PARA_CACHE.keys()) {
      if (k.startsWith(old + '|')) PARA_CACHE.delete(k);
    }

    dropBilaraSutta(old);
  }
}

function unionKeys3(a, b, c) {
  const set = new Set();
  if (a) Object.keys(a).forEach(k => set.add(k));
  if (b) Object.keys(b).forEach(k => set.add(k));
  if (c) Object.keys(c).forEach(k => set.add(k));
  return Array.from(set);
}
function sortBilaraKeys(keys) {
  return keys.sort((x, y) => x.localeCompare(y, 'en', { numeric: true }));
}

/* Lazy load pack JS */


function loadPackIfNeeded(pack) {
  if (!pack) return Promise.resolve();
  if (LOADED_PACKS.has(pack)) return Promise.resolve();
  if (PACK_PROMISES.has(pack)) return PACK_PROMISES.get(pack);
  const p = new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = pack + '.js'; s.async = true;
    s.onload  = () => { LOADED_PACKS.add(pack); PACK_PROMISES.delete(pack); s.remove(); res(); };
    s.onerror = (err) => { PACK_PROMISES.delete(pack); rej(err); };
    document.body.appendChild(s);
  });
  PACK_PROMISES.set(pack, p);
  return p;
}

async function loadMerged(id) {
  if (!id) return null;
  if (MERGED_CACHE.has(id)) return MERGED_CACHE.get(id);
  if (MERGED_PROMISES.has(id)) return MERGED_PROMISES.get(id);

  const p = (async () => {
    await Promise.all([
      loadPackIfNeeded(getBilaraPack('pli', id)),
      loadPackIfNeeded(getBilaraPack('en', id)),
      loadPackIfNeeded(getBilaraPack('vi', id)),
    ]);
    const entry = window.BILARA[id] || {};
    const paliMap = entry.pli || {}, engMap = entry.en || {}, vieMap = entry.vi || {};
    const keys = sortBilaraKeys(unionKeys3(paliMap, engMap, vieMap));
    const rows = keys.map(k => ({ key: k, pali: paliMap[k]||'', eng: engMap[k]||'', vie: vieMap[k]||'' }));

    // ‚úÖ cache rowsRaw (l·ªçc :0. ch·ªâ l√†m 1 l·∫ßn/sutta)
    const rowsRaw = rows.filter(r => !String(r.key||'').includes(':0.'));

    const merged = { paliMap, engMap, vieMap, keys, rows, rowsRaw };
    MERGED_CACHE.set(id, merged);
    touchCache(id);
    MERGED_PROMISES.delete(id);
    return merged;
  })().catch(e => { MERGED_PROMISES.delete(id); throw e; });

  MERGED_PROMISES.set(id, p);
  return p;
}

/* ============================================================
   VIEW PREFS
   ============================================================ */
function saveViewPrefs() {
  try {
    localStorage.setItem(KEY_VIEW, JSON.stringify({
      showPali, showEng, showVie,
      stack: grid ? grid.classList.contains('stack') : false,
    }));
  } catch(e){}
}

function loadViewPrefs() {
  try {
    const raw = localStorage.getItem(KEY_VIEW);
    if (!raw) return;
    const p = JSON.parse(raw);
    if (typeof p.showPali === 'boolean') showPali = p.showPali;
    if (typeof p.showEng  === 'boolean') showEng  = p.showEng;
    if (typeof p.showVie  === 'boolean') showVie  = p.showVie;
    if (btnPali) btnPali.checked = showPali;
    if (btnEng)  btnEng.checked  = showEng;
    if (btnVie)  btnVie.checked  = showVie;
    if (p.stack && grid) {
      grid.classList.add('stack');
      const vmb = $('view-mode-btn');
      if (vmb) { vmb.dataset.mode = 'single'; vmb.innerHTML = '<i class="vi">‚ñ§</i> Single'; }
    }
  } catch(e){}
}

/* ============================================================
   SCROLL POSITION ‚Äî save & restore
   ============================================================ */
function saveScrollPosition() {
  if (!currentSutraId || !readingScroll) return;
  try { localStorage.setItem(KEY_SCROLL, JSON.stringify({ id: currentSutraId, top: readingScroll.scrollTop })); } catch(e){}
}
function restoreScrollPosition(id) {
  try {
    const raw = localStorage.getItem(KEY_SCROLL);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (data.id === id && typeof data.top === 'number' && readingScroll) {
      requestAnimationFrame(() => { requestAnimationFrame(() => { readingScroll.scrollTop = data.top; }); });
    }
  } catch(e){}
}
function updateEndNavVisibility() {
  if (!readingScroll || !endNav || !currentSutraId) return;
  const threshold = 220; // px g·∫ßn cu·ªëi th√¨ hi·ªán
  const nearEnd = (readingScroll.scrollHeight - (readingScroll.scrollTop + readingScroll.clientHeight)) < threshold;
  endNav.style.display = nearEnd ? '' : 'none';
}

function updateScrollTopBtn() {
  if (!readingScroll || !scrollTopBtn) return;
  scrollTopBtn.classList.toggle('visible', readingScroll.scrollTop > 120);
}

/* ============================================================
   VISIBILITY ‚Äî prevent disabling all 3 languages
   ============================================================ */
function countActiveLangs() { return (showPali?1:0)+(showEng?1:0)+(showVie?1:0); }

function updateLangToggleStates() {
  const count = countActiveLangs();
  const paliLabel = btnPali ? btnPali.closest('.lang-toggle-item') : null;
  const engLabel  = btnEng  ? btnEng.closest('.lang-toggle-item')  : null;
  const vieLabel  = btnVie  ? btnVie.closest('.lang-toggle-item')  : null;
  if (paliLabel) paliLabel.classList.toggle('last-active', count === 1 && showPali);
  if (engLabel)  engLabel.classList.toggle('last-active',  count === 1 && showEng);
  if (vieLabel)  vieLabel.classList.toggle('last-active',  count === 1 && showVie);
}

function applyVisibility() {
   if (!grid) return;

  grid.classList.toggle('hide-pali', !showPali);
  grid.classList.toggle('hide-eng',  !showEng);
  grid.classList.toggle('hide-vie',  !showVie);

  const single = getSingleVisibleLang();
  if (single) grid.dataset.visible = single;
  else delete grid.dataset.visible; // ‚úÖ clean
  grid.classList.toggle('one-lang', !!single);

  adjustRowColumns();
  updateLangToggleStates();
 }

function tryToggleLang(checkbox, setter) {
  const newVal = checkbox.checked;
  if (!newVal && countActiveLangs() <= 1) {
    checkbox.checked = true;
    return;
  }
  setter(newVal);
  applyVisibility();
  saveViewPrefs();
  maybeRerenderIfModeChanged();
}

function maybeRerenderIfModeChanged() {
  const mode = getSingleVisibleLang();
  if (mode !== lastSingleLangMode && currentSutraId) renderSutra(currentSutraId);
}

window.addEventListener('resize', adjustRowColumns);

if (btnPali) btnPali.addEventListener('change', () => tryToggleLang(btnPali, v => { showPali = v; }));
if (btnEng)  btnEng.addEventListener('change',  () => tryToggleLang(btnEng,  v => { showEng  = v; }));
if (btnVie)  btnVie.addEventListener('change',  () => tryToggleLang(btnVie,  v => { showVie  = v; }));

/* ============================================================
   UI LANGUAGE (persist)
   ============================================================ */
function setUiLang(lang) {
  uiLang = lang;
  document.documentElement.dataset.uiLang = lang;

  const dict = i18n[lang] || i18n.en;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (dict[key]) el.innerHTML = dict[key];
  });
  if (searchInput && dict['search-placeholder']) searchInput.placeholder = dict['search-placeholder'];

  const uiLangBtnEl = $('ui-lang-btn');
  if (uiLangBtnEl) {
    uiLangBtnEl.querySelectorAll('.ui-lang-opt').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
  }

  try { localStorage.setItem(KEY_UI_LANG, lang); } catch(e){}

  buildSutraMenuFromIndex();
  if (searchInput && searchInput.value.trim()) applySearch(searchInput.value);
  if (currentSutraId && sutraMenuList) {
    const al = sutraMenuList.querySelector(`.menu-sutta-link[data-id="${cssEscape(currentSutraId)}"]`);
    if (al) al.classList.add('active');
  }

  updateSutraHeader();  // will only update if currentMerged is ready (OK)
   // update tooltips for 2 side tabs
  const dict2 = i18n[lang] || i18n.en;

  if (sidebarBtn && dict2['tip-library']) sidebarBtn.title = dict2['tip-library'];
  if (scrollTopBtn && dict2['tip-top']) {
    scrollTopBtn.title = dict2['tip-top'];
    scrollTopBtn.setAttribute('aria-label', dict2['tip-top']);
  }
}

(function() {
  const uiLangBtnEl = $('ui-lang-btn');
  if (uiLangBtnEl) {
    uiLangBtnEl.addEventListener('click', e => {
      const btn = e.target.closest('.ui-lang-opt');
      if (btn) setUiLang(btn.dataset.lang);
    });
  }
})();

/* ============================================================
   GUIDE MODAL
   ============================================================ */
function openGuide() {
  if (!guideContent || !guideOverlay) return;
  guideContent.innerHTML = guideHtml[uiLang] || guideHtml.en;
  guideOverlay.classList.add('visible');
  requestAnimationFrame(() => guideOverlay.classList.add('active'));
}
function closeGuide() {
  if (!guideOverlay) return;
  guideOverlay.classList.remove('active');
  setTimeout(() => guideOverlay.classList.remove('visible'), 250);
}
if (guideBtn) guideBtn.addEventListener('click', openGuide);
if (guideCloseBtn) guideCloseBtn.addEventListener('click', closeGuide);
if (guideOverlay) guideOverlay.addEventListener('click', e => { if (e.target === guideOverlay) closeGuide(); });

/* ============================================================
   SIDEBAR & PANEL
   ============================================================ */
function closePanel() {
  ctrlWrap?.classList.remove('open');
  setAria(ctrlToggleBtn, 'aria-expanded', 'false');
}
function openSidebar() {
  closePanel();
  if (!sidebar) return;
  sidebar.style.willChange = 'transform';
  sidebar.classList.add('open');
  overlay?.classList.add('visible');
  requestAnimationFrame(() => overlay?.classList.add('active'));
}

function closeSidebar() {
  if (!sidebar) return;
  sidebar.classList.remove('open');

  overlay?.classList.remove('active');
  setTimeout(() => overlay?.classList.remove('visible'), 300);

  sidebar.addEventListener('transitionend', () => {
    if (!sidebar.classList.contains('open')) sidebar.style.willChange = '';
  }, { once: true });
}

on(sidebarBtn, 'click', openSidebar);
on(sidebarClose, 'click', closeSidebar);
on(overlay, 'click', closeSidebar);

on(ctrlToggleBtn, 'click', () => {
  const willOpen = !ctrlWrap?.classList.contains('open');
  if (willOpen) closeSidebar();
  ctrlWrap?.classList.toggle('open');
  setAria(ctrlToggleBtn, 'aria-expanded', willOpen ? 'true' : 'false');
});

/* View mode */
const viewModeBtn = $('view-mode-btn');
if (viewModeBtn) {
  viewModeBtn.addEventListener('click', () => {
    const next = viewModeBtn.dataset.mode === 'multi' ? 'single' : 'multi';
    viewModeBtn.dataset.mode = next;
    if (grid) grid.classList.toggle('stack', next === 'single');
    viewModeBtn.innerHTML = next === 'single'
      ? '<i class="vi">‚ñ§</i> Single'
      : '<i class="vi">‚äû</i> Multi';
    adjustRowColumns();
    saveViewPrefs();
    maybeRerenderIfModeChanged();
  });
}

/* Sliders */
const DEFAULTS = { fontSize: 16, lineHeight: 18 };
const fontSlider = $('font-size-slider'), fontVal = $('font-size-val');
const lineSlider = $('line-height-slider'), lineVal = $('line-height-val');

function updateFontSize(v) {
  const px = Number(v) || 16;
  document.documentElement.style.setProperty('--sutra-font-scale', String(px / 16));
  if (fontVal) fontVal.textContent = px + 'px';
}
function updateLineHeight(v) {
  const lh = ((Number(v) || 18) / 10).toFixed(1);
  document.documentElement.style.setProperty('--sutra-line-height', lh);
  if (lineVal) lineVal.textContent = lh;
}

on(fontSlider, 'input', () => updateFontSize(fontSlider.value));
on(lineSlider, 'input', () => updateLineHeight(lineSlider.value));

on($('reset-font'), 'click', () => {
  if (!fontSlider) return;
  fontSlider.value = DEFAULTS.fontSize;
  updateFontSize(DEFAULTS.fontSize);
});
on($('reset-line'), 'click', () => {
  if (!lineSlider) return;
  lineSlider.value = DEFAULTS.lineHeight;
  updateLineHeight(DEFAULTS.lineHeight);
});

if (fontSlider) updateFontSize(fontSlider.value);
if (lineSlider) updateLineHeight(lineSlider.value);


/* Full Width */
const fullwidthBtn = $('fullwidth-btn');
(function loadThemeLayoutPostInit() {
  try {
    const l = localStorage.getItem(KEY_LAYOUT);
    if (fullwidthBtn) fullwidthBtn.classList.toggle('active', l === 'layout-wide');
    const t = localStorage.getItem(KEY_THEME);
    if (themeIcon) themeIcon.textContent = (t === 'dark') ? '‚òÄ' : '‚òΩ';
  } catch (e) {}
})();
on(fullwidthBtn, 'click', () => {
  const html = document.documentElement;
  const isCard = html.classList.contains('layout-card');
  const next = isCard ? 'layout-wide' : 'layout-card';
  html.classList.remove('layout-card', 'layout-wide');
  html.classList.add(next);
  fullwidthBtn?.classList.toggle('active', next === 'layout-wide');
  try { localStorage.setItem(KEY_LAYOUT, next); } catch(e){}
});

/* Theme */
on(themeBtn, 'click', () => {
  const isDark = document.documentElement.dataset.theme === 'dark';
  const next = isDark ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
  if (themeIcon) themeIcon.textContent = isDark ? '‚òΩ' : '‚òÄ';
  try { localStorage.setItem(KEY_THEME, next); } catch(e){}
});

/* Scroll top */
on(scrollTopBtn, 'click', () => {
  readingScroll?.scrollTo({ top: 0, behavior: 'smooth' });
});

/* ============================================================
   HTML UTILS
   ============================================================ */
function escapeHtml(s) { return s == null ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function escapeAttr(v) { return v == null ? '' : String(v).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function safeDomId(b)  { return String(b).replace(/[^a-z0-9_-]/gi, '-'); }

/* ============================================================
   MENU BUILD ‚Äî titles follow uiLang
   ============================================================ */
function indexSectionMap(index) {
  SECTION_BY_SUTTA_ID.clear();
  META_BY_ID.clear();
  if (!Array.isArray(index)) return;

  for (const sec of index) {
    const walk = (children) => {
      if (!children) return;
      for (const ch of children) {
        if (ch?.type === 'sutta' && ch.id) {
          SECTION_BY_SUTTA_ID.set(ch.id, sec);
          META_BY_ID.set(ch.id, ch);
        } else if (ch?.type === 'group') {
          walk(ch.children);
        }
      }
    };
    walk(sec.children);
  }
}

function buildSutraMenuFromIndex() {
  const index = window.SUTRA_INDEX || [];
  FLAT_SUTTAS = [];
  indexSectionMap(index);

  if (!sutraMenuList) { NAV_ORDER = []; return; } // ‚úÖ guard

  if (!Array.isArray(index) || !index.length) {
    sutraMenuList.innerHTML = '<li>No index.</li>';
    NAV_ORDER = [];
    return;
  }

  let html = '';
  index.forEach(sec => {
    const secId = safeDomId('sec-' + sec.key);
    const secLabel = uiLang === 'vi'
      ? (sec.labelVi || sec.labelEn || sec.key)
      : (sec.labelEn || sec.labelVi || sec.key);

    html += `<li class="menu-block">
      <button type="button" class="menu-toggle" data-target="${escapeHtml(secId)}" aria-expanded="false">
        <span>${escapeHtml(secLabel)}</span><span class="chevron">‚ñ∏</span>
      </button>
      <div id="${escapeHtml(secId)}" class="menu-list collapsed">${buildMenuChildren(sec.children||[], secId)}</div>
    </li>`;
  });

  sutraMenuList.innerHTML = html;

  NAV_ORDER = Array.from(sutraMenuList.querySelectorAll('.menu-sutta-link'))
    .map(b => b.getAttribute('data-id'))
    .filter(Boolean);

  updatePrevNextUI();
}

function buildSuttaLinkHtml(s) {
  const pre = s.code ? (s.code + ' ‚Äì ') : '';
  const vi = s.titleVi||'', en = s.titleEn||'', pa = s.titlePali||'';

  let main, sub;
  if (uiLang === 'vi') {
    main = (pre + (vi || pa || en)).trim();
    sub  = pa ? pa.trim() : '';
  } else {
    main = (pre + (en || pa || vi)).trim();
    sub  = pa ? pa.trim() : '';
  }
  if (sub && main.includes(sub)) sub = '';

  // ‚úÖ store flatLower ƒë√∫ng t√™n field m√† applySearch d√πng
  const flatLower = `${main} ${sub} ${vi} ${en} ${pa}`.toLowerCase();
  FLAT_SUTTAS.push({ id: s.id, main, sub, flatLower });

  return `<button type="button" class="menu-sutta-link" data-id="${escapeAttr(s.id)}">
    <div class="sutra-label">
      <div class="sutra-label-main">${escapeHtml(main)}</div>
      ${sub ? `<div class="sutra-label-sub">${escapeHtml(sub)}</div>` : ''}
    </div></button>`;
}


function buildMenuChildren(children, parentId) {
  if (!children || !children.length) return '';
  let html = '';
  children.forEach(ch => {
    if (ch.type === 'group') {
      const gid = safeDomId(parentId + '-' + ch.key);
      const gLabel = uiLang === 'vi' ? (ch.labelVi || ch.labelEn || ch.key) : (ch.labelEn || ch.labelVi || ch.key);
      html += `<div class="menu-subblock">
        <button type="button" class="menu-toggle nested" data-target="${escapeHtml(gid)}" aria-expanded="false">
          <span>${escapeHtml(gLabel)}</span><span class="chevron">‚ñ∏</span>
        </button>
        <div id="${escapeHtml(gid)}" class="menu-list collapsed">${buildMenuChildren(ch.children||[], gid)}</div>
      </div>`;
    } else if (ch.type === 'sutta') {
      html += buildSuttaLinkHtml(ch);
    }
  });
  return html;
}

/* ============================================================
   SEARCH
   ============================================================ */
function debounce(fn, wait=250) { let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }

function highlightPartSafe(text, lq) {
  if (!text) return '';
  const idx = text.toLowerCase().indexOf(lq);
  if (idx===-1) return escapeHtml(text);
  return escapeHtml(text.slice(0,idx))+'<mark>'+escapeHtml(text.slice(idx,idx+lq.length))+'</mark>'+escapeHtml(text.slice(idx+lq.length));
}

function renderSearchResults(matches, q) {
  if (!searchResultsEl) return;
  if (!q) { searchResultsEl.innerHTML=''; return; }
  if (!matches.length) {
    searchResultsEl.innerHTML = '<div class="search-result-empty">'+ escapeHtml(uiLang==='vi'?'Kh√¥ng t√¨m th·∫•y.':'No results.') +'</div>';
    return;
  }
  const lq = q.toLowerCase();
  searchResultsEl.innerHTML = matches.map(m =>
    `<button type="button" class="search-result-item" data-id="${escapeAttr(m.id)}">
      <span class="search-main">${highlightPartSafe(m.main,lq)}</span>
      ${m.sub?`<span class="search-sub">${highlightPartSafe(m.sub,lq)}</span>`:''}
    </button>`
  ).join('');
}

function applySearch(q) {
  const t = (q||'').trim().toLowerCase();
  if (!t) { renderSearchResults([],''); return; }
  renderSearchResults(FLAT_SUTTAS.filter(i => i.flatLower.includes(t)), q);
}
if (searchInput) {
  searchInput.addEventListener('input', debounce(e => {
    const v = e.target.value.trim();

    if (v.length < 2) {
      renderSearchResults([], '');
      return;
    }
    applySearch(e.target.value);
  }, 200));
}

/* ============================================================
   DELEGATIONS ‚Äî aria-expanded fixed
   ============================================================ */
function initDelegations() {
  if (sutraMenuList && !sutraMenuList._del) {
    sutraMenuList.addEventListener('click', ev => {
      const btn = ev.target.closest('.menu-toggle');
      if (btn && sutraMenuList.contains(btn)) {
        ev.preventDefault();
        const panel = document.getElementById(btn.dataset.target);
        if (!panel) return;

        const wasCollapsed = panel.classList.contains('collapsed');
        const isNested = btn.classList.contains('nested');

        // collapse siblings if opening
        if (wasCollapsed) {
          const scope = isNested ? btn.closest('.menu-list') : sutraMenuList;
          const sel = isNested ? '.menu-toggle.nested' : '.menu-toggle:not(.nested)';
          if (scope) scope.querySelectorAll(sel).forEach(o => {
            if (o === btn) return;
            const op = document.getElementById(o.dataset.target);
            if (op && !op.classList.contains('collapsed')) {
              op.classList.add('collapsed');
              o.setAttribute('aria-expanded', 'false');
              const c = o.querySelector('.chevron'); if (c) c.textContent = '‚ñ∏';

              if (!isNested) op.querySelectorAll('.menu-toggle.nested').forEach(nb => {
                const np = document.getElementById(nb.dataset.target);
                if (np && !np.classList.contains('collapsed')) np.classList.add('collapsed');
                nb.setAttribute('aria-expanded', 'false');
                const c2 = nb.querySelector('.chevron'); if (c2) c2.textContent = '‚ñ∏';
              });
            }
          });
        }

        panel.classList.toggle('collapsed', !wasCollapsed);

        /* ‚úÖ aria-expanded set by current state (after toggle) */
        const isCollapsedNow = panel.classList.contains('collapsed');
        btn.setAttribute('aria-expanded', isCollapsedNow ? 'false' : 'true');

        const ch = btn.querySelector('.chevron');
        if (ch) ch.textContent = isCollapsedNow ? '‚ñ∏' : '‚ñæ';
        return;
      }

      const a = ev.target.closest('.menu-sutta-link');
      if (a && sutraMenuList.contains(a)) {
        ev.preventDefault();
        const id = a.getAttribute('data-id');
        if (id) {
          openSutra(id);
          closeSidebar();
          if (searchInput) searchInput.value='';
          if (searchResultsEl) searchResultsEl.innerHTML='';
        }
      }
    });
    sutraMenuList._del = true;
  }

  if (searchResultsEl && !searchResultsEl._del) {
    searchResultsEl.addEventListener('click', ev => {
      const btn = ev.target.closest('.search-result-item');
      if (btn) {
        const id = btn.getAttribute('data-id');
        if (id) {
          openSutra(id);
          closeSidebar();
          if (searchInput) searchInput.value='';
          searchResultsEl.innerHTML='';
        }
      }
    });
    searchResultsEl._del = true;
  }
}

/* ============================================================
   ROW CREATION & COLUMNS
   ============================================================ */
function getSingleVisibleLang() {
  const c = (showPali?1:0)+(showEng?1:0)+(showVie?1:0);
  if (c!==1) return null;
  return showPali?'pali':showEng?'eng':showVie?'vie':null;
}

function createRow(r) {
  const row = document.createElement('div');
  row.className = 'sutra-row';
  row.setAttribute('data-key', String(r.key||''));

  const singleLang = getSingleVisibleLang(); // 'pali'|'eng'|'vie'|null

  // SINGLE: book mode
  if (singleLang) {
    const col = document.createElement('div');
    col.className = 'sutra-col single-col';
    const inner = document.createElement('div');
    inner.className = singleLang === 'pali' ? 'pali' : singleLang === 'eng' ? 'eng' : 'vie';
    inner.textContent = r.text || '';
    col.appendChild(inner);
    row.appendChild(col);
    return row;
  }

  // MULTI
  const keyStr = formatSegmentKey(r.key || '');
  if (keyStr) {
    const keyEl = document.createElement('div');
    keyEl.className = 'row-key';
    keyEl.textContent = keyStr;
    row.appendChild(keyEl);
  }

  const colsWrap = document.createElement('div');
  colsWrap.className = 'row-cols';

  const labels = getColLabels();

  ['pali','eng','vie'].forEach(lang => {
    const col = document.createElement('div');
    col.className = `sutra-col ${lang === 'pali' ? 'pali-col' : lang === 'eng' ? 'eng-col' : 'vie-col'}`;

    const label = document.createElement('span');
    label.className = 'col-label';
    label.textContent = labels[lang];
    col.appendChild(label);

    const inner = document.createElement('div');
    inner.className = lang === 'pali' ? 'pali' : lang === 'eng' ? 'eng' : 'vie';
    inner.textContent = r[lang] || '';
    col.appendChild(inner);

    colsWrap.appendChild(col);
  });

  row.appendChild(colsWrap);
  return row;
}
const SEGKEY_CACHE = new Map();
const SEGKEY_MAX = 2000;
/* Format segment key: dn1:1.1 -> DN 1.1 */

function formatSegmentKey(key) {
  if (!key) return '';
  const s = String(key);

  if (SEGKEY_CACHE.has(s)) return SEGKEY_CACHE.get(s);

  const i = s.indexOf(':');
  const prefix = (i === -1 ? s : s.slice(0, i));
  let seg = (i === -1 ? '' : s.slice(i + 1));

  const m = prefix.match(/^([a-z]+)([\d.]+)$/i);

  let out = '';
  if (!m) out = (i === -1 ? s.toUpperCase() : `${prefix.toUpperCase()}.${seg}`);
  else {
    const coll = m[1].toUpperCase();
    const num  = m[2];
    const book = `${coll} ${num}`;

    if (!seg) out = book;
    else {
      if (seg.startsWith(num + '.')) seg = seg.slice((num + '.').length);
      out = (!seg) ? book : `${book}.${seg}`;
    }
  }

  SEGKEY_CACHE.set(s, out);
  if (SEGKEY_CACHE.size > SEGKEY_MAX) {
     const keys = Array.from(SEGKEY_CACHE.keys());
     for (let j = 0; j < keys.length >> 1; j++) SEGKEY_CACHE.delete(keys[j]);
  }
  return out;
}



/* ============================================================
   HELPERS
   ============================================================ */
function getByExactOrSuffix(map, ek, suf) {
  if (!map) return '';
  if (ek && map[ek]) return map[ek];
  if (!suf) return '';
  const keys = Object.keys(map);
  const k = keys.find(x => String(x).endsWith(suf));
  return k ? (map[k] || '') : '';
}
function isNumberedHeadingLine(t) { return /^\d+\.\s*/.test((t||'').trim()); }

function mergeRowsToParagraphRows(rows, lang) {
   const out = [];
  let buffer = '';
  let bufferKey = null;

  function flush() {
    const text = buffer.trim();
    if (!text) {
      buffer = '';
      bufferKey = null;
      return;
    }
    out.push({
      key: bufferKey || '',
      text   // ‚úÖ ch·ªâ 1 field
    });
    buffer = '';
    bufferKey = null;
  }

  for (const r of rows) {
    const raw = (r[lang] || '').trim();
    if (!raw) continue;

    if (isNumberedHeadingLine(raw)) {
      flush();
      out.push({
        key: r.key || '',
        text: raw
      });
      continue;
    }

    if (!buffer) {
      buffer = raw;
      bufferKey = r.key;
    } else {
      buffer += ' ' + raw;
    }
  }

  flush();
  return out;
}

function findMetaById(id) { return META_BY_ID.get(id) || null; }

/* ============================================================
   WELCOME / HEADER SHOW/HIDE
   ============================================================ */
function showWelcome() {
  if (welcomeEl)   welcomeEl.style.display = '';
  if (sutraHeader) sutraHeader.style.display = 'none';
  if (grid)        grid.style.display = 'none';
}
function hideWelcome() {
  if (welcomeEl)   welcomeEl.style.display = 'none';
  if (sutraHeader) sutraHeader.style.display = '';
  if (grid)        grid.style.display = '';
}

/* ============================================================
   SUTRA HEADER ‚Äî title follows uiLang
   ============================================================ */
function updateSutraHeader() {
  if (!currentSutraId || !currentMerged) return;

  const merged = currentMerged;
  const id = currentSutraId;
  const meta = findMetaById(id) || {};

  const titleBilVi = (getByExactOrSuffix(merged.vieMap, id+':0.2', ':0.2') || '').trim();
  const titleBilEn = (getByExactOrSuffix(merged.engMap, id+':0.2', ':0.2') || '').trim();
  const titleBilPa = (getByExactOrSuffix(merged.paliMap, id+':0.2', ':0.2') || '').trim();

  const viTitle = titleBilVi || meta.titleVi || '';
  const enTitle = titleBilEn || meta.titleEn || '';
  const paTitle = titleBilPa || meta.titlePali || '';

  const sec = SECTION_BY_SUTTA_ID.get(id);
  const secLabel = sec
    ? (uiLang === 'vi'
        ? (sec.labelVi || sec.labelEn || sec.key)
        : (sec.labelEn || sec.labelVi || sec.key))
    : '';

  const mainTitle = (uiLang === 'vi')
    ? (viTitle || enTitle || paTitle || id)
    : (enTitle || viTitle || paTitle || id);

  if (titleEl)    titleEl.textContent    = mainTitle;
  if (subtitleEl) subtitleEl.textContent = secLabel || '';
}

/* ============================================================
   Prev/Next ‚Äî uses NAV_ORDER (DOM order)
   ============================================================ */
function getPrevNextIds(id) {
  const order = (Array.isArray(NAV_ORDER) && NAV_ORDER.length)
    ? NAV_ORDER
    : FLAT_SUTTAS.map(x => x.id);

  const idx = order.indexOf(id);
  if (idx === -1) return { prev: null, next: null, idx: -1, total: order.length };

  return {
    prev: idx > 0 ? order[idx - 1] : null,
    next: idx < order.length - 1 ? order[idx + 1] : null,
    idx,
    total: order.length
  };
}

function updatePrevNextUI() {
  if (!navPrevBtn || !navNextBtn) return;

  if (!currentSutraId) {
    navPrevBtn.disabled = true;
    navNextBtn.disabled = true;
    navPrevBtn.dataset.id = '';
    navNextBtn.dataset.id = '';

    if (endNav) endNav.style.display = 'none';
    if (endPrev) endPrev.disabled = true;
    if (endNext) endNext.disabled = true;
 
    return;
  }

  const { prev, next } = getPrevNextIds(currentSutraId);

  navPrevBtn.disabled = !prev;
  navNextBtn.disabled = !next;
  navPrevBtn.dataset.id = prev || '';
  navNextBtn.dataset.id = next || '';

  // Footer nav
  if (endPrev) {
    endPrev.disabled = !prev;
    endPrev.dataset.id = prev || '';
  }
  if (endNext) {
    endNext.disabled = !next;
    endNext.dataset.id = next || '';
  }

}

if (navPrevBtn) navPrevBtn.addEventListener('click', () => {
  const id = navPrevBtn.dataset.id;
  if (id) openSutra(id);
});
if (navNextBtn) navNextBtn.addEventListener('click', () => {
  const id = navNextBtn.dataset.id;
  if (id) openSutra(id);
});
/* ============================================================
   PATCH: prevent stale ttsRowEls when render is budgeted + rapid switching
   - ttsRowEls is bound to current render (id + renderToken)
   - only commit when render finished AND token still current
   - ttsHighlight lazily refreshes if missing/stale, but guarded
   ============================================================ */

let ttsRowEls = [];
let ttsRowElsToken = 0;
let ttsRowElsSuttaId = null;

/** Clear rowEls whenever we start rendering a new sutta */
function ttsInvalidateRowEls() {
  ttsRowEls = [];
  ttsRowElsToken = 0;
  ttsRowElsSuttaId = null;
}

/** Commit rowEls only if render is still current */
function ttsCommitRowEls(expectedId, expectedToken) {
  // ‚úÖ must match current render
  if (expectedToken !== renderToken) return;
  if (expectedId !== currentSutraId) return;
  if (!grid) return;

  ttsRowEls = Array.from(grid.querySelectorAll('.sutra-row'));
  ttsRowElsToken = expectedToken;
  ttsRowElsSuttaId = expectedId;
}

/** Safe getter: lazily refresh but guarded */
function ttsEnsureRowEls() {
  if (!grid || !currentSutraId) return false;

  // already valid
  if (ttsRowElsToken === renderToken && ttsRowElsSuttaId === currentSutraId && ttsRowEls.length) {
    return true;
  }

  // only refresh if DOM likely ready enough
  // (still guarded: if render not finished, it will just be partial but won't be committed as "valid" until commit)
  ttsRowEls = Array.from(grid.querySelectorAll('.sutra-row'));
  return ttsRowEls.length > 0;
}

/* Replace your old refreshTtsRowEls with this (or keep name but same logic) */
function refreshTtsRowEls() {
  // do NOT commit here blindly
  ttsEnsureRowEls();
}

/* ============================================================
   RENDER SUTRA
   ============================================================ */
let _renderRafId = 0;
let _activeMenuLink = null;  // track to avoid querySelectorAll each time

async function renderSutra(id) {
  if (!id || !grid) return;

  // Cancel any in-flight render frame chain
  if (_renderRafId) { cancelAnimationFrame(_renderRafId); _renderRafId = 0; }

  const token = ++renderToken;
  currentSutraId = id;
  ttsInvalidateRowEls();
  try { localStorage.setItem(KEY_LAST, id); } catch(e){}

  ttsStop();
  hideWelcome();

  let merged = null;
  try { merged = await loadMerged(id); } catch(e){}
  if (token !== renderToken) return;

  if (!merged || !merged.rows || !merged.rows.length) {
    if (titleEl) titleEl.textContent = 'Data not found';
    if (subtitleEl) subtitleEl.textContent = id;
    grid.replaceChildren();
    currentMerged = null;
    currentViewRows = [];
    updatePrevNextUI();
    return;
  }

  currentMerged = merged;
  updateSutraHeader();
  updatePrevNextUI();

  // Track active menu link efficiently
  if (_activeMenuLink) _activeMenuLink.classList.remove('active');
  _activeMenuLink = sutraMenuList
    ? sutraMenuList.querySelector(`.menu-sutta-link[data-id="${cssEscape(id)}"]`)
    : null;
  if (_activeMenuLink) _activeMenuLink.classList.add('active');

  const rowsRaw = merged.rowsRaw || [];
  const singleLang = getSingleVisibleLang();
  lastSingleLangMode = singleLang;

  let rowsForView;
  if (singleLang) {
    const ck = id + '|' + singleLang;
    rowsForView = PARA_CACHE.get(ck);
    if (!rowsForView) {
      rowsForView = mergeRowsToParagraphRows(rowsRaw, singleLang);
      PARA_CACHE.set(ck, rowsForView);
    }
  } else {
    rowsForView = rowsRaw;
  }

  currentViewRows = rowsForView;
  grid.replaceChildren();

  // Apply visibility ONCE (removed redundant second call in renderBudget finish)
  applyVisibility();

  let i = 0;
  const total = rowsForView.length;

  function renderBudget() {
    if (token !== renderToken) return;

    const start = performance.now();
    const frag = document.createDocumentFragment();

    while (i < total && (performance.now() - start) < 8) {
      frag.appendChild(createRow(rowsForView[i]));
      i++;
    }
    grid.appendChild(frag);

    if (i < total) {
      _renderRafId = requestAnimationFrame(renderBudget);
    } else {
      _renderRafId = requestAnimationFrame(() => {
        restoreScrollPosition(id);
        updateScrollTopBtn();
		updateEndNavVisibility();
        ttsCommitRowEls(id, token);
      });
    }
  }

  renderBudget();
}

function openSutra(id) { renderSutra(id); }

/* ============================================================
   TTS
   ============================================================ */
let ttsState = { playing: false, paused: false, idx: -1, utterance: null, rows: [] };

function ttsGetLang() {
  if (uiLang === 'vi') return { lang: 'vi-VN', field: 'vie' };
  return { lang: 'en-US', field: 'eng' };
}

let scrollSaveTimer = null;
let isAutoScroll = false;

let _autoScrollTimer = null;
function markAutoScroll() {
  isAutoScroll = true;
  clearTimeout(_autoScrollTimer);
  _autoScrollTimer = setTimeout(() => { isAutoScroll = false; }, 120);
}

if (readingScroll) {
  readingScroll.addEventListener('scroll', () => {
  if (isAutoScroll) { updateScrollTopBtn(); return; }
  clearTimeout(scrollSaveTimer);
  scrollSaveTimer = setTimeout(saveScrollPosition, 300);
  updateScrollTopBtn();
  updateEndNavVisibility();
}, { passive: true });
}

function ttsHighlight(index) {
  if (!grid) return;

  const prev = grid.querySelector('.sutra-row.tts-reading');
  if (prev) prev.classList.remove('tts-reading');
  if (index < 0) return;

  if (!ttsEnsureRowEls()) return;
  if (index >= ttsRowEls.length) return;

  const el = ttsRowEls[index];
  if (!el) return;

  el.classList.add('tts-reading');
  if (!readingScroll) return;

  // ‚úÖ FIX: offsetTop c·ªßa row th∆∞·ªùng relative t·ªõi #sutraGrid ‚Üí c·∫ßn c·ªông gridOffset
  const gridOffset = grid.offsetTop - readingScroll.offsetTop; // an to√†n khi DOM thay ƒë·ªïi nh·∫π
  const targetTop = gridOffset + el.offsetTop;

  const top = targetTop - (readingScroll.clientHeight * 0.33);

  if (typeof markAutoScroll === 'function') markAutoScroll();
  readingScroll.scrollTop = Math.max(0, top);
}

function ttsSpeakRow(index) {
  if (!window.speechSynthesis) return;
  if (!ttsState.playing || index >= ttsState.rows.length) { ttsStop(); return; }
  ttsState.idx = index;
  ttsHighlight(index);

  const { lang, field } = ttsGetLang();
  let text = '';
  if (field in ttsState.rows[index]) {
    text = ttsState.rows[index][field] || '';
  } else {
    text = ttsState.rows[index].text || '';
  }
  text = text.trim();
  if (!text) { requestAnimationFrame(() => ttsSpeakRow(index + 1)); return; }

  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang; u.rate = 0.95; u.pitch = 1;
  ttsState.utterance = u;

  u.onend = () => { if (ttsState.playing) ttsSpeakRow(index + 1); };
  u.onerror = (e) => {
    if (e.error !== 'interrupted' && e.error !== 'canceled' && ttsState.playing) {
      ttsSpeakRow(index + 1);
    }
  };
  try { window.speechSynthesis.cancel(); } catch(e){}
  window.speechSynthesis.speak(u);
}

function ttsPlay() {
  if (!window.speechSynthesis) return;
  if (!currentSutraId || !grid) return;

  if (ttsState.paused && ttsState.playing) {
    ttsState.paused = false;
    window.speechSynthesis.resume();
    ttsPlayBtn?.classList.add('tts-active');
    if (ttsPlayIcon) ttsPlayIcon.textContent = '‚è∏';
    return;
  }

  ttsStop();

  const rows = Array.isArray(currentViewRows) ? currentViewRows : [];
  if (!rows.length) return;

  ttsState.playing = true;
  ttsState.paused = false;
  ttsState.rows = rows;

  ttsPlayBtn?.classList.add('tts-active');
  if (ttsPlayIcon) ttsPlayIcon.textContent = '‚è∏';
  ttsSpeakRow(0);
}

function ttsPause() {
  if (!ttsState.playing || !window.speechSynthesis) return;
  ttsState.paused = true;
  window.speechSynthesis.pause();
  ttsPlayBtn?.classList.remove('tts-active');
  if (ttsPlayIcon) ttsPlayIcon.textContent = '‚ñ∂';
}

function ttsStop() {
  ttsState.playing = false;
  ttsState.paused = false;
  ttsState.idx = -1;
  ttsState.utterance = null;
  ttsState.rows = [];
  try { window.speechSynthesis?.cancel(); } catch(e){}
  ttsHighlight(-1);
  ttsPlayBtn?.classList.remove('tts-active');
  if (ttsPlayIcon) ttsPlayIcon.textContent = '‚ñ∂';
}

on(ttsPlayBtn, 'click', () => {
  if (ttsState.playing && !ttsState.paused) ttsPause();
  else ttsPlay();
});
on(ttsStopBtn, 'click', ttsStop);
on(endPrev, 'click', () => {
  const id = endPrev?.dataset.id;
  if (id) openSutra(id);
});
on(endNext, 'click', () => {
  const id = endNext?.dataset.id;
  if (id) openSutra(id);
});

/* ============================================================
   INIT
   ============================================================ */
(function loadPersistedUiLang() {
  try {
    const saved = localStorage.getItem(KEY_UI_LANG);
    if (saved && (saved === 'en' || saved === 'vi')) uiLang = saved;
  } catch(e){}
})();

setUiLang(uiLang);
loadViewPrefs();
applyVisibility();
initDelegations();
updateScrollTopBtn();

(function() {
  try {
    const lastId = localStorage.getItem(KEY_LAST);
    if (lastId) { hideWelcome(); openSutra(lastId); }
    else showWelcome();
  } catch(e) { showWelcome(); }
})();
	(function initGuideReset(){
  const btn = document.getElementById('guide-reset-ui');
  if(!btn) return;

  btn.addEventListener('click', () => {
    try{
      localStorage.clear();        // xo√° to√†n b·ªô cache app
    }catch(e){}

    location.reload();             // reload v·ªÅ m·∫∑c ƒë·ªãnh
  });
})();
</script>
</body>
</html>
