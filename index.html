<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>NikƒÅya</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Noto+Serif+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap">
</head>
<style>

:root {
  --font-display: "Noto Serif", "Noto Serif", Georgia, serif;
  --font-body:    "Noto Serif", Georgia, "Times New Roman", serif;
  --font-pali:    "Noto Serif", Georgia, "Times New Roman", serif;

  --paper:        #fdf8f0;
  --paper-dark:   #f5ead5;
  --paper-darker: #ede0c4;
  --paper-edge:   #e0ccaa;

  --ink:          #2d1f0a;
  --ink-mid:      #4a3520;
  --ink-light:    #7a6040;
  --ink-faint:    #b8a88a;

  --gold:         #c9973a;
  --gold-light:   #e8c575;
  --gold-pale:    #f5e4b8;
  --gold-soft:    rgba(201,151,58,0.10);
  --gold-border:  rgba(201,151,58,0.35);

  --shadow-card:  0 24px 60px rgba(30,15,0,0.22), 0 4px 16px rgba(30,15,0,0.10);
  --shadow-panel: 0 16px 40px rgba(30,15,0,0.30), 0 2px 8px rgba(30,15,0,0.15);

  --pali-bg: transparent;
  --pali-fg: #1a0f00;
  --eng-bg:  transparent;
  --eng-fg:  #2d1f0a;
  --vie-bg:  transparent;
  --vie-fg:  #2a1800;

  --sutra-font-scale: 1;
  --sutra-line-height: 1.85;
  --visible-cols: 3;
}

* { box-sizing: border-box; }

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background-color: #2a1f10;
  background-image: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 28px,
    rgba(255,255,255,0.012) 28px,
    rgba(255,255,255,0.012) 29px
  );
  color: var(--ink);
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
.app {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: stretch;
  padding: 10px;
}

.card {
  background: var(--paper);
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E"),
    linear-gradient(160deg, #fdfaf3 0%, #fdf8f0 40%, #f9f2e4 100%);
  border-radius: 8px;
  border: 1px solid var(--paper-edge);
  box-shadow: var(--shadow-card);
  width: 100%;
  max-width: 980px;
  display: flex;
  flex-direction: column;
  padding: 0;
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg,
    transparent 0%, var(--gold) 15%, var(--gold-light) 50%, var(--gold) 85%, transparent 100%
  );
  z-index: 2;
}

.card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg,
    transparent, var(--gold) 20%, var(--gold-light) 50%, var(--gold) 80%, transparent
  );
  z-index: 2;
}

/* ============================================================
   TOP NOTE ‚Äî v·ªõi n√∫t Flag + Guide ·ªü g√≥c ph·∫£i (nh∆∞ h√¨nh)
   ============================================================ */
.top-note {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 6px 48px 6px 16px;
  background: linear-gradient(180deg, var(--paper-dark) 0%, var(--paper) 100%);
  border-bottom: 1px solid var(--paper-edge);
}

.top-note-text {
  font-size: 11px;
  font-style: normal;
  font-weight: 400;
  color: #a07830;
  letter-spacing: .18em;
  text-shadow: 0 1px 3px rgba(180,120,20,0.15);
  text-align: center;
  pointer-events: none;
  user-select: none;
}

/* Nh√≥m n√∫t ·ªü g√≥c tr√°i top-note (üìñ) */
.top-note-left {
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  gap: 2px;
}

/* Nh√≥m n√∫t ·ªü g√≥c ph·∫£i top-note (üè≥ ?) */
.top-note-actions {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  gap: 2px;
}

/* ============================================================
   HEADER
   ============================================================ */
.header {
  flex: 0 0 auto;
  padding: 14px 24px 10px;
  border-bottom: 1px solid var(--paper-edge);
  text-align: center;
  position: relative;
}

.header::before {
  content: '‚ù¶';
  display: block;
  font-size: 14px;
  color: var(--gold);
  line-height: 1;
  margin-bottom: 4px;
}

#title {
  margin: 0;
  font-family: var(--font-display);
  font-size: calc(0.95rem * var(--sutra-font-scale));
  font-weight: 600;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--ink);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#subtitle {
  margin-top: 2px;
  font-family: var(--font-body);
  font-size: calc(13px * var(--sutra-font-scale));
  font-style: italic;
  color: var(--ink-light);
  letter-spacing: .01em;
}

/* ============================================================
   GRID KINH
   ============================================================ */
#sutraGrid {
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 14px 18px 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  -webkit-overflow-scrolling: touch;
  background: var(--paper-dark);
}

#sutraGrid::-webkit-scrollbar { width: 7px; }
#sutraGrid::-webkit-scrollbar-track {
  background: var(--paper-dark);
  border-left: 1px solid var(--paper-edge);
}
#sutraGrid::-webkit-scrollbar-thumb {
  background: var(--gold-border);
  border-radius: 999px;
}
#sutraGrid::-webkit-scrollbar-thumb:hover { background: var(--gold); }

.sutra-row-wrap {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.sutra-seg-key {
  font-family: var(--font-body);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .08em;
  color: var(--ink-light);
  padding: 0 2px 4px 2px;
  user-select: none;
}

.sutra-row {
  display: grid;
  grid-template-columns: repeat(var(--visible-cols), 1fr);
  gap: 0;
  min-width: 0;
  background: var(--paper);
  border: 1px solid var(--paper-edge);
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 1px 4px rgba(30,15,0,0.06);
  transition: box-shadow .15s ease;
}

.sutra-row:hover { box-shadow: 0 2px 8px rgba(30,15,0,0.08); }
.sutra-row.reading { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(201,151,58,0.25); }

.sutra-col {
  min-width: 0;
  word-break: break-word;
  overflow-wrap: break-word;
  border-right: 1px solid var(--paper-edge);
  display: flex;
  flex-direction: column;
}
.sutra-col:last-child { border-right: none; }

.sutra-col-header {
  font-family: var(--font-body);
  font-size: 9.5px;
  font-weight: 700;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--ink-faint);
  padding: 7px 16px 5px;
  border-bottom: 1px solid var(--paper-edge);
  background: var(--paper-dark);
  user-select: none;
  flex-shrink: 0;
}

.sutra-col-body {
  padding: 12px 16px 14px;
  flex: 1;
}

.pali-col { background-color: var(--pali-bg); color: var(--pali-fg); }
.eng-col  { background-color: var(--eng-bg);  color: var(--eng-fg); }
.vie-col  { background-color: var(--vie-bg);  color: var(--vie-fg); }

.pali {
  font-family: var(--font-pali);
  font-size: calc(14px * var(--sutra-font-scale));
  font-weight: 400;
  color: #1a0f00;
  line-height: var(--sutra-line-height);
}
.eng {
  font-family: var(--font-body);
  font-size: calc(14px * var(--sutra-font-scale));
  font-weight: 400;
  color: #2d1f0a;
  line-height: var(--sutra-line-height);
}
.vie {
  font-family: var(--font-body);
  font-size: calc(14px * var(--sutra-font-scale));
  font-weight: 400;
  color: #2a1800;
  line-height: var(--sutra-line-height);
}

.hide-pali .pali-col { display: none; }
.hide-eng  .eng-col  { display: none; }
.hide-vie  .vie-col  { display: none; }

.card.stack .sutra-row { grid-template-columns: 1fr !important; }
.card.stack .sutra-col { border-right: none; border-bottom: 1px solid var(--paper-edge); }
.card.stack .sutra-col:last-child { border-bottom: none; }

#sutraGrid.hide-eng.hide-vie .sutra-seg-key,
#sutraGrid.hide-pali.hide-vie .sutra-seg-key,
#sutraGrid.hide-pali.hide-eng .sutra-seg-key,
#sutraGrid.hide-eng.hide-vie .sutra-col-header,
#sutraGrid.hide-pali.hide-vie .sutra-col-header,
#sutraGrid.hide-pali.hide-eng .sutra-col-header { display: none; }

#sutraGrid.hide-eng.hide-vie .sutra-row,
#sutraGrid.hide-pali.hide-vie .sutra-row,
#sutraGrid.hide-pali.hide-eng .sutra-row { grid-template-columns: 1fr !important; }

#sutraGrid.hide-eng.hide-vie .pali-col,
#sutraGrid.hide-pali.hide-vie .eng-col,
#sutraGrid.hide-pali.hide-eng .vie-col { width: 100%; border-right: none; }

#sutraGrid.hide-eng.hide-vie .pali,
#sutraGrid.hide-pali.hide-vie .eng,
#sutraGrid.hide-pali.hide-eng .vie { line-height: 1.95; }

@media (max-width: 500px) {
  .sutra-row { grid-template-columns: 1fr !important; }
  .sutra-col { border-right: none; border-bottom: 1px solid var(--paper-edge); }
  .sutra-col:last-child { border-bottom: none; }
  .card::before, .card::after { display: none; }
}

/* ============================================================
   BOTTOM CONTROLS ‚Äî ƒë∆°n gi·∫£n h√≥a: ch·ªâ ‚Üê üìñ ‚Üí (nh∆∞ h√¨nh)
   ============================================================ */
.bottom-controls{
  background: rgba(253, 248, 240, 0.55);          /* trong su·ªët */
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-top: 1px solid rgba(201,151,58,0.22);
}

/* b·ªè gradient c≈© n·∫øu c√≤n */
.bottom-controls::before{
  opacity: 0.6;
}

/* footer-nav g·ªçn l·∫°i + canh ƒë·ªÅu */
.footer-nav{
  padding: 8px 16px 8px;
  gap: 10px;
  background:transparent;
}

/* N√∫t footer d·ªÖ b·∫•m tr√™n mobile */
.footer-nav .btn-circle,
.footer-nav .btn-nav{
  width: 40px;
  height: 40px;
}

/* Ornament d∆∞·ªõi nav */
.footer-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 20px 8px;
  line-height: 1;
  user-select: none;
  pointer-events: none;
}
.footer-divider::before,
.footer-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg,
    transparent,
    rgba(180,140,60,0.2) 40%,
    rgba(180,140,60,0.2) 60%,
    transparent);
}
.footer-divider span {
  color: var(--gold);
  font-size: 10px;
  padding: 0 8px;
  opacity: .45;
}

/* N√∫t ƒëi·ªÅu h∆∞·ªõng ‚Üê ‚Üí */
.btn-nav {
  flex-shrink: 0;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: none;
  background: transparent;
  color: var(--ink-light);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  transition: 
    color .15s ease,
    background .15s ease,
    transform .08s ease,
    opacity .15s ease;
}
.btn-nav:disabled {
  opacity: .18;
  cursor: default;
}
.btn-nav:not(:disabled):hover {
  color: var(--paper);
  background: var(--gold);
  box-shadow: 0 2px 10px rgba(201,151,58,0.35);
}
.btn-nav:not(:disabled):active { transform: scale(0.88); }
.btn-nav:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

/* N√∫t tr√≤n chung (üìñ ‚öô üè≥ ? ‚Üë) */
.btn-circle {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  cursor: pointer;
  padding: 0;
  background: transparent;
  border: 1px solid transparent;
  border-radius: 6px;
  color: var(--ink-light);
  transition: background .1s, border-color .1s, transform .08s;
}
.btn-circle:hover {
  background: rgba(201,151,58,0.06);
  border-color: rgba(201,151,58,0.22);
}
.btn-circle:active { transform: scale(0.95); }
.btn-circle:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }
.btn-circle.active {
  background: var(--gold);
  color: var(--paper);
  border-color: var(--gold);
  box-shadow: 0 2px 8px rgba(201,151,58,0.4);
}

/* btn-flag (top-note) */
.btn-flag svg { width: 18px; height: 18px; display: block; }

/* Back to top ‚Äî overlay g√≥c d∆∞·ªõi ph·∫£i v√πng content */
#btnBackTop {
  position: absolute;
  bottom: 70px;
  right: 12px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid var(--gold-border);
  background: var(--paper);
  color: var(--ink-light);
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(30,15,0,0.15);
  z-index: 15;
  opacity: 0;
  transform: translateY(6px);
  pointer-events: none;
  transition: opacity .2s ease, transform .2s ease, background .1s, color .1s;
}
#btnBackTop.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
#btnBackTop:hover {
  background: var(--gold);
  color: var(--paper);
  border-color: var(--gold);
}
#btnBackTop:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

/* ============================================================
   PANELS
   ============================================================ */
.panel {
  position: absolute;
  left: 12px;
  bottom: 50px;
  min-width: 235px;
  max-width: 285px;
  max-height: 62vh;
  overflow: auto;
  background: var(--paper);
  background-image: linear-gradient(160deg, #fdfaf3 0%, var(--paper) 100%);
  border-radius: 6px;
  border: 1px solid var(--paper-edge);
  box-shadow: var(--shadow-panel), inset 0 0 0 1px rgba(201,151,58,0.08);
  padding: 10px 12px;
  font-size: 12px;
  font-family: var(--font-body);
  opacity: 0;
  transform: translateY(8px);
  pointer-events: none;
  z-index: 20;
  transition: opacity .2s ease, transform .2s ease;
  -webkit-overflow-scrolling: touch;
}
.panel.open { opacity: 1; transform: translateY(0); pointer-events: auto; }

#settingsPanel { 
  left: 21px; 
  right: auto;
}
#sutraMenuPanel {
  display: flex ;
  flex-direction: column ;
    /* full height inside card */
  top: 107px !important;
  bottom: 0 !important;
  left: 0 !important;
  right: auto !important;

  /* drawer width */
  width: min(380px, 86vw) !important;
  max-width: none !important;
  max-height: none !important;
  margin: 0 !important;

  /* look & feel */
  border-radius: 0 12px 12px 0;
  overflow: hidden;

  /* animation: off-canvas -> on-canvas */
  opacity: 0;
  transform: translateX(calc(-100% - 14px)); /* hide fully beyond left edge */
  pointer-events: none;

  /* make it above content */
  z-index: 60;

  /* smoother drawer */
  transition: transform .22s ease, opacity .18s ease;
}
#sutraMenuPanel.open{
   opacity: 1;
  transform: translateX(0);
  pointer-events: auto;
}

@media (max-width: 500px) {
  #sutraMenuPanel { left: 0; right: 0; max-width: none; border-radius: 0; }
}

.panel-title {
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--ink);
  margin-bottom: 6px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--gold-border);
}

.panel-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.panel-label {
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 500;
  color: var(--ink-mid);
  min-width: 62px;
}

/* =========================
   SETTINGS ‚Äî SECTIONED BOOK UI (MERGED, gi·ªØ nguy√™n values cu·ªëi)
   ========================= */
#settingsPanel.panel{
  max-width: 380px;
  border-radius: 10px;
  border: 1px solid rgba(201,151,58,0.28);
  box-shadow: 0 18px 48px rgba(30,15,0,.28), 0 2px 10px rgba(30,15,0,.14);
  background:
    radial-gradient(120% 120% at 30% 0%, rgba(201,151,58,.10), transparent 60%),
    linear-gradient(160deg, #fffaf1, var(--paper));
  width: min(330px, calc(100vw - 20px));
  padding: 10px 10px 8px;
}

#settingsPanel .panel-title{
  text-align: center;
  margin: 2px 0 10px;
  padding: 6px 8px 8px;
  border-bottom: 1px solid rgba(201,151,58,0.22);
  color: var(--ink);
  letter-spacing: .12em;
  font-size: 11px;
  font-weight: 800;
  text-transform: uppercase;
  position: relative;
}
#settingsPanel .panel-title::after{
  content: "‚ù¶";
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -9px;
  background: var(--paper);
  padding: 0 8px;
  color: var(--gold);
  opacity: .85;
  font-size: 12px;
}

#settingsPanel .set-sec{
  margin-top: 8px;
  padding: 8px 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(201,151,58,0.16);
  background: linear-gradient(180deg, rgba(253,248,240,.92), rgba(245,234,213,.55));
}
#settingsPanel .set-sec-hd{
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 10px;
  padding: 0 2px 8px;
}
#settingsPanel .set-sec-title{
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: rgba(45,31,10,.86);
}
#settingsPanel .set-sec-sub{
  font-size: 10.5px;
  color: rgba(122,96,64,.78);
  font-style: italic;
  text-align: right;
}

#settingsPanel .set-pills{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
#settingsPanel .pill{
  border-radius: 999px;
  border: 1px solid rgba(201,151,58,0.25);
  background: rgba(253,248,240,0.95);
  color: rgba(45,31,10,0.82);
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  cursor: pointer;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.65);
}
#settingsPanel .pill:hover{
  background: rgba(201,151,58,0.10);
  border-color: rgba(201,151,58,0.38);
}
#settingsPanel .pill.active,
#settingsPanel .pill[aria-pressed="true"]{
  background: linear-gradient(180deg, rgba(201,151,58,.92), rgba(184,135,46,.92));
  border-color: rgba(201,151,58,.9);
  color: var(--paper);
  box-shadow: 0 6px 18px rgba(201,151,58,.25);
}
#settingsPanel .pill-wide{
  text-transform: none;
  letter-spacing: .02em;
  font-weight: 800;
  padding: 6px 12px;
}

#settingsPanel .set-row{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
#settingsPanel .set-mini{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px dashed rgba(201,151,58,0.22);
  background: rgba(201,151,58,0.06);
}
#settingsPanel .set-mini-label{
  font-size: 12px;
  font-weight: 800;
  color: rgba(45,31,10,.78);
}
#settingsPanel .icon-btn{
  width: 34px;
  height: 28px;
  border-radius: 999px;
  border: 1px solid rgba(201,151,58,0.25);
  background: rgba(253,248,240,0.95);
  color: rgba(45,31,10,0.78);
  cursor: pointer;
}
#settingsPanel .icon-btn:hover{
  background: rgba(201,151,58,0.10);
  border-color: rgba(201,151,58,0.38);
}
#settingsPanel .icon-btn.active,
#settingsPanel .icon-btn[aria-pressed="true"]{
  background: linear-gradient(180deg, rgba(201,151,58,.92), rgba(184,135,46,.92));
  border-color: rgba(201,151,58,.9);
  color: var(--paper);
}

#settingsPanel .tts-bar{
  display: flex;
  gap: 6px;
  padding: 6px;
  border-radius: 10px;
  border: 1px dashed rgba(201,151,58,0.22);
  background: rgba(201,151,58,0.06);
}
#settingsPanel .tts-btn{
  width: 32px;
  height: 32px;
  padding: 0;
  border-radius: 8px;
  border: 1px solid rgba(201,151,58,0.25);
  background: rgba(253,248,240,0.95);
  color: rgba(45,31,10,0.78);
  cursor: pointer;
}
#settingsPanel .tts-btn:disabled{ opacity: .35; cursor: default; }
#settingsPanel .tts-btn:not(:disabled):hover{ background: rgba(201,151,58,0.12); }

#settingsPanel .set-note{
  margin-top: 6px;
  padding-left: 2px;
  color: rgba(122,96,64,.78);
  font-size: 10.5px;
  line-height: 1.45;
}

#settingsPanel .slider-row{
  margin-top: 8px;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid rgba(201,151,58,0.16);
  background: rgba(253,248,240,0.8);
}
#settingsPanel .slider-label-row{ margin-bottom: 4px; }
#settingsPanel .slider-value-badge{
  font-size: 11px;
  padding: 1px 6px;
}
#settingsPanel .slider-reset-btn{
  border-radius: 10px !important;
  width: 24px !important;
  height: 24px !important;
  border: 1px solid rgba(201,151,58,0.22) !important;
  background: rgba(253,248,240,0.95) !important;
}

/* Mobile: lu√¥n 1 c·ªôt -> ·∫©n n√∫t ch·ªçn layout (3 c·ªôt / x·∫øp d·ªçc) */
@media (max-width: 500px) {
  #btnLayout { display: none !important; }
  #settingsLayoutLabel { display: none !important; }
  #layoutRow { display: none !important; }
}

/* ============================================================
   MENU ACCORDION
   ============================================================ */
.menu-block > .menu-toggle,
.menu-toggle.nested,
.menu-subblock .chapter-toggle,
.menu-sutta-link,
.sutra-label-main,
.sutra-label-sub { font-family: var(--font-body); }

#sutraMenuPanel .search-box,
#sutraMenuPanel .search-results { flex: 0 0 auto; }

.search-box { margin-top: 4px; margin-bottom: 4px; }

#sutraSearch {
  width: 100%;
  padding: 5px 10px;
  font-family: var(--font-body);
  font-size: 13px;
  border-radius: 4px;
  border: 1px solid var(--paper-edge);
  background: var(--paper-dark);
  color: var(--ink);
  outline: none;
  transition: border-color .15s, box-shadow .15s;
}
#sutraSearch:focus {
  border-color: var(--gold);
  background: var(--paper);
  box-shadow: 0 0 0 2px var(--gold-soft);
}
#sutraSearch::placeholder { color: var(--ink-faint); font-style: italic; }

#sutraMenuPanel .sutra-list {
  list-style: none;
  margin: 4px 0 0;
  padding: 0;
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  position: relative;
  border-top: 1px solid var(--paper-edge);
}
#sutraMenuPanel .sutra-list::-webkit-scrollbar { width: 5px; }
#sutraMenuPanel .sutra-list::-webkit-scrollbar-track { background: transparent; }
#sutraMenuPanel .sutra-list::-webkit-scrollbar-thumb { background: var(--gold-border); border-radius: 999px; }

.menu-block { padding: 3px 0; border-bottom: 1px solid var(--paper-edge); }
.menu-block:last-child { border-bottom: none; }

.menu-block > .menu-toggle:not(.nested) {
  position: relative;
  width: 100%;
  background: transparent;
  border: none;
  border-radius: 0;
  text-align: left;
  cursor: pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 7px 52px 7px 10px;
  font-family: var(--font-body);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--ink-mid);
  line-height: 1.4;
}
.menu-block > .menu-toggle:not(.nested):hover {
  background: var(--gold-soft);
  color: var(--ink);
}

.menu-block > .menu-toggle:focus-visible,
.menu-sutta-link:focus-visible {
  outline: 2px solid var(--gold);
  outline-offset: 2px;
}

.chevron { font-size: 10px; line-height: 1; opacity: 0.6; display: inline-block; }
.menu-block > .menu-toggle:not(.nested) .chevron {
  position: absolute;
  right: 12px; top: 50%;
  transform: translateY(-50%);
}

.menu-toggle.nested {
  width: 100%;
  background: transparent;
  border: none;
  border-radius: 0;
  text-align: left;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  padding: 6px 40px 6px 18px;
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 500;
  color: var(--ink-mid);
  border-bottom: 1px dashed rgba(180,140,60,0.2);
}
.menu-toggle.nested:last-child { border-bottom: none; }
.menu-toggle.nested:hover { background: var(--gold-soft); }
.menu-toggle.nested::before {
  content: '‚ñ∏';
  position: absolute;
  left: 5px; top: 50%;
  transform: translateY(-50%);
  font-size: 9px;
  color: var(--gold);
  opacity: 0.8;
}
.menu-toggle.nested[aria-expanded="true"]::before { content: '‚ñæ'; }
.menu-toggle.nested .chevron { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); }

.menu-subblock { margin: 2px 0; padding-left: 20px; }
.menu-subblock .chapter-toggle {
  font-family: var(--font-body);
  font-size: 12.5px;
  color: var(--ink-light);
  padding: 3px 0 3px 14px;
  position: relative;
}
.menu-subblock .chapter-toggle::before {
  content: '‚Äî';
  position: absolute;
  left: 0; top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  color: var(--gold);
  opacity: 0.7;
}

.menu-list { margin-left: 0; padding-left: 0; margin-bottom: 2px; }
.menu-list.collapsed { display: none; }

.menu-nikaya-sticky {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--paper-dark);
  background-image: linear-gradient(180deg, var(--paper-darker) 0%, var(--paper-dark) 100%);
  border-bottom: 1px solid var(--gold-border);
  border-top: 1px solid var(--gold-border);
  padding: 6px 10px 6px 12px;
  font-family: var(--font-body);
  font-size: 11.5px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--ink-mid);
  display: flex;
  align-items: center;
  gap: 7px;
  pointer-events: none;
  user-select: none;
}
.menu-nikaya-sticky::before {
  content: '‚ùß';
  font-size: 11px;
  color: var(--gold);
  opacity: 0.8;
  flex-shrink: 0;
}



.menu-sutta-link {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 1px;
  padding: 5px 6px 5px 30px;
  margin-bottom: 1px;
  border-radius: 3px;
  cursor: pointer;
  text-decoration: none;
  background: transparent;
  color: var(--ink);
  border-bottom: 1px dashed rgba(180,140,60,0.15);
  transition: background .1s;
}
.menu-sutta-link:last-child { border-bottom: none; }
.menu-sutta-link::before {
  content: '‚Ä¢';
  position: absolute;
  left: 14px; top: 8px;
  font-size: 9px;
  color: var(--gold);
  opacity: 0.7;
}
.menu-sutta-link:hover { background: var(--gold-soft); }
.menu-sutta-link.active { background: var(--gold); border-color: transparent; }
.menu-sutta-link.active::before { color: var(--paper); opacity: 1; }

.sutra-label { display: flex; flex-direction: column; line-height: 1.35; }
.sutra-label-main { font-family: var(--font-body); font-size: 13px; font-weight: 600; color: var(--ink); }
.sutra-label-sub  { font-family: var(--font-body); font-size: 12px; font-style: italic; color: var(--ink-light); }
.menu-sutta-link.active .sutra-label-main { color: var(--paper); }
.menu-sutta-link.active .sutra-label-sub  { color: rgba(253,248,240,0.85); }

/* ============================================================
   SEARCH RESULTS
   ============================================================ */
.search-results {
  margin-top: 5px;
  margin-bottom: 6px;
  padding: 0;
  max-height: 220px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}
.search-results:empty { display: none; }

.search-result-item {
  width: 100%;
  text-align: left;
  border: none;
  background: transparent;
  border-radius: 0;
  padding: 6px 4px;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 1px;
  cursor: pointer;
  color: var(--ink);
  font-family: var(--font-body);
  font-size: 13px;
  line-height: 1.4;
  border-bottom: 1px dashed rgba(180,140,60,0.15);
}
.search-result-item:hover { background: var(--gold-soft); }

.search-result-item mark {
  background: var(--gold-pale);
  padding: 0 2px;
  border-radius: 2px;
  font-weight: 600;
  color: var(--ink);
}
.search-result-empty {
  padding: 5px 2px;
  font-family: var(--font-body);
  font-size: 13px;
  font-style: italic;
  color: var(--ink-faint);
}
.search-result-item .sr-main { font-weight: 600; font-size: 13px; }
.search-result-item .sr-sub  { font-size: 12px; opacity: .7; font-style: italic; }

/* ============================================================
   GUIDE OVERLAY
   ============================================================ */
#guideOverlay {
  position: fixed;
  inset: 0;
  background: rgba(20,10,0,0.65);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
#guideOverlay.show { display: flex; }

.guide-dialog {
  background: var(--paper);
  background-image: linear-gradient(160deg, #fdfaf3, var(--paper));
  border-radius: 8px;
  border: 1px solid var(--paper-edge);
  box-shadow: var(--shadow-panel), inset 0 0 0 3px rgba(201,151,58,0.08);
  padding: 16px 18px;
  max-width: 370px;
  width: 92%;
  max-height: 78vh;
  overflow-y: auto;
  font-family: var(--font-body);
  font-size: 15px;
  font-weight: 400;
  color: var(--ink);
  position: relative;
}
.guide-dialog::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  border-radius: 8px 8px 0 0;
}
.guide-dialog h2 {
  font-family: var(--font-body);
  font-size: 15px;
  font-weight: 700;
  letter-spacing: .06em;
  text-transform: uppercase;
  text-align: center;
  color: var(--ink);
  margin-bottom: 10px;
}
.guide-dialog button {
  margin-top: 12px;
  float: right;
  border-radius: 4px;
  border: 1px solid var(--gold-border);
  background: var(--paper-dark);
  padding: 4px 16px;
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--ink-mid);
  cursor: pointer;
}
.guide-dialog button:hover { background: var(--gold-pale); }
.guide-dialog em { display: block; font-size: 13.5px; color: var(--ink-light); font-style: italic; margin-top: 2px; }
.guide-dialog ul { padding-left: 20px; line-height: 1.65; }
.guide-dialog li { margin-bottom: 8px; font-size: 14.5px; }
.guide-dialog li::marker { color: var(--gold); font-size: 14px; }

/* ============================================================
   WELCOME SCREEN
   ============================================================ */
.welcome-screen {
  width: 100%;
  display: flex;
  justify-content: center;
  padding-top: 28px;
}
.welcome-box {
  max-width: 540px;
  width: 100%;
  padding: 18px 20px;
  font-family: var(--font-body);
  font-size: 14px;
  line-height: 1.75;
  color: var(--ink-light);
  border: 1px solid var(--gold-border);
  border-radius: 6px;
  background: linear-gradient(160deg, #fdfaf3, var(--paper));
  text-align: left;
  position: relative;
}
.welcome-box::before {
  content: '‚ù¶';
  position: absolute;
  top: -11px; left: 50%;
  transform: translateX(-50%);
  background: var(--paper);
  padding: 0 8px;
  font-size: 16px;
  color: var(--gold);
}

/* ============================================================
   SLIDERS
   ============================================================ */
.slider-row {
  margin-bottom: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.slider-label-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
}
.slider-value-badge {
  font-family: var(--font-body);
  font-size: 11.5px;
  font-weight: 600;
  color: var(--gold);
  background: var(--gold-soft);
  border: 1px solid var(--gold-border);
  border-radius: 4px;
  padding: 1px 6px;
  min-width: 38px;
  text-align: center;
  letter-spacing: .02em;
  flex-shrink: 0;
}
.slider-track-wrap {
  display: flex;
  align-items: center;
  gap: 5px;
}
.slider-icon {
  font-family: var(--font-body);
  color: var(--ink-faint);
  user-select: none;
  flex-shrink: 0;
  line-height: 1;
}
.slider-icon:first-child { font-size: 10px; }
.slider-icon-lg { font-size: 16px; }

.sutra-slider {
  -webkit-appearance: none;
  appearance: none;
  flex: 1;
  height: 4px;
  border-radius: 999px;
  background: linear-gradient(to right,
    var(--gold) 0%,
    var(--gold) var(--slider-pct, 25%),
    var(--paper-darker) var(--slider-pct, 25%),
    var(--paper-darker) 100%
  );
  outline: none;
  cursor: pointer;
  border: none;
}
.sutra-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--gold);
  border: 2px solid var(--paper);
  box-shadow: 0 1px 4px rgba(30,15,0,0.25);
  cursor: pointer;
}
.sutra-slider::-webkit-slider-thumb:hover { background: #b8872e; transform: scale(1.15); }
.sutra-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--gold);
  border: 2px solid var(--paper);
  box-shadow: 0 1px 4px rgba(30,15,0,0.25);
  cursor: pointer;
}
.sutra-slider::-moz-range-track { height: 4px; border-radius: 999px; background: var(--paper-darker); }
.sutra-slider:focus-visible { outline: 2px solid var(--gold); outline-offset: 3px; }

.slider-reset-btn {
  background: transparent !important;
  border: 1px solid var(--paper-edge) !important;
  color: var(--ink-faint) !important;
  font-size: 13px !important;
  width: 22px !important;
  height: 22px !important;
  padding: 0 !important;
  border-radius: 4px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer;
  flex-shrink: 0;
  box-shadow: none !important;
  min-width: unset !important;
  transition: color .1s, border-color .1s, transform .15s !important;
}
.slider-reset-btn:hover {
  color: var(--gold) !important;
  border-color: var(--gold-border) !important;
  transform: rotate(-40deg) !important;
}

/* ============================================================
   FULL WIDTH
   ============================================================ */
.layout-wide .app { padding: 0; }
.layout-wide .card { max-width: none; width: 100%; height: 100%; border-radius: 0; }

/* ============================================================
   TTS NOTE
   ============================================================ */
#settingsTtsNote {
  font-family: var(--font-body);
  font-size: 11px;
  font-style: italic;
  color: var(--ink-faint);
  margin-top: 2px;
  line-height: 1.5;
}

/* ============================================================
   ACCESSIBILITY + MENU BTN HIT AREA
   ============================================================ */
*, button, a, input, label { -webkit-tap-highlight-color: transparent; }
button:not(:focus-visible),
.menu-toggle:not(:focus-visible),
.menu-sutta-link:not(:focus-visible),
.btn-circle:not(:focus-visible) { outline: none; }

.menu-btn .menuIcon{
  width: 18px;
  height: 18px;
  stroke: currentColor;
  stroke-width: 1.8;
  stroke-linecap: round;
  stroke-linejoin: round;
  transition: transform .18s ease;
}

/* m·ªü menu => 3 ngang th√†nh 3 d·ªçc (xoay 90deg) */
#sidebar-btn{
  position: absolute;
  left: 0;
  bottom: 39px;              /* cao h∆°n 1 ch√∫t ƒë·ªÉ kh√¥ng ƒë·ª•ng n·ªôi dung */
  z-index: 150;

  width: 19px;               /* üëà m·ªèng l·∫°i */
  height: 100px;             /* üëà ng·∫Øn l·∫°i */

  border-radius: 0 8px 8px 0;
  border: 1px solid var(--panel-border);
  border-left: none;

  background: var(--panel-toggle-bg);
  color: var(--fab-color);
  cursor: pointer;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;

  padding: 8px 4px;

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  box-shadow: 2px 0 8px rgba(44,31,14,0.05);

  opacity: 0.9;
  transition: all var(--transition);
}

#sidebar-btn:hover{
  background: var(--panel-toggle-hover-bg);
  box-shadow: 3px 0 12px rgba(44,31,14,0.08);
}

/* Arrow */
#sidebar-btn .sidebar-arrow{
 position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  line-height: 1;
  opacity: .7;
}

/* Rotated text */
#sidebar-btn .sidebar-label{
  position: absolute;
  bottom: 39px;
 
  font-family: 'Cinzel', serif;
  font-size: 0.62em;        /* üëà nh·ªè l·∫°i */
  letter-spacing: 0.18em;
  text-transform: uppercase;
  font-weight: 500;   
  transform: rotate(-90deg);
  line-height: 1;
  white-space: nowrap;
}

/* ============================================================
   SUTRA MENU PANEL ‚Äî LEFT DRAWER (FORCE OVERRIDE)
   ============================================================ */




</style>
<body>

<div class="app">
  <div class="card" id="card">

    <!-- TOP NOTE ‚Äî NAMO ·ªü gi·ªØa, üè≥ + ? ·ªü g√≥c ph·∫£i (nh∆∞ h√¨nh) -->
    <div class="top-note" role="note">
     
      <span class="top-note-text">NAMO TASSA BHAGAVATO ARAHATO SAMMƒÄSAMBUDDHASSA</span>
      <div class="top-note-actions">
        <button id="btnUiLang" class="btn-circle btn-flag" aria-label="ƒê·ªïi ng√¥n ng·ªØ giao di·ªán"></button>
        <button id="btnGuide" class="btn-circle" aria-label="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
               stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.4-.9 2-1.6 2.4-.7.4-1.1.7-1.1 1.6v.4"></path>
            <path d="M12 16.2h.01"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- HEADER -->
    <div class="header" role="banner">
      <h1 id="title">Ch∆∞a ch·ªçn b√†i</h1>
      <div id="subtitle" aria-live="polite">‚Äî</div>
    </div>

    <!-- N·ªòI DUNG KINH -->
    <div id="sutraGrid" role="main" aria-live="polite" aria-busy="false"></div>
	<div style="display:flex; justify-content:space-between; padding: 8px 16px; border-top: 1px solid var(--paper-edge); background: var(--paper-dark);">
	  <button id="btnPrev" class="btn-nav" disabled aria-label="B√†i tr∆∞·ªõc">
		<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor"
			 stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
		  <polyline points="15 18 9 12 15 6"></polyline>
		</svg>
	  </button>
	  <button id="btnNext" class="btn-nav" disabled aria-label="B√†i ti·∫øp theo">
		<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor"
			 stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
		  <polyline points="9 18 15 12 9 6"></polyline>
		</svg>
	  </button>
	</div>
    <!-- BACK TO TOP ‚Äî overlay trong v√πng content, hi·ªán khi scroll -->
    <button id="btnBackTop" aria-label="L√™n ƒë·∫ßu trang">‚Üë</button>

    <!-- FOOTER ‚Äî ƒë∆°n gi·∫£n: ‚Üê üìñ ‚öô ‚Üí (nh∆∞ h√¨nh)
	

 <button id="btnSutraMenu" class="floating-menu-btn" aria-label="Menu">
  <span class="menu-icon">‚ò∞</span>
</button> -->
	<button type="button" id="sidebar-btn" title="Open sutta list">
          <span class="sidebar-label" data-i18n="btn-library">Library</span>
          <span class="sidebar-arrow">‚ñ∏</span>
        </button>
		   <!-- PANEL DANH M·ª§C KINH -->
    <div id="sutraMenuPanel" class="panel" role="dialog" aria-modal="false" aria-hidden="true" aria-label="Danh m·ª•c b√†i kinh">
      <div class="search-box">
        <input id="sutraSearch" type="search"
               placeholder="Nh·∫≠p t√™n b√†i kinh c·∫ßn t√¨m..."
               aria-label="T√¨m ki·∫øm b√†i kinh" autocomplete="off">
      </div>
      <div id="sutraSearchResults" class="search-results" role="listbox" aria-label="K·∫øt qu·∫£ t√¨m ki·∫øm"></div>
      <ul id="sutraMenuList" class="sutra-list" role="tree" aria-label="M·ª•c l·ª•c b√†i kinh"></ul>
	  
	   


        <button id="btnSettings" class="btn-circle"
                aria-label="C√†i ƒë·∫∑t hi·ªÉn th·ªã" aria-haspopup="true" aria-expanded="false">
          <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor"
               stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 3v2"></path><path d="M18.364 5.636 16.95 7.05"></path>
            <path d="M21 12h-2"></path><path d="M18.364 18.364 16.95 16.95"></path>
            <path d="M12 21v-2"></path><path d="M5.636 18.364 7.05 16.95"></path>
            <path d="M3 12h2"></path><path d="M5.636 5.636 7.05 7.05"></path>
          </svg>
        </button>

       
      </div>
	      <div id="settingsPanel" class="panel" role="dialog" aria-modal="false" aria-hidden="true" aria-label="C√†i ƒë·∫∑t hi·ªÉn th·ªã">
  <div class="panel-title" id="settingsTitle">C√†i ƒë·∫∑t hi·ªÉn th·ªã / Display settings</div>

  <!-- SECTION 1: LANGUAGE -->
  <section class="set-sec" aria-label="Ng√¥n ng·ªØ hi·ªÉn th·ªã">
    <div class="set-sec-hd">
      <div class="set-sec-title" id="settingsLangLabel">Ng√¥n ng·ªØ / Language</div>
    
    </div>

    <div class="set-pills" role="group" aria-label="Text languages">
      <button id="btnPali" class="pill active" aria-pressed="true">PLI</button>
      <button id="btnEng"  class="pill active" aria-pressed="true">EN</button>
      <button id="btnVie"  class="pill active" aria-pressed="true">VI</button>
    </div>
  </section>

  <!-- SECTION 2: LAYOUT -->
  <section class="set-sec" aria-label="B·ªë c·ª•c">
    <div class="set-sec-hd">
      <div class="set-sec-title" id="settingsLayoutLabel">B·ªë c·ª•c / Layout</div>
     
    </div>

    <div class="set-row">
      <button id="btnLayout" class="pill pill-wide" aria-pressed="false">3 c·ªôt / D·ªçc ‚Äì 3 Col / Stack</button>

      <div class="set-mini">
        <span class="set-mini-label" id="settingsFullWidthLabel">To√†n m√†n h√¨nh</span>
        <button id="btnFullWidth" type="button" class="icon-btn" aria-pressed="false" aria-label="Full width">‚§¢</button>
      </div>
    </div>
  </section>

  <!-- SECTION 3: TTS -->
  <section class="set-sec" aria-label="ƒê·ªçc kinh">
    <div class="set-sec-hd">
      <div class="set-sec-title" id="settingsTtsTitle">ƒê·ªçc kinh (TTS) / Text-to-speech</div>
      <div class="set-sec-sub" id="settingsTtsUiLabel">Theo ng√¥n ng·ªØ giao di·ªán / By UI language</div>
    </div>

    <div class="tts-bar" role="group" aria-label="TTS controls">
      <button id="btnReadTts" class="tts-btn" aria-label="B·∫Øt ƒë·∫ßu / ti·∫øp t·ª•c ƒë·ªçc">‚ñ∂</button>
      <button id="btnPauseTts" class="tts-btn" disabled aria-label="T·∫°m d·ª´ng">‚è∏</button>
      <button id="btnStopTts" class="tts-btn" disabled aria-label="D·ª´ng h·∫≥n">‚èπ</button>
    </div>

    <div id="settingsTtsNote" class="set-note">
      * TTS d√πng gi·ªçng c√≥ s·∫µn c·ªßa tr√¨nh duy·ªát, c√≥ th·ªÉ kh√°c nhau gi·ªØa thi·∫øt b·ªã.<br>
      * Uses browser built-in voices, quality may vary by device.
    </div>
  </section>

  <!-- SLIDERS -->
  <section class="set-sec" aria-label="C·ª° ch·ªØ v√† gi√£n d√≤ng">
  
    <!-- FONT SIZE SLIDER -->
    <div class="slider-row">
      <div class="slider-label-row">
        <span class="panel-label" id="settingsFontSizeLabel">C·ª° ch·ªØ / Font size</span>
        <span class="slider-value-badge" id="zoomValueBadge">100%</span>
      </div>
      <div class="slider-track-wrap">
        <span class="slider-icon" aria-hidden="true">A</span>
        <input type="range" id="sliderZoom" min="80" max="160" step="5" value="100"
               aria-label="C·ª° ch·ªØ" class="sutra-slider">
        <span class="slider-icon slider-icon-lg" aria-hidden="true">A</span>
        <button type="button" id="btnZoomReset" class="slider-reset-btn" aria-label="Reset" title="Reset">‚Ü∫</button>
      </div>
    </div>

    <!-- LINE HEIGHT SLIDER -->
    <div class="slider-row">
      <div class="slider-label-row">
        <span class="panel-label" id="settingsLineHeightLabel">Gi√£n d√≤ng / Line spacing</span>
        <span class="slider-value-badge" id="lineHeightValueBadge">1.85</span>
      </div>
      <div class="slider-track-wrap">
        <span class="slider-icon" aria-hidden="true" style="letter-spacing:-.5px;">‚â°</span>
        <input type="range" id="sliderLineHeight" min="130" max="260" step="5" value="185"
               aria-label="Gi√£n d√≤ng" class="sutra-slider">
        <span class="slider-icon" aria-hidden="true" style="letter-spacing:1.5px;">‚â°</span>
        <button type="button" id="btnLineHeightReset" class="slider-reset-btn" aria-label="Reset" title="Reset">‚Ü∫</button>
      </div>
    </div>
  </section>
</div>
    </div>
	
	
	
	 


    
</div>

<!-- GUIDE OVERLAY -->
<div id="guideOverlay" role="dialog" aria-modal="true" aria-label="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng">
  <div class="guide-dialog"></div>
</div>

<script src="toc.js"></script>

<script>
(function () {
  'use strict';

  const $ = (id) => document.getElementById(id);

  function escapeHtml(str) {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
  function escapeAttr(val) {
    if (val === undefined || val === null) return '';
    return String(val)
      .replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;')
      .replace(/</g, '&lt;').replace(/`/g, '&#96;').replace(/>/g, '&gt;');
  }
  function safeDomId(base) { return String(base).replace(/[^a-z0-9_-]/gi, '-'); }
  function debounce(fn, wait = 200) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }
  function throttle(fn, wait = 120) {
    let last = 0;
    return (...args) => { const now = Date.now(); if (now - last >= wait) { last = now; fn(...args); } };
  }

  // ‚îÄ‚îÄ Lazy load packs ‚îÄ‚îÄ
  const LOADED_PACKS = new Set();
  const PACK_PROMISES = new Map();

  function loadPackIfNeeded(pack) {
    if (!pack) return Promise.resolve();
    if (LOADED_PACKS.has(pack)) return Promise.resolve();
    if (PACK_PROMISES.has(pack)) return PACK_PROMISES.get(pack);
    const p = new Promise((res, rej) => {
      try {
        const s = document.createElement('script');
        s.src = pack + '.js'; s.async = true;
        s.onload = () => { LOADED_PACKS.add(pack); PACK_PROMISES.delete(pack); res(); };
        s.onerror = (e) => { PACK_PROMISES.delete(pack); rej(e); };
        document.body.appendChild(s);
      } catch (e) { PACK_PROMISES.delete(pack); rej(e); }
    });
    PACK_PROMISES.set(pack, p);
    return p;
  }

  // ‚îÄ‚îÄ Bilara loader ‚îÄ‚îÄ
  window.BILARA = window.BILARA || {};
  const BILARA_BASE_DIR = './sutta';

  function getBilaraPack(lang, id) {
    if (!id) return null;
    if (!/^[A-Za-z0-9_-]+$/.test(id)) return null;
    return `${BILARA_BASE_DIR}/${lang}/${id}`;
  }

  const MERGED_CACHE = new Map();
  const MERGED_PROMISES = new Map();
  const CACHE_ORDER = [];
  const MAX_CACHE_SUTTAS = 20;

  function touchCache(id) {
    const i = CACHE_ORDER.indexOf(id);
    if (i !== -1) CACHE_ORDER.splice(i, 1);
    CACHE_ORDER.push(id);
    while (CACHE_ORDER.length > MAX_CACHE_SUTTAS) {
      const old = CACHE_ORDER.shift();
      if (old) MERGED_CACHE.delete(old);
    }
  }

  function unionKeys3(a, b, c) {
    const set = new Set();
    if (a) Object.keys(a).forEach((k) => set.add(k));
    if (b) Object.keys(b).forEach((k) => set.add(k));
    if (c) Object.keys(c).forEach((k) => set.add(k));
    return Array.from(set);
  }

  function sortBilaraKeys(keys) {
    return keys.sort((x, y) => x.localeCompare(y, 'en', { numeric: true }));
  }

  async function loadMerged(id) {
    if (!id) return null;
    if (MERGED_CACHE.has(id)) return MERGED_CACHE.get(id);
    if (MERGED_PROMISES.has(id)) return MERGED_PROMISES.get(id);
    const p = (async () => {
      await Promise.all([
        loadPackIfNeeded(getBilaraPack('pli', id)),
        loadPackIfNeeded(getBilaraPack('en', id)),
        loadPackIfNeeded(getBilaraPack('vi', id)),
      ]);
      const entry = window.BILARA[id] || {};
      const paliMap = entry.pli || {};
      const engMap  = entry.en  || {};
      const vieMap  = entry.vi  || {};
      const keys = sortBilaraKeys(unionKeys3(paliMap, engMap, vieMap));
      const rows = keys.map((k) => ({ key: k, pali: paliMap[k]||'', eng: engMap[k]||'', vie: vieMap[k]||'' }));
      const merged = { paliMap, engMap, vieMap, keys, rows };
      MERGED_CACHE.set(id, merged);
      touchCache(id);
      MERGED_PROMISES.delete(id);
      return merged;
    })().catch((e) => { MERGED_PROMISES.delete(id); throw e; });
    MERGED_PROMISES.set(id, p);
    return p;
  }

  // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
  const card        = $('card');
  const titleEl     = $('title');
  const subtitleEl  = $('subtitle');
  const grid        = $('sutraGrid');

  const btnSutraMenu  = $('sidebar-btn');
  const btnSettings   = $('btnSettings');
  const btnGuide      = $('btnGuide');
  const btnBackTop    = $('btnBackTop');
  const btnUiLang     = $('btnUiLang');

  const settingsPanel  = $('settingsPanel');
  const sutraMenuPanel = $('sutraMenuPanel');
  const sutraMenuList  = $('sutraMenuList');
  const guideOverlay   = $('guideOverlay');
  const searchInput    = $('sutraSearch');
  const searchResultsEl = $('sutraSearchResults');

  const btnPali   = $('btnPali');
  const btnEng    = $('btnEng');
  const btnVie    = $('btnVie');
  const btnLayout = $('btnLayout');
  const btnReadTts  = $('btnReadTts');
  const btnPauseTts = $('btnPauseTts');
  const btnStopTts  = $('btnStopTts');
  const btnFullWidth = $('btnFullWidth');

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let currentSutraId = null;
  let SUTRA_ORDER = [];
  let FLAT_SUTTAS = [];
  let showPali = true, showEng = true, showVie = true;
  let isRendering = false;
  let renderToken = 0;
  let lastSingleLangMode = null;
  let cachedRows = [];

  const LANG_STORAGE_KEY = 'sutra_ui_lang';
  let uiLang = localStorage.getItem(LANG_STORAGE_KEY) === 'en' ? 'en' : 'vi';
  window.SUTRA_UI_LANG = uiLang;

  const KEY_LAST   = 'lastSutraId';
  const KEY_VIEW   = 'sutra_view_prefs';
  const KEY_ANCHOR_K = (id) => 'scroll_anchor_key_' + id;
  const KEY_ANCHOR_O = (id) => 'scroll_anchor_off_' + id;
  const WIDE_STORAGE_KEY = 'sutra_layout_wide';
  let isWide = localStorage.getItem(WIDE_STORAGE_KEY) === '1';

  // ‚îÄ‚îÄ Single-language helpers ‚îÄ‚îÄ
  function getSingleVisibleLang() {
    const count = (showPali?1:0) + (showEng?1:0) + (showVie?1:0);
    if (count !== 1) return null;
    if (showPali) return 'pali'; if (showEng) return 'eng'; if (showVie) return 'vie';
    return null;
  }

  function isNumberedHeadingLine(text) { return /^\d+\.\s*/.test((text||'').trim()); }

  function mergeRowsToParagraphRows(rows, lang) {
    const out = [];
    if (!Array.isArray(rows)||!rows.length) return out;
    let buf = '', bufKey = null;
    const flush = () => {
      const text = (buf||'').trim();
      if (!text) { buf=''; bufKey=null; return; }
      const r = { key: bufKey||'', pali:'', eng:'', vie:'' };
      if (lang==='pali') r.pali=text; if (lang==='eng') r.eng=text; if (lang==='vie') r.vie=text;
      out.push(r); buf=''; bufKey=null;
    };
    for (const r of rows) {
      const key = String(r.key||'');
      const raw = lang==='pali'?(r.pali||''):lang==='eng'?(r.eng||''):(r.vie||'');
      const t = (raw||'').trim();
      if (!t) continue;
      if (isNumberedHeadingLine(t)) {
        flush();
        const rr = { key, pali:'', eng:'', vie:'' };
        if (lang==='pali') rr.pali=t; if (lang==='eng') rr.eng=t; if (lang==='vie') rr.vie=t;
        out.push(rr); continue;
      }
      if (!buf) { buf=t; bufKey=key; } else buf+=' '+t;
    }
    flush(); return out;
  }

  function maybeRerenderIfModeChanged() {
    const mode = getSingleVisibleLang();
    if (mode !== lastSingleLangMode && currentSutraId) renderSutra(currentSutraId);
  }

  // ‚îÄ‚îÄ UI Language ‚îÄ‚îÄ
  const FLAG_VI = `<svg viewBox="0 0 48 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <rect width="48" height="32" fill="#da251d"/>
    <polygon fill="#ffde00" points="24,6 27.1,14.3 36,14.3 28.8,19.3 31.7,27 24,22.1 16.3,27 19.2,19.3 12,14.3 20.9,14.3"/>
  </svg>`;
  const FLAG_EN = `<svg viewBox="0 0 48 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <rect width="48" height="32" fill="#012169"/>
    <path d="M0 0 L20 13 H16 L0 3 Z M48 0 L28 13 H32 L48 3 Z M0 32 L20 19 H16 L0 29 Z M48 32 L28 19 H32 L48 29 Z" fill="#ffffff"/>
    <path d="M0 0 L20 13 H17 L0 2 Z M48 0 L28 13 H31 L48 2 Z M0 32 L20 19 H17 L0 30 Z M48 32 L28 19 H31 L48 30 Z" fill="#c8102e"/>
    <path d="M20 0 H28 V12 H48 V20 H28 V32 H20 V20 H0 V12 H20 Z" fill="#ffffff"/>
    <path d="M21.5 0 H26.5 V13.5 H48 V18.5 H26.5 V32 H21.5 V18.5 H0 V13.5 H21.5 Z" fill="#c8102e"/>
  </svg>`;

  function renderUiLangFlag() {
    if (!btnUiLang) return;
    btnUiLang.innerHTML = uiLang === 'en' ? FLAG_EN : FLAG_VI;
    btnUiLang.setAttribute('aria-label', uiLang === 'en'
      ? 'Interface: English ‚Äî click to switch to Vietnamese'
      : 'Giao di·ªán: Ti·∫øng Vi·ªát ‚Äî b·∫•m ƒë·ªÉ chuy·ªÉn sang English');
  }

  function applyUiLanguageToSearchUi() {
    if (!searchInput) return;
    searchInput.placeholder = uiLang === 'en' ? 'Search sutta...' : 'T√¨m b√†i kinh...';
  }

  function applyUiLanguageToSettingsPanel() {
    const isEn = uiLang === 'en';
    const setText = (id, text) => { const el=$(id); if(el) el.textContent=text; };
    setText('settingsTitle',      isEn ? 'Display settings'     : 'C√†i ƒë·∫∑t hi·ªÉn th·ªã');
    setText('settingsLangLabel',  isEn ? 'Sutta languages:'      : 'B·∫£n d·ªãch kinh:');
    setText('settingsLayoutLabel',isEn ? 'Layout:'              : 'B·ªë c·ª•c:');
    setText('settingsTtsTitle',   isEn ? 'Text-to-speech (TTS)' : 'ƒê·ªçc kinh (TTS)');
    setText('settingsTtsUiLabel', isEn ? 'By UI language:'      : 'Theo ng√¥n ng·ªØ giao di·ªán:');
    setText('settingsFontSizeLabel',   isEn ? 'Font size'    : 'C·ª° ch·ªØ');
    setText('settingsLineHeightLabel', isEn ? 'Line spacing' : 'Gi√£n d√≤ng');
    setText('settingsFullWidthLabel',  isEn ? 'Full width'   : 'To√†n m√†n h√¨nh');
    const note = $('settingsTtsNote');
    if (note) note.innerHTML = isEn
      ? '* Uses browser built-in voices, quality may vary by device.'
      : '* TTS d√πng gi·ªçng c√≥ s·∫µn c·ªßa tr√¨nh duy·ªát, c√≥ th·ªÉ kh√°c nhau gi·ªØa thi·∫øt b·ªã.';
    if (btnLayout) btnLayout.textContent = isEn ? '3 columns / Stacked' : '3 c·ªôt / X·∫øp d·ªçc';
    if (btnGuide) btnGuide.setAttribute('aria-label', isEn ? 'User guide' : 'H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng');
    if (btnSutraMenu) btnSutraMenu.setAttribute('aria-label', isEn ? 'Sutta Index' : 'Danh m·ª•c b√†i kinh');
    if (btnSettings) btnSettings.setAttribute('aria-label', isEn ? 'Display settings' : 'C√†i ƒë·∫∑t hi·ªÉn th·ªã');
    if (btnBackTop) btnBackTop.setAttribute('aria-label', isEn ? 'Back to top' : 'L√™n ƒë·∫ßu trang');
    if (btnPauseTts) btnPauseTts.setAttribute('aria-label',
      isEn ? 'Pause (current sentence will restart)' : 'T·∫°m d·ª´ng (c√¢u hi·ªán t·∫°i s·∫Ω ƒë·ªçc l·∫°i t·ª´ ƒë·∫ßu)');
  }

  function renderGuideDialog() {
    if (!guideOverlay) return;
    const dlg = guideOverlay.querySelector('.guide-dialog');
    if (!dlg) return;
    const isEn = uiLang === 'en';
    dlg.innerHTML = isEn
      ? `<h2>Quick guide</h2>
         <em>Short instructions on how to use the sutta reader.</em>
         <ul>
           <li>üìñ <strong>Sutta Index</strong>: open catalogue and choose a sutta.</li>
           <li>üîé <strong>Search</strong>: type name/ID/keyword to filter.</li>
           <li>‚öô <strong>Settings</strong>: toggle languages, layout, TTS, font size, full width.</li>
           <li>‚Üî <strong>Swipe left‚Äìright</strong> on the text to go to previous/next sutta.</li>
           <li>‚Üë <strong>Back to top</strong>: jump to top of sutta.</li>
           <li>‚è∏ <strong>TTS note</strong>: pause restarts the current sentence (browser limitation).</li>
         </ul>
         <button id="btnCloseGuide" type="button">Close</button>`
      : `<h2>H∆∞·ªõng d·∫´n nhanh</h2>
         <em>M·ªôt s·ªë h∆∞·ªõng d·∫´n c∆° b·∫£n ƒë·ªÉ b·∫°n s·ª≠ d·ª•ng trang ƒë·ªçc kinh.</em>
         <ul>
           <li>üìñ <strong>Danh m·ª•c b√†i kinh</strong>: m·ªü m·ª•c l·ª•c v√† ch·ªçn b√†i.</li>
           <li>üîé <strong>T√¨m ki·∫øm</strong>: g√µ t√™n/m√£/t·ª´ kh√≥a ƒë·ªÉ l·ªçc.</li>
           <li>‚öô <strong>C√†i ƒë·∫∑t</strong>: b·∫≠t/t·∫Øt ng√¥n ng·ªØ, b·ªë c·ª•c, TTS, c·ª° ch·ªØ, full width.</li>
           <li>‚Üî <strong>Vu·ªët ngang</strong> ƒë·ªÉ chuy·ªÉn b√†i tr∆∞·ªõc/sau.</li>
           <li>‚Üë <strong>L√™n ƒë·∫ßu</strong>: cu·ªôn v·ªÅ ƒë·∫ßu b√†i kinh.</li>
           <li>‚è∏ <strong>L∆∞u √Ω TTS</strong>: t·∫°m d·ª´ng s·∫Ω ƒë·ªçc l·∫°i t·ª´ ƒë·∫ßu c√¢u (gi·ªõi h·∫°n c·ªßa tr√¨nh duy·ªát).</li>
         </ul>
         <button id="btnCloseGuide" type="button">ƒê√≥ng</button>`;
    const btnClose = $('btnCloseGuide');
    if (btnClose) btnClose.onclick = closeGuide;
  }

  function openGuide() {
    if (!guideOverlay) return;
    renderGuideDialog();
    guideOverlay.classList.add('show');
    guideOverlay.setAttribute('aria-hidden','false');
    setTimeout(() => $('btnCloseGuide')?.focus(), 50);
  }
  function closeGuide() {
    if (!guideOverlay) return;
    guideOverlay.classList.remove('show');
    guideOverlay.setAttribute('aria-hidden','true');
    btnGuide && btnGuide.focus();
  }

  // ‚îÄ‚îÄ Panels ‚îÄ‚îÄ
  function updateMenuPanelTop() {
    if (!sutraMenuPanel || !card) return;
    // T√≠nh top = chi·ªÅu cao ph·∫ßn tr√™n header (top-note + header)
   
    const topNote = card.querySelector('.top-note');
    const topH = (topNote ? topNote.offsetHeight : 0) ;
    sutraMenuPanel.style.top = topH + 'px';
  }

  function togglePanel(panel, force) {
  window.__dbg = () => {
  console.log('menuPanel:', sutraMenuPanel, 'open?', sutraMenuPanel?.classList.contains('open'));
};
  if (!panel) return;
  const isOpen = typeof force==='boolean' ? force : !panel.classList.contains('open');
 // if (isOpen && panel === sutraMenuPanel) updateMenuPanelTop();

  panel.classList.toggle('open', isOpen);
  panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');

  if (panel === settingsPanel && btnSettings) btnSettings.setAttribute('aria-expanded', String(isOpen));
  if (panel === sutraMenuPanel && btnSutraMenu) {
    btnSutraMenu.setAttribute('aria-expanded', String(isOpen));
    btnSutraMenu.classList.toggle('is-open', isOpen);   // ‚úÖ th√™m d√≤ng n√†y
  }
}

  function closePanels() {
  togglePanel(settingsPanel,false);
  togglePanel(sutraMenuPanel,false);
  if (btnSutraMenu) btnSutraMenu.classList.remove('is-open');
}

  if (btnSettings) btnSettings.onclick = () => { togglePanel(sutraMenuPanel,false); togglePanel(settingsPanel); };
  if (btnSutraMenu) btnSutraMenu.onclick = () => {
  togglePanel(settingsPanel,false);
  togglePanel(sutraMenuPanel);
  btnSutraMenu.classList.toggle('is-open', sutraMenuPanel.classList.contains('open'));
};
  if (btnGuide && guideOverlay) btnGuide.onclick = openGuide;
  if (guideOverlay) guideOverlay.addEventListener('click', (e) => { if(e.target===guideOverlay) closeGuide(); });

  document.addEventListener('click', (e) => {
    const t = e.target;
    if (btnSettings?.contains(t)||btnSutraMenu?.contains(t)||
        settingsPanel?.contains(t)||sutraMenuPanel?.contains(t)) return;
    closePanels();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key==='Escape') { if(guideOverlay?.classList.contains('show')) return closeGuide(); closePanels(); }
  });

  // ‚îÄ‚îÄ View prefs ‚îÄ‚îÄ
  function saveViewPrefs() {
    try { localStorage.setItem(KEY_VIEW, JSON.stringify({ showPali, showEng, showVie, stack: card?.classList.contains('stack')||false })); } catch(e){}
  }
  function loadViewPrefs() {
    try {
      const raw = localStorage.getItem(KEY_VIEW);
      if (!raw) return;
      const v = JSON.parse(raw);
      if (typeof v.showPali==='boolean') showPali=v.showPali;
      if (typeof v.showEng==='boolean')  showEng=v.showEng;
      if (typeof v.showVie==='boolean')  showVie=v.showVie;
      if (card && typeof v.stack==='boolean') card.classList.toggle('stack', v.stack);
    } catch(e){}
  }

  function updateVisibleCols() {
    const isNarrow = window.innerWidth <= 500;
    const isStack  = card?.classList.contains('stack');
    let count = (showPali?1:0)+(showEng?1:0)+(showVie?1:0);
    count = Math.max(1, count);
    document.documentElement.style.setProperty('--visible-cols', isNarrow||isStack ? '1' : String(count));
  }

  function applyVisibility() {
    if (!grid) return;
    grid.classList.toggle('hide-pali', !showPali);
    grid.classList.toggle('hide-eng',  !showEng);
    grid.classList.toggle('hide-vie',  !showVie);
    updateVisibleCols();
  }

  window.addEventListener('resize', () => { updateVisibleCols(); updateMenuPanelTop(); });

  if (btnPali) btnPali.onclick = () => { showPali=!showPali; btnPali.classList.toggle('active',showPali); btnPali.setAttribute('aria-pressed',String(showPali)); applyVisibility(); saveViewPrefs(); maybeRerenderIfModeChanged(); };
  if (btnEng)  btnEng.onclick  = () => { showEng=!showEng;   btnEng.classList.toggle('active',showEng);   btnEng.setAttribute('aria-pressed',String(showEng));   applyVisibility(); saveViewPrefs(); maybeRerenderIfModeChanged(); };
  if (btnVie)  btnVie.onclick  = () => { showVie=!showVie;   btnVie.classList.toggle('active',showVie);   btnVie.setAttribute('aria-pressed',String(showVie));   applyVisibility(); saveViewPrefs(); maybeRerenderIfModeChanged(); };

  if (btnLayout) btnLayout.onclick = () => {
    if (card) card.classList.toggle('stack');
    const isStack = card?.classList.contains('stack');
    btnLayout.classList.toggle('active', isStack);
    btnLayout.setAttribute('aria-pressed', String(isStack));
    updateVisibleCols(); saveViewPrefs();
  };

  // ‚îÄ‚îÄ Full width ‚îÄ‚îÄ
  function applyWideLayout(on) {
    isWide = !!on;
    document.documentElement.classList.toggle('layout-wide', isWide);
    if (btnFullWidth) { btnFullWidth.classList.toggle('active', isWide); btnFullWidth.setAttribute('aria-pressed', String(isWide)); }
  }
  if (btnFullWidth) {
    applyWideLayout(isWide);
    btnFullWidth.addEventListener('click', () => { applyWideLayout(!isWide); localStorage.setItem(WIDE_STORAGE_KEY, isWide?'1':'0'); });
  }

  // ‚îÄ‚îÄ Zoom + Line height sliders ‚îÄ‚îÄ
  const ZOOM_STORAGE_KEY = 'sutra_zoom';
  const LH_STORAGE_KEY   = 'sutra_line_height';
  const MIN_ZOOM=0.8, MAX_ZOOM=1.6, MIN_LH=1.3, MAX_LH=2.6;
  let zoomLevel=1, lineHeightLevel=1.85;

  const sliderZoom       = $('sliderZoom');
  const sliderLineHeight = $('sliderLineHeight');
  const zoomBadge        = $('zoomValueBadge');
  const lhBadge          = $('lineHeightValueBadge');
  const btnZoomReset     = $('btnZoomReset');
  const btnLhReset       = $('btnLineHeightReset');

  function clampZoom(z) { return Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, z)); }
  function clampLh(v)   { return Math.max(MIN_LH,   Math.min(MAX_LH, v)); }

  function updateSliderFill(el, min, max, val) {
    if (!el) return;
    el.style.setProperty('--slider-pct', ((val-min)/(max-min)*100).toFixed(1)+'%');
  }

  function applyZoom() {
    document.documentElement.style.setProperty('--sutra-font-scale', String(zoomLevel));
    const pct = Math.round(zoomLevel*100);
    if (zoomBadge) zoomBadge.textContent = pct+'%';
    if (sliderZoom) { sliderZoom.value=String(pct); updateSliderFill(sliderZoom,80,160,pct); }
  }
  function applyLineHeight() {
    document.documentElement.style.setProperty('--sutra-line-height', String(lineHeightLevel));
    if (lhBadge) lhBadge.textContent = lineHeightLevel.toFixed(2);
    if (sliderLineHeight) { const val=Math.round(lineHeightLevel*100); sliderLineHeight.value=String(val); updateSliderFill(sliderLineHeight,130,260,val); }
  }

  function loadZoom() { const s=localStorage.getItem(ZOOM_STORAGE_KEY); if(s){const v=parseFloat(s);if(!Number.isNaN(v))zoomLevel=clampZoom(v);} applyZoom(); }
  function loadLineHeight() { const s=localStorage.getItem(LH_STORAGE_KEY); if(s){const v=parseFloat(s);if(!Number.isNaN(v))lineHeightLevel=clampLh(v);} applyLineHeight(); }
  function saveZoom() { localStorage.setItem(ZOOM_STORAGE_KEY, String(zoomLevel)); }
  function saveLineHeight() { localStorage.setItem(LH_STORAGE_KEY, String(lineHeightLevel)); }

  if (sliderZoom) sliderZoom.addEventListener('input', () => { zoomLevel=clampZoom(parseInt(sliderZoom.value,10)/100); applyZoom(); saveZoom(); });
  if (sliderLineHeight) sliderLineHeight.addEventListener('input', () => { lineHeightLevel=clampLh(parseInt(sliderLineHeight.value,10)/100); applyLineHeight(); saveLineHeight(); });
  if (btnZoomReset) btnZoomReset.onclick = () => { zoomLevel=1; applyZoom(); saveZoom(); };
  if (btnLhReset)   btnLhReset.onclick   = () => { lineHeightLevel=1.85; applyLineHeight(); saveLineHeight(); };

  // ‚îÄ‚îÄ Anchor scroll ‚îÄ‚îÄ
  let anchorObserver = null;
  let firstVisibleKey = null;
  let firstVisibleOffsetFromGrid = 0;

  function setupAnchorObserver() {
    if (anchorObserver) { anchorObserver.disconnect(); anchorObserver=null; }
    if (!grid) return;
    anchorObserver = new IntersectionObserver((entries) => {
      let topmost = null;
      for (const entry of entries) {
        if (!entry.isIntersecting) continue;
        if (!topmost || entry.boundingClientRect.top < topmost.boundingClientRect.top) topmost=entry;
      }
      if (topmost) {
        firstVisibleKey = topmost.target.getAttribute('data-key')||'';
        firstVisibleOffsetFromGrid = Math.max(0, topmost.target.getBoundingClientRect().top - grid.getBoundingClientRect().top);
      }
    }, { root: grid, rootMargin: '0px 0px -80% 0px', threshold: 0 });
    grid.querySelectorAll('.sutra-row').forEach((r) => anchorObserver.observe(r));
  }

  function saveScrollAnchorNow() {
    if (!currentSutraId) return;
    // N·∫øu ƒëang ·ªü top ‚Üí x√≥a anchor ƒë·ªÉ F5 kh√¥ng restore v·ªÅ v·ªã tr√≠ c≈©
    if (!grid || grid.scrollTop === 0) {
      try { localStorage.removeItem(KEY_ANCHOR_K(currentSutraId)); localStorage.removeItem(KEY_ANCHOR_O(currentSutraId)); } catch(e){}
      return;
    }
    if (!firstVisibleKey) return;
    try { localStorage.setItem(KEY_ANCHOR_K(currentSutraId),firstVisibleKey); localStorage.setItem(KEY_ANCHOR_O(currentSutraId),String(Math.round(firstVisibleOffsetFromGrid))); } catch(e){}
  }

  function restoreScrollByAnchor(id) {
    if (!grid) return false;
    try {
      const key = localStorage.getItem(KEY_ANCHOR_K(id));
      const offRaw = localStorage.getItem(KEY_ANCHOR_O(id));
      const off = offRaw ? parseInt(offRaw,10) : 0;
      if (!key) return false;
      const safeKey = typeof CSS!=='undefined'&&CSS.escape ? CSS.escape(key) : String(key).replace(/\\/g,'\\\\').replace(/"/g,'\\"');
      const row = grid.querySelector(`.sutra-row[data-key="${safeKey}"]`);
      if (!row) return false;
      const scrollTarget = row.closest('.sutra-row-wrap')||row;
      const max = Math.max(0, grid.scrollHeight-grid.clientHeight);
      let y = scrollTarget.offsetTop - (Number.isFinite(off)?off:0);
      y = Math.max(0, Math.min(y, max));
      grid.scrollTop = y;
      toggleBackTop(grid.scrollTop>0);
      return true;
    } catch(e) { return false; }
  }

  window.addEventListener('pagehide', saveScrollAnchorNow);
  document.addEventListener('visibilitychange', () => { if(document.visibilityState==='hidden') saveScrollAnchorNow(); });

  // ‚îÄ‚îÄ Back to top ‚îÄ‚îÄ
  let suppressBackTop = false;
  function toggleBackTop(show) { if (!btnBackTop) return; btnBackTop.classList.toggle('visible', show); }
  if (grid) grid.addEventListener('scroll', throttle(() => {
    if (!suppressBackTop) toggleBackTop(grid.scrollTop > 0);
    saveScrollAnchorNow();
  }, 120));
  if (btnBackTop && grid) btnBackTop.onclick = () => {
    suppressBackTop = true;
    toggleBackTop(false);
    grid.scrollTo({top:0,behavior:'smooth'});
    // D√πng scrollend n·∫øu c√≥, fallback rAF polling
    const done = () => {
      suppressBackTop = false;
      toggleBackTop(false);
      if (currentSutraId) {
        try { localStorage.removeItem(KEY_ANCHOR_K(currentSutraId)); localStorage.removeItem(KEY_ANCHOR_O(currentSutraId)); } catch(e){}
      }
    };
    if ('onscrollend' in grid) {
      grid.addEventListener('scrollend', done, {once:true});
    } else {
      let prev = -1;
      const poll = () => {
        const st = grid.scrollTop;
        if (st === 0 && st === prev) { done(); return; }
        prev = st;
        requestAnimationFrame(poll);
      };
      requestAnimationFrame(poll);
    }
  };

  // ‚îÄ‚îÄ Menu ‚îÄ‚îÄ
  function buildSuttaLinkHtml(s) {
    const codePrefix = s.code ? s.code+' ‚Äì ' : '';
    const viLabel=s.titleVi||'', enLabel=s.titleEn||'', paliLabel=s.titlePali||'';
    let mainText, subText;
    if (uiLang==='en') { mainText=codePrefix+(enLabel||viLabel||paliLabel||s.id); subText=paliLabel||viLabel||''; }
    else { mainText=codePrefix+(viLabel||enLabel||paliLabel||s.id); subText=paliLabel||enLabel||''; }
    FLAT_SUTTAS.push({ id:s.id, main:mainText, sub:subText, flat:`${mainText} ${viLabel} ${enLabel} ${paliLabel}`.toLowerCase() });
    return `<a href="#" class="menu-sutta-link" role="treeitem" data-id="${escapeAttr(s.id)}" aria-label="${escapeAttr(mainText)}">
        <div class="sutra-label">
          <div class="sutra-label-main">${escapeHtml(mainText)}</div>
          ${subText?`<div class="sutra-label-sub">${escapeHtml(subText)}</div>`:''}
        </div></a>`;
  }

  function buildMenuChildren(children, parentId) {
    if (!children||!children.length) return '';
    let html='';
    children.forEach((child) => {
      if (child.type==='group') {
        const grpId=safeDomId(parentId+'-'+child.key);
        const label=uiLang==='en' ? child.labelEn||child.labelVi||child.key : child.labelVi||child.labelEn||child.key;
        html+=`<div class="menu-subblock" role="group">
            <button class="menu-toggle nested" type="button" data-target="${escapeAttr(grpId)}"
                    aria-expanded="false" aria-controls="${escapeAttr(grpId)}">
              <span>${escapeHtml(label)}</span><span class="chevron" aria-hidden="true">‚ñ∏</span>
            </button>
            <div id="${escapeAttr(grpId)}" class="menu-list collapsed">${buildMenuChildren(child.children||[],grpId)}</div>
          </div>`;
      } else if (child.type==='sutta') { html+=buildSuttaLinkHtml(child); }
    });
    return html;
  }

  function buildSutraMenuFromIndex() {
    const index = window.SUTRA_INDEX||[];
    FLAT_SUTTAS=[];
    if (!Array.isArray(index)||!index.length) { sutraMenuList&&(sutraMenuList.innerHTML='<li>Ch∆∞a c√≥ m·ª•c l·ª•c.</li>'); return; }
    let html='';
    index.forEach((sec) => {
      const secId=safeDomId('sec-'+sec.key);
      const label=uiLang==='en' ? sec.labelEn||sec.labelVi||sec.key : sec.labelVi||sec.labelEn||sec.key;
      html+=`<li class="menu-block" role="treeitem" aria-expanded="false">
        <button class="menu-toggle" type="button" data-target="${escapeAttr(secId)}" aria-expanded="false" aria-controls="${escapeAttr(secId)}">
          <span>${escapeHtml(label)}</span><span class="chevron" aria-hidden="true">‚ñ∏</span>
        </button>
        <div id="${escapeAttr(secId)}" class="menu-list collapsed" role="group">
          <div class="menu-nikaya-sticky" data-label="${escapeAttr(label)}" aria-hidden="true">${escapeHtml(label)}</div>
          ${buildMenuChildren(sec.children||[],secId)}
        </div></li>`;
    });
    if (!sutraMenuList) return;
    sutraMenuList.innerHTML=html;
    SUTRA_ORDER=Array.from(sutraMenuList.querySelectorAll('.menu-sutta-link')).map((a)=>a.getAttribute('data-id'));
    highlightActiveInMenu();
    
  }

 

  function highlightActiveInMenu() {
    if (!sutraMenuList) return;
    sutraMenuList.querySelectorAll('.menu-sutta-link').forEach((a)=>{
      const isActive=a.getAttribute('data-id')===currentSutraId;
      a.classList.toggle('active',isActive);
      a.setAttribute('aria-current',isActive?'page':'false');
    });
  }

  function renderSearchResults(matches,q) {
    if (!searchResultsEl) return;
    if (!q) { searchResultsEl.innerHTML=''; return; }
    if (!matches.length) {
      const msg=uiLang==='en'?'No matching sutta found.':'Kh√¥ng t√¨m th·∫•y kinh ph√π h·ª£p.';
      searchResultsEl.innerHTML=`<div class="search-result-empty" role="status">${escapeHtml(msg)}</div>`;
      return;
    }
    const html=matches.map((m)=>`<button class="search-result-item" data-id="${escapeAttr(m.id)}" role="option">
        <span class="search-main">${escapeHtml(m.main)}</span>
        ${m.sub?`<span class="search-sub">${escapeHtml(m.sub)}</span>`:''}</button>`).join('');
    searchResultsEl.innerHTML=html;
  }

  function applySearch(query) {
    const q=(query||'').trim().toLowerCase();
    if (!q) return renderSearchResults([],'');
    const matches=FLAT_SUTTAS.filter((x)=>x.flat.includes(q)).slice(0,80);
    renderSearchResults(matches,query);
  }

  if (searchInput) searchInput.addEventListener('input', debounce((e)=>applySearch(e.target.value),180));

  // ‚îÄ‚îÄ Event delegation ‚îÄ‚îÄ
 function initDelegations() {
  if (sutraMenuList && !sutraMenuList._del) {
    sutraMenuList.addEventListener('click', ev => {
      const btn = ev.target.closest('.menu-toggle');
      if (btn && sutraMenuList.contains(btn)) {
        ev.preventDefault();
        const panel = document.getElementById(btn.dataset.target);
        if (!panel) return;

        const wasCollapsed = panel.classList.contains('collapsed');
        const isNested = btn.classList.contains('nested');

        // collapse siblings if opening
        if (wasCollapsed) {
          const scope = isNested ? btn.closest('.menu-list') : sutraMenuList;
          const sel = isNested ? '.menu-toggle.nested' : '.menu-toggle:not(.nested)';
          if (scope) scope.querySelectorAll(sel).forEach(o => {
            if (o === btn) return;
            const op = document.getElementById(o.dataset.target);
            if (op && !op.classList.contains('collapsed')) {
              op.classList.add('collapsed');
              o.setAttribute('aria-expanded', 'false');
              const c = o.querySelector('.chevron'); if (c) c.textContent = '‚ñ∏';

              if (!isNested) op.querySelectorAll('.menu-toggle.nested').forEach(nb => {
                const np = document.getElementById(nb.dataset.target);
                if (np && !np.classList.contains('collapsed')) np.classList.add('collapsed');
                nb.setAttribute('aria-expanded', 'false');
                const c2 = nb.querySelector('.chevron'); if (c2) c2.textContent = '‚ñ∏';
              });
            }
          });
        }

        panel.classList.toggle('collapsed', !wasCollapsed);

        /* ‚úÖ aria-expanded set by current state (after toggle) */
        const isCollapsedNow = panel.classList.contains('collapsed');
        btn.setAttribute('aria-expanded', isCollapsedNow ? 'false' : 'true');

        const ch = btn.querySelector('.chevron');
        if (ch) ch.textContent = isCollapsedNow ? '‚ñ∏' : '‚ñæ';
        return;
      }

      const a = ev.target.closest('.menu-sutta-link');
      if (a && sutraMenuList.contains(a)) {
        ev.preventDefault();
        const id = a.getAttribute('data-id');
        if (id) {
          openSutra(id);
          closeSidebar();
          if (searchInput) searchInput.value='';
          if (searchResultsEl) searchResultsEl.innerHTML='';
        }
      }
    });
    sutraMenuList._del = true;
  }

  if (searchResultsEl && !searchResultsEl._del) {
    searchResultsEl.addEventListener('click', ev => {
      const btn = ev.target.closest('.search-result-item');
      if (btn) {
        const id = btn.getAttribute('data-id');
        if (id) {
          openSutra(id);
          closeSidebar();
          if (searchInput) searchInput.value='';
          searchResultsEl.innerHTML='';
        }
      }
    });
    searchResultsEl._del = true;
  }
}

  // ‚îÄ‚îÄ Meta lookup ‚îÄ‚îÄ
  function findMetaById(id) {
    const index=window.SUTRA_INDEX||[]; let found=null;
    function walk(children) {
      if (!children?.length||found) return;
      for (const ch of children) {
        if (found) return;
        if (ch.type==='sutta'&&ch.id===id) { found=ch; return; }
        if (ch.type==='group') walk(ch.children||[]);
      }
    }
    for (const sec of index) { walk(sec.children||[]); if(found) break; }
    return found;
  }

  // ‚îÄ‚îÄ createRow ‚îÄ‚îÄ
  function getColHeaders() {
    return uiLang==='en' ? {pali:'Pali',eng:'English',vie:'Vietnamese'} : {pali:'Pali',eng:'English',vie:'Ti·∫øng Vi·ªát'};
  }

  function createRow(r) {
    const wrap=document.createElement('div'); wrap.className='sutra-row-wrap';
    const keyRaw=String(r.key||'');
    let keyShort='';
    if (keyRaw.includes(':')) {
      const [prefixPart,segPart]=keyRaw.split(':');
      const prefix=prefixPart.replace(/([a-zA-Z]+)(\d*)/,(_,letters,nums)=>letters.toUpperCase()+nums);
      keyShort=segPart?prefix+'.'+segPart:prefix;
    } else { keyShort=keyRaw.toUpperCase(); }
    if (keyShort) {
      const seg=document.createElement('div'); seg.className='sutra-seg-key'; seg.textContent=keyShort; seg.setAttribute('aria-hidden','true'); wrap.appendChild(seg);
    }
    const row=document.createElement('div'); row.className='sutra-row'; row.setAttribute('data-key',keyRaw);
    const headers=getColHeaders();
    function makeCol(className,headerText,contentText,contentClass) {
      const col=document.createElement('div'); col.className='sutra-col '+className;
      const hdr=document.createElement('div'); hdr.className='sutra-col-header'; hdr.textContent=headerText; hdr.setAttribute('aria-hidden','true');
      const body=document.createElement('div'); body.className='sutra-col-body';
      const inner=document.createElement('div'); inner.className=contentClass; inner.textContent=contentText||'';
      body.appendChild(inner); col.appendChild(hdr); col.appendChild(body); return col;
    }
    row.appendChild(makeCol('pali-col',headers.pali,r.pali,'pali'));
    row.appendChild(makeCol('eng-col', headers.eng, r.eng, 'eng'));
    row.appendChild(makeCol('vie-col', headers.vie, r.vie, 'vie'));
    wrap.appendChild(row); return wrap;
  }

  function getByExactOrSuffix(map,exactKey,suffix) {
    if (!map) return '';
    if (exactKey&&map[exactKey]) return map[exactKey];
    const keys=Object.keys(map);
    let k=exactKey?keys.find((x)=>x===exactKey):null;
    if (!k&&suffix) k=keys.find((x)=>String(x).endsWith(suffix));
    return k?map[k]||'':'';
  }

  function pickTextForUiLangSuffix(merged,id,suffix) {
    const exactKey=id+suffix;
    if (uiLang==='en') return getByExactOrSuffix(merged.engMap,exactKey,suffix)||getByExactOrSuffix(merged.vieMap,exactKey,suffix)||getByExactOrSuffix(merged.paliMap,exactKey,suffix)||'';
    return getByExactOrSuffix(merged.vieMap,exactKey,suffix)||getByExactOrSuffix(merged.engMap,exactKey,suffix)||getByExactOrSuffix(merged.paliMap,exactKey,suffix)||'';
  }

  function renderWelcomeScreen() {
    if (!grid||currentSutraId) return;
    if (uiLang==='en') {
      titleEl&&(titleEl.textContent='Sutta reading collection');
      subtitleEl&&(subtitleEl.textContent='Tap üìñ to select a sutta, or ‚ùì for the guide.');
      grid.innerHTML=`<div class="welcome-screen"><div class="welcome-box"><strong>Welcome!</strong><br><br>‚Ä¢ Tap üìñ <strong>Sutta Index</strong> to choose a sutta.<br>‚Ä¢ Tap ‚öô <strong>Settings</strong> to adjust layout/TTS.<br>‚Ä¢ Tap ‚ùì <strong>Guide</strong> for help.</div></div>`;
    } else {
      titleEl&&(titleEl.textContent='Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi trang l∆∞u tr·ªØ kinh');
      subtitleEl&&(subtitleEl.textContent='B·∫•m üìñ ƒë·ªÉ ch·ªçn b√†i kinh, ho·∫∑c ‚ùì ƒë·ªÉ xem h∆∞·ªõng d·∫´n.');
      grid.innerHTML=`<div class="welcome-screen"><div class="welcome-box"><strong>Xin ch√†o!</strong><br><br>‚Ä¢ B·∫•m üìñ <strong>Danh m·ª•c b√†i kinh</strong> ƒë·ªÉ ch·ªçn b√†i.<br>‚Ä¢ B·∫•m ‚öô <strong>C√†i ƒë·∫∑t</strong> ƒë·ªÉ ch·ªânh b·ªë c·ª•c/TTS.<br>‚Ä¢ B·∫•m ‚ùì <strong>H∆∞·ªõng d·∫´n</strong> ƒë·ªÉ xem c√°ch d√πng.</div></div>`;
    }
  }

  // ‚îÄ‚îÄ renderSutra ‚îÄ‚îÄ
  async function renderSutra(id) {
    if (!id||!grid) return;
    saveScrollAnchorNow(); resetTts(true,false);
    const token=++renderToken; isRendering=true; grid.setAttribute('aria-busy','true');
	  // ‚úÖ SET currentSutraId S·ªöM ƒë·ªÉ Prev/Next t√≠nh ƒë√∫ng ngay c·∫£ khi ƒëang load
  currentSutraId = id;
  try { localStorage.setItem(KEY_LAST, id); } catch(e){}
  highlightActiveInMenu();
  updateNavButtons();

    if (btnReadTts) btnReadTts.disabled=true; if (btnPauseTts) btnPauseTts.disabled=true; if (btnStopTts) btnStopTts.disabled=true;
    highlightActiveInMenu();
    let merged=null;
    try { merged=await loadMerged(id); } catch(e) { merged=null; }
    if (token!==renderToken) return;
  
    if (!merged?.rows?.length) {
      titleEl&&(titleEl.textContent=uiLang==='en'?'Sutta data not found':'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i kinh');
      subtitleEl&&(subtitleEl.textContent=(uiLang==='en'?'ID: ':'M√£ b√†i: ')+id);
      grid.innerHTML=''; isRendering=false; grid.setAttribute('aria-busy','false'); setTtsUiState('idle'); return;
    }
    const titleFromBilara=(pickTextForUiLangSuffix(merged,id,':0.2')||'').trim();
    const subtitleFromBilara=(pickTextForUiLangSuffix(merged,id,':0.1')||'').trim();
    const meta=findMetaById(id)||{};
    const titleFallback=uiLang==='en'?meta.titleEn||meta.titleVi||meta.titlePali||meta.title||id:meta.titleVi||meta.titleEn||meta.titlePali||meta.title||id;
    const subtitleFallback=uiLang==='en'?meta.subtitleEn||meta.subtitleVi||meta.subtitle||'':meta.subtitleVi||meta.subtitleEn||meta.subtitle||'';
    titleEl&&(titleEl.textContent=titleFromBilara||titleFallback);
    subtitleEl&&(subtitleEl.textContent=subtitleFromBilara||subtitleFallback);
    const rowsForViewRaw=(merged.rows||[]).filter((r)=>!String(r.key||'').includes(':0.'));
    const singleLang=getSingleVisibleLang(); lastSingleLangMode=singleLang;
    const rowsForView=singleLang?mergeRowsToParagraphRows(rowsForViewRaw,singleLang):rowsForViewRaw;
    grid.innerHTML=''; cachedRows=[]; applyVisibility();
    let i=0; const BATCH=220;
    function renderBatch() {
      if (token!==renderToken) return;
      const frag=document.createDocumentFragment();
      const end=Math.min(i+BATCH,rowsForView.length);
      for(;i<end;i++){
        const wrap=createRow(rowsForView[i]); frag.appendChild(wrap);
        const innerRow=wrap.querySelector?wrap.querySelector('.sutra-row'):wrap;
        cachedRows.push(innerRow||wrap);
      }
      grid.appendChild(frag);
      if (i<rowsForView.length) { requestAnimationFrame(renderBatch); }
      else {
        isRendering=false; grid.setAttribute('aria-busy','false');
        requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ updateVisibleCols(); restoreScrollByAnchor(id); setupAnchorObserver(); setTtsUiState('idle'); updateNavButtons(); }); });
        scheduleNextPreload(id);
      }
    }
    renderBatch();
  }

  function scheduleNextPreload(currentId) {
    try {
      const idx=SUTRA_ORDER.indexOf(currentId); if(idx===-1) return;
      const nextId=SUTRA_ORDER[idx+1]; if(!nextId) return;
      const conn=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
      if (conn?.saveData) return;
      if (navigator.deviceMemory&&navigator.deviceMemory<2) return;
      const doPreload=()=>loadMerged(nextId).catch(()=>{});
      if ('requestIdleCallback' in window) requestIdleCallback(doPreload,{timeout:2000}); else setTimeout(doPreload,800);
    } catch(e){}
  }

  function openSutra(id) { renderSutra(id); }

  // ‚îÄ‚îÄ Prev / Next ‚îÄ‚îÄ
  const btnPrev=  $('btnPrev');
  const btnNext=  $('btnNext');

  function getNavLabel(id) {
    if (!id) return '‚Äî';
    const meta=findMetaById(id); if (!meta) return id;
    const code=meta.code?meta.code+' ':'';
    if (uiLang==='en') return code+(meta.titleEn||meta.titleVi||meta.titlePali||id);
    return code+(meta.titleVi||meta.titleEn||meta.titlePali||id);
  }

  function updateNavButtons() {
     const idx = SUTRA_ORDER.indexOf(currentSutraId);

  // N·∫øu ch∆∞a c√≥ current ho·∫∑c ch∆∞a c√≥ order ‚Üí disable h·∫øt (tr√°nh tr·∫°ng th√°i sai)
  if (!currentSutraId || !Array.isArray(SUTRA_ORDER) || !SUTRA_ORDER.length || idx === -1) {
    if (btnPrev) btnPrev.disabled = true;
    if (btnNext) btnNext.disabled = true;
    return;
  }

  if (btnPrev) btnPrev.disabled = !(idx > 0);
  if (btnNext) btnNext.disabled = !(idx < SUTRA_ORDER.length - 1);
  }

  if (btnPrev) btnPrev.addEventListener('click',()=>{ const idx=SUTRA_ORDER.indexOf(currentSutraId); if(idx>0) openSutra(SUTRA_ORDER[idx-1]); });
  if (btnNext) btnNext.addEventListener('click',()=>{ const idx=SUTRA_ORDER.indexOf(currentSutraId); if(idx!==-1&&idx<SUTRA_ORDER.length-1) openSutra(SUTRA_ORDER[idx+1]); });
/*
  if (grid) {
    let sx=0,sy=0;
    grid.addEventListener('touchstart',(e)=>{ if(e.touches.length){sx=e.touches[0].clientX;sy=e.touches[0].clientY;} },{passive:true});
    grid.addEventListener('touchend',(e)=>{
      if (!e.changedTouches.length) return;
      const ex=e.changedTouches[0].clientX,ey=e.changedTouches[0].clientY;
      const dx=ex-sx,dy=ey-sy;
      if (Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>=80&&Math.abs(dy)<=25) {
        const idx=SUTRA_ORDER.indexOf(currentSutraId); if(idx===-1) return;
        if (dx<0&&idx<SUTRA_ORDER.length-1) openSutra(SUTRA_ORDER[idx+1]);
        if (dx>0&&idx>0) openSutra(SUTRA_ORDER[idx-1]);
      }
    },{passive:true});
  }
  */

  // ‚îÄ‚îÄ TTS ‚îÄ‚îÄ
  const synthSupported='speechSynthesis' in window;
  const synth=synthSupported?window.speechSynthesis:null;
  let cachedVoices=[];
  if (synthSupported) {
    try{cachedVoices=synth.getVoices()||[];}catch(e){}
    synth.addEventListener('voiceschanged',()=>{try{cachedVoices=synth.getVoices()||[];}catch(e){}});
  }

  function ensureVoicesLoaded(timeout=1200) {
    return new Promise((resolve)=>{
      if (!synth) return resolve([]);
      try{const v=synth.getVoices();if(v?.length){cachedVoices=v;return resolve(v);}}catch(e){}
      const onChange=()=>{try{const v2=synth.getVoices();if(v2?.length){synth.removeEventListener('voiceschanged',onChange);cachedVoices=v2;resolve(v2);}}catch(e){}};
      synth.addEventListener('voiceschanged',onChange);
      setTimeout(()=>{try{synth.removeEventListener('voiceschanged',onChange);}catch(e){}try{cachedVoices=synth.getVoices()||[];}catch(e){}resolve(cachedVoices);},timeout);
    });
  }

  const ttsState={activeLang:null,index:0,isPlaying:false,isPaused:false,currentUtter:null};

  function setTtsUiState(state) {
    if (!btnReadTts||!btnPauseTts||!btnStopTts) return;
    if (!synthSupported||isRendering) { btnReadTts.disabled=btnPauseTts.disabled=btnStopTts.disabled=true; return; }
    if (state==='idle') { btnReadTts.disabled=false;btnPauseTts.disabled=true;btnStopTts.disabled=true; }
    else if (state==='playing') { btnReadTts.disabled=true;btnPauseTts.disabled=false;btnStopTts.disabled=false; }
    else if (state==='paused') { btnReadTts.disabled=false;btnPauseTts.disabled=true;btnStopTts.disabled=false; }
  }

  function clearRowHighlight() { cachedRows.forEach((r)=>r.classList.remove('reading')); }
  function highlightRowAt(index) {
    clearRowHighlight();
    if (index<0||index>=cachedRows.length) return;
    const row=cachedRows[index]; row.classList.add('reading');
    const top=row.offsetTop,bottom=top+row.offsetHeight,viewTop=grid.scrollTop,viewBottom=viewTop+grid.clientHeight;
    if (top<viewTop||bottom>viewBottom) grid.scrollTo({top:Math.max(0,top-20),behavior:'auto'});
  }

  function pickVoice(langPrefix) {
    const lp=(langPrefix||'').toLowerCase();
    const list=cachedVoices.filter((v)=>v.lang?.toLowerCase().startsWith(lp));
    return list.find((v)=>/google|microsoft/i.test(v.name||''))||list[0]||null;
  }

  function resetTts(clearHighlight,clearStorage) {
    if (synthSupported&&synth){try{synth.cancel();}catch(e){}}
    ttsState.isPlaying=ttsState.isPaused=false; ttsState.currentUtter=null; ttsState.index=0; ttsState.activeLang=null;
    if (clearHighlight) clearRowHighlight();
    if (clearStorage&&currentSutraId){try{localStorage.removeItem('tts_state_'+currentSutraId);}catch(e){}}
    setTtsUiState('idle');
  }

  function saveTtsState() {
    if (!currentSutraId||!ttsState.activeLang) return;
    try{localStorage.setItem('tts_state_'+currentSutraId,JSON.stringify({lang:ttsState.activeLang,index:ttsState.index}));}catch(e){}
  }

  function speakNextRow() {
    if (!synthSupported||!synth||!ttsState.activeLang) return;
    if (ttsState.index>=cachedRows.length) return resetTts(true,true);
    const row=cachedRows[ttsState.index];
    const el=ttsState.activeLang==='vi'?row.querySelector('.vie-col .vie'):row.querySelector('.eng-col .eng');
    const text=el?(el.textContent||'').trim():'';
    if (!text){ttsState.index++;return speakNextRow();}
    highlightRowAt(ttsState.index); saveTtsState();
    const utter=new SpeechSynthesisUtterance(text);
    if (ttsState.activeLang==='vi'){utter.lang='vi-VN';const v=pickVoice('vi');if(v)utter.voice=v;utter.rate=0.98;utter.pitch=0.95;}
    else{utter.lang='en-US';const v=pickVoice('en');if(v)utter.voice=v;}
    utter.onend=()=>{ttsState.currentUtter=null;if(!ttsState.activeLang||ttsState.isPaused||!ttsState.isPlaying)return;ttsState.index++;speakNextRow();};
    utter.onerror=()=>{ttsState.currentUtter=null;resetTts(true,false);};
    ttsState.currentUtter=utter; ttsState.isPlaying=true; ttsState.isPaused=false; setTtsUiState('playing');
    try{synth.speak(utter);}catch(e){resetTts(true,false);}
  }

  async function startTtsByUiLang() {
    if (isRendering){alert(uiLang==='en'?'Please wait for the text to finish loading.':'Vui l√≤ng ch·ªù t·∫£i xong n·ªôi dung r·ªìi h√£y b·∫•m ƒë·ªçc.');return;}
    if (!synthSupported){alert(uiLang==='en'?'Your browser does not support TTS.':'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc TTS.');return;}
    const targetLang=uiLang==='en'?'en':'vi';
    if (ttsState.activeLang===targetLang&&ttsState.isPlaying) return;
    if (ttsState.activeLang===targetLang&&ttsState.isPaused){ttsState.isPaused=false;ttsState.isPlaying=true;setTtsUiState('playing');speakNextRow();return;}
    resetTts(true,false); ttsState.activeLang=targetLang; await ensureVoicesLoaded();
    if (currentSutraId){try{const raw=localStorage.getItem('tts_state_'+currentSutraId);if(raw){const st=JSON.parse(raw);if(st?.lang===targetLang&&typeof st.index==='number')ttsState.index=st.index;}}catch(e){}}
    if (!Number.isInteger(ttsState.index)||ttsState.index<0) ttsState.index=0;
    speakNextRow();
  }
  function pauseTtsByUiLang(){if(!synthSupported||!synth)return;if(!ttsState.activeLang||!ttsState.isPlaying||!ttsState.currentUtter)return;ttsState.isPaused=true;ttsState.isPlaying=false;try{synth.cancel();}catch(e){}ttsState.currentUtter=null;saveTtsState();clearRowHighlight();setTtsUiState('paused');}
  function stopTtsByUiLang(){if(!synthSupported||!synth)return;resetTts(true,true);}

  if (btnReadTts)  btnReadTts.onclick  = startTtsByUiLang;
  if (btnPauseTts) btnPauseTts.onclick = pauseTtsByUiLang;
  if (btnStopTts)  btnStopTts.onclick  = stopTtsByUiLang;

  // ‚îÄ‚îÄ UI Lang switch ‚îÄ‚îÄ
  function initUiLang() {
    renderUiLangFlag(); applyUiLanguageToSearchUi(); applyUiLanguageToSettingsPanel(); renderGuideDialog();
    if (!btnUiLang) return;
    btnUiLang.addEventListener('click',()=>{
      uiLang=uiLang==='vi'?'en':'vi';
      localStorage.setItem(LANG_STORAGE_KEY,uiLang); window.SUTRA_UI_LANG=uiLang;
      renderUiLangFlag(); applyUiLanguageToSearchUi(); applyUiLanguageToSettingsPanel(); renderGuideDialog();
      buildSutraMenuFromIndex(); highlightActiveInMenu(); updateNavButtons();
      if (currentSutraId) renderSutra(currentSutraId); else renderWelcomeScreen();
    });
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  function init() {
    if (!grid||!titleEl||!subtitleEl||!card) console.warn('Sutta app: core DOM missing.');
    initUiLang(); loadViewPrefs();
    if (btnPali){btnPali.classList.toggle('active',showPali);btnPali.setAttribute('aria-pressed',String(showPali));}
    if (btnEng){btnEng.classList.toggle('active',showEng);btnEng.setAttribute('aria-pressed',String(showEng));}
    if (btnVie){btnVie.classList.toggle('active',showVie);btnVie.setAttribute('aria-pressed',String(showVie));}
    if (btnLayout){btnLayout.classList.toggle('active',!!card?.classList.contains('stack'));}
    applyVisibility(); loadZoom(); loadLineHeight(); buildSutraMenuFromIndex(); initDelegations();
    let startId=null; try{startId=localStorage.getItem(KEY_LAST);}catch(e){}
    if (startId) openSutra(startId); else renderWelcomeScreen();
    if (!synthSupported){[btnReadTts,btnPauseTts,btnStopTts].forEach((b)=>b&&(b.disabled=true));}else{setTtsUiState('idle');}
  }

  init();
})();
</script>
</body>
</html>
